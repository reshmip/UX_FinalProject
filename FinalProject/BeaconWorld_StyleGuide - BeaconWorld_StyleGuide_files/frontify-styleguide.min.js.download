!function(a){Tc.Module.Duplicate=Tc.Module.extend({on:function(a){this.$ctx;this.sandbox.subscribe("events",this),a()},onCopyBlockByReference:function(b){b.position;$block=a("body").find('.mod.block[data-block="'+b.block+'"]');var c=(a("body").data("document"),b.position.closest(".page").data("id")),d=b.position.closest(".add-block"),e=b.position.closest("section"),f=0;e&&e.data("id")>0?(f=e.data("id"),d.data("scope","section")):d.data("scope","page");var g={block_type:"reference",reference:b.block,scope:d.data("scope"),position:d.data("position"),block:d.prev().data("block")};a.ajax({url:"/api/document/block/"+c+"/"+f,data:JSON.stringify(g),contentType:"application/json; charset=utf-8",type:"POST",success:function(c){if(c.success){if($block.length>0){var d=$block.clone();d.addClass("referenced"),d.attr("data-block",c.block.id).attr("data-reference-hash",c.block.reference_hash),b.position.parent().after(d)}else d=a('<div class="msg msg-info block"><i class="icon-info"></i>&nbsp;&nbsp;The referenced block will become visible after the next reload</div>'),d.attr("data-block",c.block.id),b.position.parent().after(d);var e=$block.closest(".page").find(".add-block:first");d.after(e.clone())}}})}})}(Tc.$),function(a){Tc.Module.Progress=Tc.Module.extend({on:function(a){var b=this.$ctx;this.sandbox.subscribe("events",this),this.id=b.data("a-progress-id")||0,this.$progress=b.find(".js-a-progress__progress"),this.$text=b.find(".js-a-progress__text"),a()},onProgress:function(a){var b=a.id||0,c=a.progress;b==this.id&&(this.$text.text(c+"%"),this.$progress.css({"stroke-dasharray":c+" 100"})),c>99&&this.$progress.velocity({stroke:"#A3CE62"},{loop:!0})},onProgressReset:function(a){var b=a.id||0;b==this.id&&this.$progress.velocity("stop").css({stroke:"#4D92DF"})}})}(Tc.$),function(a){Tc.Module.Attachments=Tc.Module.extend({on:function(b){var c=this.$ctx;this.tpl=this.sandbox.getConfigParam("tpl"),this.data=this.sandbox.getConfigParam("data"),this.$block=c.closest(".block"),this.$count=c.find(".js-m-attachments__count"),this.editable=c.data("editable");new Tc.Module.BtnDropdown(c.find(".js-m-attachments__dropdown"),this.sandbox,this.id,!0);this.$block.hasClass("block")&&this.$block.hasClass("referenced")&&c.addClass("referenced"),a(".btn-toggle-editing").on("click",function(){a(".mod-document").hasClass("editor-enabled")&&!c.hasClass("referenced")&&this.editable&&a('[data-editable="true"]',c).attr("contenteditable",!0)}.bind(this)),this.updateAttachments(),this.bindAttachmentUpload(),this.bindAttachmentReplace(),this.bindInlineEditing();var d=c.find(".js-m-attachments__list");a.each(d,function(a,b){this.enableSorting(b)}.bind(this)),c.on("click",".js-m-attachments__settings-btn",function(b){var d=a(b.currentTarget),e=d.closest(".js-m-attachments__settings-wrap");return e.hasClass("state-open")?e.removeClass("state-open"):(c.find(".js-m-attachments__settings-wrap").removeClass("state-open"),e.addClass("state-open")),!1}.bind(this)),c.on("click",".js-m-attachments__delete",function(b){var d=a(b.currentTarget);return swal({title:"Are you sure?",text:"You are about to delete this download item",type:"warning",showCancelButton:!0,confirmButtonColor:"#C93B3E",confirmButtonText:"Yes, delete it!",closeOnConfirm:!0},function(){var a=d.closest(".js-m-attachments__item");this.data.get("/api/attachment/remove/"+a.attr("data-id")).then(function(a){a.success&&a.data.filesize&&this.data.updateStorageUsage(1024*-a.data.filesize)}.bind(this)),a.remove();var b=c.find(".js-m-attachments__item").length;this.$count.text(b),0===b&&c.find(".js-m-attachments__dropdown").removeClass("state-visible")}.bind(this)),!1}.bind(this)),c.on("click",".js-m-attachments__replace",function(b){var d=a(b.currentTarget),e=c.find(".js-m-attachments__replace-form"),f=d.closest(".js-m-attachments__item");e.find(".js-m-attachments__replace-id").val(f.attr("data-id")),e.find(".js-m-attachments__replace-input").trigger("click")}.bind(this)),b()},updateAttachments:function(){var b=this.$ctx,c=this.$block,d=c.data("block"),e=c.data("attachments");e&&this.data.get("/api/attachment/list/"+d).then(function(c){if(c.success){var d=c.attachments.length;this.$count.text(d),d>0&&b.find(".js-m-attachments__dropdown").addClass("state-visible"),a.each(c.attachments,function(c,d){d.editable=this.editable;var e=a(this.tpl.render("attachments-item",d));a(".js-m-attachments__list",b).append(e)}.bind(this))}}.bind(this))},bindAttachmentUpload:function(){var b=this.$ctx;a("body").data("hub");b.find(".js-m-attachments__files").fileupload({dataType:"json",dropZone:b.find(".js-m-attachments__dropzone"),add:function(a,b){this.data.checkStorageLimit(b.files[0].size).then(function(){b.submit()})}.bind(this),done:function(c,d){if(d.result&&d.result[0]){this.data.updateStorageUsage(d.result[0].size);var e=d.result[0],f=this.$block;a(".js-m-attachments__list",b).append(a(this.tpl.render("attachments-item",e)));var g=b.find(".js-m-attachments__item").length;if(this.$count.text(g),a('[data-editable="true"]',b).attr("contenteditable",!0),b.find(".js-m-attachments__dropdown").addClass("state-visible"),!f.data("attachments")){var h={settings:{attachments:!0}};this.data.updateBlock(f,h)}f.data("attachments",!0)}}.bind(this)})},enableSorting:function(b){this.sortable=Sortable.create(b,{group:"attachment",ghostClass:"sortable-ghost",handle:".js-m-attachments__drag-handle",forceFallback:!0,onUpdate:function(b){if(b.oldIndex!==b.newIndex){if(!a("body").hasClass("editor-enabled"))return!1;this.data.post("/api/attachment/update/"+a(b.item).data("id"),{sort:b.newIndex+1})}}.bind(this)})},bindAttachmentReplace:function(){var b=this.$ctx,c=this;a("body").data("hub");b.find(".js-m-attachments__replace-input").fileupload({dataType:"json",add:function(b,d){if(d.form){var e=a(d.form.context),f=e.find(".js-m-attachments__replace-id").val();if("undefined"==typeof f||0==f)return!1;d.assetId=f,c.data.checkStorageLimit(d.files[0].size).then(function(){d.submit()})}}.bind(this),done:function(d,e){if(e.result&&e.result[0]){var f={doReplace:!0,oldId:e.assetId};c.data.post("/api/attachment/update/"+e.result[0].id,f).then(function(a){c.data.updateStorageUsage(!0)});var g=a(c.tpl.render("attachments-item",e.result[0])),h=b.find('.js-m-attachments__item[data-id="'+e.assetId+'"]');h.after(g),h.remove(),a('[data-editable="true"]',b).attr("contenteditable",!0)}}})},bindInlineEditing:function(){var b=this.$ctx;a(".mod-document").data("editor")&&(b.on("click",".js-m-attachments__link",function(c){return a(".mod-document").hasClass("editor-enabled")&&!b.hasClass("referenced")?(c.stopPropagation(),!1):void 0}.bind(this)),b.on("blur",'.js-m-attachments__title[data-editable="true"]',function(b){var c=a(b.currentTarget),d=c.closest(".js-m-attachments__item").data("id"),e={title:c.text()};return this.data.post("/api/attachment/update/"+d,e),!1}.bind(this)),b.on("keydown","[contenteditable]",function(b){if(13===b.keyCode){var c=a(b.currentTarget);return c.trigger("blur"),window.getSelection().removeAllRanges(),!1}}.bind(this)))}})}(Tc.$),function(a){Tc.Module.BtnDropdown=Tc.Module.extend({init:function(a,b,c,d){this._super(a,b,c),d&&this.on()},on:function(b){var c=this.$ctx;this.isAnimating=!1,this.$toggle=c.find(".js-m-btn-dropdown__toggle"),this.$menu=c.find(".js-m-btn-dropdown__menu"),this.$items=c.find(".js-m-btn-dropdown__item"),this.$toggle.on("click",function(){this.toggle()}.bind(this)),a.isFunction(b)&&b()},toggle:function(){this.$toggle.hasClass("state-open")?this.close():this.open()},open:function(){this.isAnimating||(this.isAnimating=!0,this.$toggle.addClass("state-open"),this.$menu.velocity("slideDown",{duration:200,easing:"swing",complete:function(){this.isAnimating=!1}.bind(this)}))},close:function(){this.isAnimating||(this.isAnimating=!0,this.$toggle.removeClass("state-open").trigger("focus"),this.$menu.velocity("slideUp",{duration:1,easing:"swing",complete:function(){this.isAnimating=!1}.bind(this)}))}})}(Tc.$),function(a){Tc.Module.BtnTop=Tc.Module.extend({on:function(b){var c=this.$ctx,d=300,e=1200,f=700;a(window).scroll(function(b){var f=a(b.currentTarget);f.scrollTop()>d?c.addClass("state-visible"):c.removeClass("state-visible state-fade"),f.scrollTop()>e&&c.addClass("state-fade")}),c.on("click",function(b){b.preventDefault(),a("#top").velocity("scroll",{duration:f,offset:0,easing:"easeOutCubic"})}),b()}})}(Tc.$),function(a){Tc.Module.Navsidebar=Tc.Module.extend({on:function(b){this.$ctx;this.tpl=this.sandbox.getConfigParam("tpl"),this.data=this.sandbox.getConfigParam("data"),this.translation_language=a(".mod-document").data("translation-language"),this.translation_language&&this.loadTranslationStatus(),b()},loadTranslationStatus:function(){var b=this.$ctx,c=a(".mod-document").data("document");this.data.get("/api/document/translations/"+c+"/"+this.translation_language).then(function(c){c.success&&a.each(c.pages,function(a,c){b.find('.item[data-page="'+a+'"] .translation-status').addClass("translation-status-"+c.status.toLowerCase()),c.dirty&&b.find('.item[data-page="'+a+'"] .translation-status').addClass("translation-status-dirty"),b.find('.item[data-page="'+a+'"] .translation-status .progress').css("width",c.status_progress.percentage_complete+"%")})}.bind(this))}})}(Tc.$),function(a){Tc.Module.Pagemove=Tc.Module.extend({on:function(b){var c=this,d=this.$ctx;this.sandbox.subscribe("events",this),a(".fld-document-select",d).dropdown(),d.on("click",".btn-cancel",function(){c.fire("closeModal",{id:"pagemove"})}),d.on("click",".btn-move",function(){var b=a(this).closest(".m-pagemove__destination").find(".fld-document-select").val(),d=a(".page").data("id"),e={page:d,document:b};c.movePage(e,function(){c.fire("closeModal"),swal({allowOutsideClick:!0,title:"Move done",text:"The page has been moved!",type:"success",confirmButtonText:"Ok"},function(){location.href="/document/"+b})})}),b()},after:function(a){},movePage:function(b,c){var d=a(".mod-document").data("document");a.ajax({url:"/api/document/page/"+d,type:"PATCH",data:JSON.stringify(b),success:function(a){a.success&&c()}})}})}(Tc.$),function(a){Tc.Module.Appearance=Tc.Module.extend({on:function(b){this.sandbox.subscribe("events",this),this.data=this.sandbox.getConfigParam("data"),this.tpl=this.sandbox.getConfigParam("tpl");var c=this.$ctx;this.key=c.data("view"),this.appearanceSettings=null,this.hub=a("body").data("hub"),this.document=a("body").data("document"),c.on("click",".js-o-appearance__size",function(b){var c=a(b.currentTarget);this.updateHeadersize(c.data("size"))}.bind(this)),this.load(),b()},load:function(){null==this.appearanceSettings?this.data.get("/api/hub/settings/"+this.hub+"/"+this.document).then(function(a){a.success&&this.render(a.hub.appearance)}.bind(this)):this.render(this.appearanceSettings)},render:function(b){this.appearanceSettings=b,b.tpl=this.tpl,b.project=this.sandbox.getConfigParam("context").project.id,b.hub=this.hub;var c=a(".js-o-appearance__content",this.$ctx);c.html(this.tpl.render("appearance-"+this.key+"-settings",b)),this.$actions=this.$ctx.find(".js-o-appearance__actions"),this.bindSettings(c)},bindSettings:function(a){this.settings&&this.settings.destroy(),this.settings=new Tc.Module.CSettings(a,this.sandbox),"header"==this.key?this.bindHeaderSettings():"navigation"==this.key?this.bindNavigationSettings():"content"==this.key?this.bindContentSettings():"privacy"==this.key&&this.bindPrivacySettings()},bindHeaderSettings:function(){var b=this.$ctx,c=this.settings.getSetting("color");c.saved=function(c){a(".js-o-appearance__size-head",b).css("background",c.background_color),a(".js-o-header").css("background-color",c.background_color)}.bind(this);var d=this.settings.getSetting("background_url");d.saved=function(b){b.placeholder?a(".js-o-header").css("background-image","none"):a(".js-o-header").css("background-image","url("+b.background_url+")")};var e=this.settings.getSetting("document_background_url");e.saved=function(b){b.placeholder?a(".js-o-header").css("background-image","url("+a(".js-o-header").data("master-image")+")"):a(".js-o-header").css("background-image","url("+b.document_background_url+")")};var f=this.settings.getElem("document_background_enabled");f.changed=function(c){var d=a(".js-o-appearance__bg-override-wrapper",b);c.document_background_enabled?d.removeClass("state-hidden").addClass("state-visible"):this.data.post("/api/document/settings/"+this.document,{document_background_url:null}).then(function(b){if(b.success){d.removeClass("state-visible").addClass("state-hidden"),a(".js-o-header").css("background-image"," url("+a(".js-o-header").data("master-image")+")");var c=this.settings.getSetting("document_background_url");c.setValue(null)}}.bind(this))}.bind(this);var g=this.settings.getSetting("logo");g.saved=function(c){var d=a(".js-o-appearance__logo-dimension-wrapper",b);if("/img/empty@2x.png"!=c.logo){d.show();var e=parseInt(c.logo_width),f=parseInt(c.logo_height);a("#logo_dimensions_width",d).val(e),a("#logo_dimensions_height",d).val(f),a(".js-cm-setting-hotspot__value",d).text("Size: "+e+"x"+f+" | X: "+c.logo_x+" Y: "+c.logo_y),a(".ffy-logo").addClass("logo-available"),0==a(".ffy-logo .logo-image").length?a(".ffy-logo > a").append('<img class="logo-image js-o-header-logo" src="'+c.logo+'" alt="" />'):a(".js-o-header-logo").attr("src",c.logo);var g=a("body").find(".js-o-header-logo");g.css("width",""),g.css("height","")}else d.hide(),a(".ffy-logo").removeClass("logo-available")}.bind(this);var h=this.settings.getSetting("logo_dimensions");h.saved=function(b){this.data.post("/api/hub/settings/"+this.hub,{logo_dimensions:b.logo_dimensions}).then(function(b){var c=a(".js-o-header-logo");b.logo_dimensions.width<=200?c.css({width:b.logo_dimensions.width,height:b.logo_dimensions.height}):c.css({width:200,height:"auto"}),c.parent("a").css({position:"relative",left:b.logo_dimensions.x-25,top:b.logo_dimensions.y-25})}.bind(this))}.bind(this);var i=this.settings.getSetting("hero");i.saved=function(b){this.data.post("/api/hub/settings/"+this.hub,b).then(function(b){b.success&&(a(".mod-document .js-o-header .header-hero .title").css("fontSize",b.size).css("fontWeight",b.weight),"google"==b.provider&&WebFont.load({google:{families:[b.family_css]}}),a(".mod-document .js-o-header .header-hero .title").css("fontFamily",b.family_css))}.bind(this))}.bind(this);var j=this.settings.getSetting("hero_color");j.saved=function(b){a(".hub-light .mod-document .js-o-header .header-hero .title, .hub-dark .mod-document .js-o-header .header-hero .title").css("color",b.hero_color)}.bind(this)},bindNavigationSettings:function(){var b=this.$ctx,c=this.settings.getElem("sticky_navigation");c.changed=function(b){var c=b.sticky_navigation?"enabled":"disabled";this.data.post("/api/hub/settings/"+this.hub,{sticky_navigation:c}).then(function(b){var c=a("body").find(".document-sidebar");if("enabled"==b.sticky_navigation){if(a("body").attr("data-sticky","enabled"),c.length>0){var d=c.offset().top,e=function(){var b=a(window).scrollTop();b>=d?c.addClass("sticky"):c.removeClass("sticky")};e(),a(window).scroll(function(){e()})}}else a("body").attr("data-sticky","disabled"),c.removeClass("sticky"),a(window).unbind("scroll")})}.bind(this);var d=this.settings.getElem("collapsible_navigation");d.changed=function(b){var c=b.collapsible_navigation?"enabled":"disabled";this.data.post("/api/hub/settings/"+this.hub,{collapsible_navigation:c}).then(function(b){a("body").data("collapsible",b.collapsible_navigation);var c=a("body").find(".nav-pages");"enabled"==b.collapsible_navigation?c.addClass("state-collapsible"):c.removeClass("state-collapsible")}.bind(this))}.bind(this);var e=this.settings.getSetting("visible_documents");e.saved=function(b){var c=a(this.tpl.render("c-swal-visibile-docs-switched"));this.fire("openModal",{$content:c,type:"success",showCancelButton:!1}),c.on("click",".js-co-swal__confirm",function(a){window.location.reload()}.bind(this))}.bind(this);var f=this.settings.getSetting("category_style");f.saved=function(b){if(b.success){var c=a(".nav-pages h4");b.category_style?c.removeClass("state-text-style-normal"):c.addClass("state-text-style-normal")}}.bind(this);var g=function(){var a=this.settings.serialize();a.login_button&&b.find(".js-o-appearance__login-preview").html(this.tpl.render("appearance-navigation-login-button",a))}.bind(this),h=function(){var a=b.find(".js-o-appearance__login-details");a.hide()}.bind(this),i=function(){var a=b.find(".js-o-appearance__login-details");a.show()}.bind(this),j=this.settings.getSetting("login_button");j.saved=function(a){a.login_button?(g(),i()):h()}.bind(this);var k=this.settings.getSetting("login_button_rounded");k.saved=function(a){g()}.bind(this);var l=this.settings.getSetting("login_button_shadow");l.saved=function(a){g()}.bind(this);var m=this.settings.getSetting("login_button_background");m.saved=function(a){g()}.bind(this);var n=this.settings.getSetting("login_button_color");n.saved=function(a){g()}.bind(this),j.serialize().login_button?(g(),i()):h()},bindContentSettings:function(){var b=this.settings.getSetting("font");b.saved=function(b){this.data.post("/api/hub/settings/"+this.hub,b).then(function(b){b.success&&(a("html").css("fontWeight",b.weight).css("fontSize",b.size),"google"==b.provider&&WebFont.load({google:{families:[b.family_css]}}),a("body").css("fontFamily",b.family_css))}.bind(this))}.bind(this);var c=this.settings.getSetting("body_color");c.saved=function(b){a("body").css("color",b.body_color)}.bind(this);var d=this.settings.getSetting("link_color");d.saved=function(b){a(".ffy-lnk, .b-text .richtext a, .mod-block-text .richtext a, .b-annotations .annotations li a").css("color",b.link_color)}.bind(this);var e=this.settings.getSetting("headings");e.saved=function(b){this.data.post("/api/hub/settings/"+this.hub,b).then(function(b){if(b.success){var c=b.size.replace("px","");a(".page-content h1").css("fontSize",c+"px").css("fontWeight",b.weight),a(".page-content h2").css("fontSize",c/3*2.25+"px").css("fontWeight",b.weight),a(".page-content h3").css("fontSize",c/3*1.75+"px").css("fontWeight",b.weight),"google"==b.provider&&WebFont.load({google:{families:[b.family_css]}}),a(".page-content h1, .page-content h2, .page-content h3").css("fontFamily",b.family_css)}}.bind(this))}.bind(this);var f=this.settings.getSetting("headings_color");f.saved=function(b){a(".page-content h1, .page-content h2, .page-content h3").css("color",b.headings_color)}.bind(this);var g=this.settings.getElem("image_downloads");g.changed=function(b){var c=b.image_downloads?"enable":"disable";this.data.post("/api/hub/settings/"+this.hub,{image_downloads:c}).then(function(b){"enable"==b.image_downloads?a("body").removeClass("image-download-disabled"):a("body").addClass("image-download-disabled")})}.bind(this)},updateHeadersize:function(b){var c={header:{size:b}};this.data.post("/api/hub/settings/"+this.hub,c).then(function(c){c.success&&(a(".js-o-appearance__size",this.$ctx).removeClass("state-selected"),a('.js-o-appearance__size[data-size="'+b+'"]',this.$ctx).addClass("state-selected"),a(".js-o-header").removeClass("header-size-s header-size-m header-size-l").addClass("header-size-"+b))}.bind(this))}})}(Tc.$),function(a){Tc.Module.Brandhome=Tc.Module.extend({editing:!1,colors:[],on:function(b){var c=this.$ctx;this.sandbox.subscribe("events",this),this.tpl=this.sandbox.getConfigParam("tpl"),this.data=this.sandbox.getConfigParam("data"),this.$grid=c.find(".js-o-brandhome__grid"),this.$css=c.find(".js-o-brandhome__css"),this.render(),c.on("click",".js-o-brandhome__add-col",function(b){if(!this.editing)return!1;var d=a(b.currentTarget),e=d.closest(".js-o-brandhome__col"),f=d.closest(".js-o-brandhome__grid").find(".js-o-brandhome__row"),g=d.closest(".js-o-brandhome__row"),h=f.index(g),i=g.find(".js-o-brandhome__col"),j={row:h+1,column:i.index(e)+2};this.data.post("/api/hub/grid/"+c.data("hub"),j).then(function(b){if(b.success){var c=a(this.tpl.render("brandhome-col",b)),d=a(this.tpl.render("brandhome-teaser-empty"));c.append(d),e.after(c),c.velocity("fadeIn",{duration:200})}}.bind(this))}.bind(this)),c.on("click",".js-o-brandhome__remove-col",function(b){if(!this.editing)return!1;var d=a(b.currentTarget),e=d.closest(".js-o-brandhome__col"),f=e.find(".js-o-brandhome__teaser"),g=e.data("teaser");if(f.hasClass("state-empty")){var h=e.closest(".js-o-brandhome__row");e.remove(),this.data["delete"]("/api/hub/grid/"+g),0===h.find(".js-o-brandhome__col").length&&h.remove(),0===this.$grid.find(".js-o-brandhome__row").length&&c.find(".js-o-brandhome__add-section.state-initial").removeClass("state-hidden")}else f.replaceWith(a(this.tpl.render("brandhome-teaser-empty"))),this.update(g,{block_type:{type:"NONE"}})}.bind(this)),c.on("click",".js-o-brandhome__width-input",function(b){if(!this.editing)return!1;var c=a(b.currentTarget),d=parseInt(c.val()),e=c.closest(".js-o-brandhome__col");e.removeClass("o-brandhome__col--"+e.data("width")),e.addClass("o-brandhome__col--"+d),e.data("width",d),this.updateGridElement(e.data("teaser"),{width:d})}.bind(this)),c.on("click",".js-o-brandhome__add-block",function(b){if(!this.editing)return!1;var d=a(b.currentTarget),e=d.data("template"),f=d.closest(".js-o-brandhome__teaser"),g=d.closest(".js-o-brandhome__col");this.update(g.data("teaser"),{block_type:{type:e}}).then(function(b){b.editable=!0,b.project_id=c.data("project"),b.block_type=e.toUpperCase();var d=a(this.tpl.render("brandhome-teaser-"+e,b));switch(f.replaceWith(d),this.sandbox.addModules(d),e){case"video":this.initializeVideoUpload(d);break;case"image":this.initializeImageUpload(d)}}.bind(this))}.bind(this)),c.on("click",".js-o-brandhome__add-section",function(b){if(!this.editing)return!1;var d=a(b.currentTarget);this.data.post("/api/hub/grid/"+c.data("hub"),{row:d.closest(".js-o-brandhome__grid").find(".js-o-brandhome__row").length+1,mode:"append"}).then(function(b){if(b.success){var c=d.closest(".js-o-brandhome__row"),e=a(this.tpl.render("brandhome-row")),f=a(this.tpl.render("brandhome-col",b)),g=a(this.tpl.render("brandhome-teaser-empty"));e.append(f),f.append(g),0===c.length?this.$grid.append(e):c.after(e),f.velocity("fadeIn",{duration:200}),d.hasClass("state-initial")&&d.addClass("state-hidden")}}.bind(this))}.bind(this)),c.on("click",".js-o-brandhome__teaser",function(b){if(!this.editing){var c=a(b.currentTarget),d=c.data("link");if(d){var e=c.data("link-target");"_blank"===e?window.open(d):location.href=d}}}.bind(this)),c.on("blur",".js-o-brandhome__link",function(b){var c=a(b.currentTarget),d=c.closest(".js-o-brandhome__teaser"),e=c.closest(".js-o-brandhome__col").data("teaser");d.data("link",c.val()),this.update(e,{settings:{link:c.val()}})}.bind(this)),c.on("keyup change",".js-o-brandhome__teaser-padding",function(b){var c=a(b.currentTarget),d=parseInt(c.val())||0,e=c.closest(".js-o-brandhome__col"),f=e.find(".js-o-brandhome__apply-padding");f.css({padding:d+"px"}),this.update(e.data("teaser"),{settings:{padding:d+"px"}})}.bind(this)),c.on("click",".js-o-brandhome__teaser-background-trigger",function(b){var d=a(b.currentTarget);d.closest(".js-o-brandhome__col").data("teaser");this.isOpen?(this.$chooser.detach(),this.isOpen=!1):(this.isOpen=!0,this.data.get("/api/color/library/"+c.data("project")).then(function(b){if(b.success){var c=d.data("background")||"none";a.each(b.palettes,function(b,d){d.colors&&a.each(d.colors,function(a,b){this.colors[b.id]=b,c==b.id&&(b.active=!0)}.bind(this))}.bind(this)),this.$chooser=a(this.tpl.render("brandhome-color-flyout",b)),d.closest(".js-m-btn-dropdown__item").append(this.$chooser)}}.bind(this)))}.bind(this)),c.on("click",".js-o-brandhome-grid__color",function(b){var c=a(b.currentTarget),d=c.data("id"),e="transparent",f="Transparent",g=c.closest(".js-o-brandhome__col"),h=g.find(".js-o-brandhome__teaser"),i=c.closest(".m-btn-dropdown__item").find(".o-brandhome__color-preview");d>0&&(e=this.colors[d].css_value,f=this.colors[d].name);var j={settings:{background:e}};i.css({"background-color":e}),h.css({"background-color":e}),this.update(g.data("teaser"),j)}.bind(this)),c.on("click",".btn-replace",function(b){var c=a(b.currentTarget),d=c.closest(".js-o-brandhome__teaser").find(".js-m-dropzone__upload");d.trigger("click")}.bind(this)),c.on("change",".js-b-video_autoplay",function(b){var c=a(b.currentTarget),d=c.prop("checked"),e={settings:{autoplay:d}},f=c.closest(".js-o-brandhome__col");this.update(f.data("teaser"),e)}.bind(this)),c.on("change",".js-b-video_loop",function(b){var c=a(b.currentTarget),d=c.prop("checked"),e={settings:{loop:d}},f=c.closest(".js-o-brandhome__col");this.update(f.data("teaser"),e)}.bind(this)),this.initializeEditor(),b()},after:function(){var b=this,c=this.$ctx;c.on("change mousemove",".js-o-brandhome__control-setting-spacing",function(c){if(!b.editing)return!1;var d=a(c.currentTarget),e={brandhome:{margin:parseInt(d.val())}};this.updateGrid(e)}.bind(this)),c.on("change keyup",".js-o-brandhome__control-setting-width",function(d){if(!b.editing)return!1;var e=a(d.currentTarget),f=e.val(),g=a(".js-o-brandhome__control-setting-unit",c).val();a(".mod-document>header .container").css("maxWidth",""+f+g);var h={brandhome:{width:parseInt(e.val())}};this.updateGrid(h)}.bind(this)),c.on("change keyup",".js-o-brandhome__control-setting-unit",function(d){if(!b.editing)return!1;var e=a(d.currentTarget),f=e.val(),g=100;"px"===f&&(g=1300),a(".js-o-brandhome__control-setting-width",c).val(g),a(".mod-document>header .container").css("maxWidth",""+g+f);var h={brandhome:{width_unit:f,width:g}};this.updateGrid(h)}.bind(this)),c.on("blur","[contenteditable]",function(b){if(!this.editing)return!1;var c=a(b.currentTarget);window.getSelection().removeAllRanges();var d=c.closest(".js-o-brandhome__col").data("teaser"),e=c.html(),f={settings:{}};f.settings[c.data("field")]=e,this.update(d,f)}.bind(this))},render:function(){var b=this.$ctx;this.data.get("/api/hub/grid/"+b.data("hub")).then(function(b){b.success&&(this.$grid.html(this.tpl.render("brandhome-grid",b)),this.$css.html(this.tpl.render("brandhome-css",b.grid)),this.$grid.find(".js-o-brandhome__teaser").each(function(b,c){this.initializeImageUpload(a(c))}.bind(this)),this.sandbox.addModules(this.$grid),this.$grid.find(".js-o-brandhome__col").velocity({opacity:1},{duration:500,stagger:100}))}.bind(this))},initializeEditor:function(){var b=this.$ctx,c=this;b.on("mousedown","[contenteditable]",function(b){c.selectedElement=a(this),c.selection=!0}),b.on("mousedown mouseup",".richtext-menu",function(a){return a.stopPropagation(),!1}),b.on("keypress","[contenteditable]",function(a){b.find(".richtext-menu").remove()}),a(window).on("mouseup",function(){a(".mod-document").hasClass("editor-enabled")&&c.selection&&(c.createHint(),c.selection=!1)}),a(document).on("mousedown",function(){b.find(".richtext-menu").remove()}),b.on("click",".btn-bold",function(a){a.preventDefault(),document.execCommand("bold",!1,null)}),b.on("click",".btn-italic",function(a){a.preventDefault(),document.execCommand("italic",!1,null)}),b.on("click",".btn-size",function(b){b.preventDefault(),a(this).closest(".richtext-menu").find("a").hide(),a(this).closest(".richtext-menu").find(".sizes").show(),a(this).closest(".richtext-menu").css("width","250px")}),b.on("click",".richtext-menu .sizes div",function(b){b.preventDefault(),a(this).closest(".richtext-menu").find("a").show(),a(this).closest(".richtext-menu").css("width","220px");var d=a(this).find("span").text();c.selectedElement.css("fontSize",d+"px"),a(this).closest(".richtext-menu").find(".btn-size .value").text(d),a(this).closest(".sizes").hide(),c.refreshHint();var d=a(this).find("span").text(),e=c.selectedElement.closest(".js-o-brandhome__col"),f={settings:{}};f.settings[c.selectedElement.data("group")+".size"]=d+"px",c.update(e.data("teaser"),f)}),b.on("click",".btn-align",function(b){b.preventDefault();var d=c.selectedElement.css("textAlign"),e="left";("undefined"==typeof d||"left"==d||"start"==d)&&(c.selectedElement.css("textAlign","center"),a(this).find("i").removeClass("fa-align-left"),a(this).find("i").addClass("fa-align-center"),e="center"),"center"==d&&(c.selectedElement.css("textAlign","right"),a(this).find("i").removeClass("fa-align-center"),a(this).find("i").addClass("fa-align-right"),e="right"),"right"==d&&(c.selectedElement.css("textAlign","left"),a(this).find("i").removeClass("fa-align-right"),a(this).find("i").addClass("fa-align-left"),e="left");var f=c.selectedElement.closest(".js-o-brandhome__col"),g={settings:{}};g.settings[c.selectedElement.data("group")+".align"]=e,c.update(f.data("teaser"),g)}),b.on("click",".btn-color",function(d){d.preventDefault();var e=a(this);a.ajax({url:"/api/color/library/"+b.data("project"),success:function(b){if(b.success){var d=e.data("background")||"none";a.each(b.palettes,function(b,e){e.colors&&a.each(e.colors,function(a,b){c.colors[b.id]=b,d==b.id&&(b.active=!0)})}),c.$chooser=a(c.tpl.render("brandhome-color-flyout",b)),e.closest(".richtext-menu").append(c.$chooser)}}})}),b.on("click",".richtext-menu .js-o-brandhome-grid__color",function(b){var d=a(this),e=d.data("id"),f="inherit";e>0&&(f=c.colors[e].css_value),document.execCommand("styleWithCSS",!1,!0),document.execCommand("foreColor",!1,f)})},initializeVideoUpload:function(b){var c=b.closest(".js-o-brandhome__col");a(".js-m-dropzone__upload",b).fileupload({dataType:"json",dropZone:a(".js-m-dropzone",b),add:function(a,b){b.submit()}.bind(this),start:function(){var c=a(".js-m-dropzone",b),d=a(this.tpl.render("progress",{id:this.id}));c.find(".fa-image").replaceWith(d),this.sandbox.addModules(d)}.bind(this),progress:function(a,b){var c=parseInt(b.loaded/b.total*100,10);this.fire("progress",{id:this.id,progress:c})}.bind(this),done:function(a,d){if(d.result&&d.result[0]){b.find(".a-progress").hide(),b.find(".js-m-dropzone span").text("Your video is beeing processed...");var e=setInterval(function(){this.pollVideoConverter(d.result[0].id,function(a){a.video_mp4&&(clearInterval(e),b.find(".js-m-dropzone").addClass("state-hidden"),b.find(".js-o-brandhome__video-wrap").html('<video controls poster="/api/screen/thumbnail/'+a.video_thumbnail+'" src="/api/screen/thumbnail/'+a.video_mp4+'" preload="none" autoplay loop />'),this.update(c.data("teaser"),{settings:{asset:a.video_mp4,preview:a.video_thumbnail}}))}.bind(this))}.bind(this),3e3)}}.bind(this)})},initializeImageUpload:function(b){var c=b.closest(".js-o-brandhome__col");a(".js-m-dropzone__upload",b).fileupload({dataType:"json",dropZone:a(".js-m-dropzone",b),add:function(a,b){b.submit()}.bind(this),start:function(){var c=a(".js-m-dropzone",b),d=a(this.tpl.render("progress",{id:this.id}));c.find(".fa-image").replaceWith(d),this.sandbox.addModules(d)}.bind(this),progress:function(a,b){var c=parseInt(b.loaded/b.total*100,10);this.fire("progress",{id:this.id,progress:c})}.bind(this),done:function(a,d){d.result&&d.result[0]&&(b.find(".js-m-dropzone").addClass("state-hidden"),b.find(".js-o-brandhome__image-wrap").html('<img class="o-brandhome__image" src="/api/screen/thumbnail/'+d.result[0].hash+'" />'),this.update(c.data("teaser"),{settings:{asset:d.result[0].hash}}))}.bind(this)})},onDisableEditing:function(a){var b=this.$ctx;this.editing=!1,b.find("*[contenteditable]").removeAttr("contenteditable")},onEnableEditing:function(a){var b=this.$ctx;this.editing=!0,b.find('*[data-editable="true"]').attr("contenteditable",!0)},update:function(a,b){return this.data.post("/api/hub/teaser/"+a,b)},updateGrid:function(a){var b=this.$ctx,c={width:parseInt(b.find(".js-o-brandhome__control-setting-width").val()),width_unit:b.find(".js-o-brandhome__control-setting-unit").val(),margin:parseInt(b.find(".js-o-brandhome__control-setting-spacing").val())};return this.$css.html(this.tpl.render("brandhome-css",c)),this.data.post("/api/hub/settings/"+this.$ctx.data("hub"),a)},updateGridElement:function(a,b){return this.data.patch("/api/hub/grid/"+a,b)},_getSelection:function(){var a=this,b=this.$ctx,c={text:"",from:0,to:0,rect:{}};if(window.getSelection&&"Caret"==window.getSelection().type&&b.find(".richtext-menu").remove(),
window.getSelection&&"Range"==window.getSelection().type||window.getSelection().rangeCount>0){var d,e=window.getSelection();if(a.selection=e,c.text=e.toString(),c.from=e.anchorOffset,c.to=e.focusOffset,e.rangeCount&&(d=e.getRangeAt(0).cloneRange(),d.getBoundingClientRect)){var f=d.getBoundingClientRect();c.rect={top:f.top,left:f.left+f.width/2}}}if(c.from>c.to){var g=c.from;c.from=c.to,c.to=g}return c},createHint:function(){var b=this,c=this.$ctx,d=b._getSelection();if(""!==d.text.trim()){if(a(".mod-document").hasClass("editor-enabled")){var e,f,g=document.queryCommandValue("ForeColor");window.getSelection?(f=window.getSelection(),f.rangeCount&&(e=f.getRangeAt(0).commonAncestorContainer,3==e.nodeType&&(e=e.parentNode))):(f=document.selection)&&"Control"!=f.type&&(e=f.createRange().parentElement()),window.getComputedStyle?fontSize=window.getComputedStyle(e,null).fontSize:el.currentStyle&&(fontSize=el.currentStyle.fontSize);var h='<div class="richtext-menu tooltip-edit">';h+='<a class="btn-bold" href="javascript:;"><i class="icon-bold"></i></a>',h+='<a class="btn-italic" href="javascript:;"><i class="icon-italic"></i></a>',h+='<a class="btn-color" href="javascript:;"><span style="background: '+g+'">&nbsp;</span></a>',h+='<a class="btn-align" href="javascript:;"><i class="icon-align-left"></i></a>',h+='<a class="btn-size" href="javascript:;"><span class="value">'+parseFloat(fontSize,10)+"</span>px</a>",h+='<div class="sizes"><div><span>14</span>px</div><div><span>16</span>px</div><div><span>18</span>px</div><div><span>22</span>px</div><div><span>24</span>px</div><div><span>36</span>px</div></div>',h+="</div>";var i=a(h)}i.css({top:d.rect.top,left:d.rect.left}),c.append(i)}},refreshHint:function(){var b=this,c=this.$ctx,d=b._getSelection();a(".richtext-menu",c).css({top:d.rect.top,left:d.rect.left})},pollVideoConverter:function(b,c){this.$ctx;a.ajax({url:"/api/screen/video/"+b,contentType:"application/json; charset=utf-8",type:"GET",success:function(a){c(a)}})}})}(Tc.$),function(a){Tc.Module.Changelog=Tc.Module.extend({on:function(b){var c=this.$ctx;this.sandbox.subscribe("events",this),this.tpl=this.sandbox.getConfigParam("tpl"),this.data=this.sandbox.getConfigParam("data"),this.editing=!1,this.roles={},this.changes=[],this.selection={},this.hub=a("body").data("hub"),this.changelogId=c.data("id")||!1,this.formSettings=null;var d="/api/hub/changelog/review/"+this.hub;this.changelogId&&(d="/api/hub/changelog/"+this.hub+"/"+this.changelogId),this.data.get(d).then(function(a){a.success&&(this.changes=a.changes,this.renderReview())}.bind(this)),c.on("click",".js-o-changelog__comment-add",function(b){var c=a(b.currentTarget),d=c.closest(".js-o-changelog__item"),e=a(this.tpl.render("changelog-review-item",a.extend(!0,{},this.getItem(d.data("id")),{edit:!0})));d.replaceWith(e),this.formSettings&&this.formSettings.destroy();var f=e.find(".js-o-changelog__comment-form");this.formSettings=new Tc.Module.CSettings(f,this.sandbox),this.formSettings.validation(function(){var b=this.formSettings.serialize();this.data.post("/api/hub/changelog/item",b).then(function(){var c=this.getItem(b.id);c.comment=b.comment,e.replaceWith(a(this.tpl.render("changelog-review-item",c)))}.bind(this))}.bind(this)),b.stopPropagation()}.bind(this)),c.on("click",".js-o-changelog__comment-cancel",function(b){b.preventDefault();var c=a(b.currentTarget),d=c.closest(".js-o-changelog__item"),e=this.getItem(d.data("id"));d.replaceWith(a(this.tpl.render("changelog-review-item",e))),b.stopPropagation()}.bind(this)),c.on("submit",".js-o-changelog__review-form",function(b){b.preventDefault();var d=a(b.currentTarget),e=this.data.serializeForm(d),f={},g=e.block.split(",");g.forEach(function(a){var b=c.find(".js-o-changelog__item[data-id="+a+"]"),d=b.data("type");f[d]=f[d]||[],f[d].push(a)}.bind(this)),this.selection=f,this.data.get("/api/hub/roles/"+this.hub).then(function(a){a.success&&(this.roles=a.roles,this.renderAudience())}.bind(this))}.bind(this)),c.on("click",".js-o-changelog__item-remove",function(b){b.preventDefault();var c=a(b.currentTarget),d=c.closest(".js-o-changelog__item"),e=d.data("id");this.data["delete"]("/api/hub/changelog/clear/"+this.hub+"/"+d.data("type")+"/"+e).then(function(a){a.success&&(this.changes=this.changes.filter(function(a){return a.id!=e}.bind(this)),d.remove())}.bind(this))}.bind(this)),c.on("blur",".js-o-changelog__editable[contenteditable]",function(b){var c=a(b.currentTarget),d=c.closest(".js-o-changelog__item"),e=c.data("field"),f=d.data("id"),g={id:d.data("id"),type:d.data("type")};g[e]=c.text(),this.data.post("/api/hub/changelog/item",g).then(function(){var a=this.getItem(f);a[e]=g[e]}.bind(this))}.bind(this)),c.on("click",".js-o-changelog__clear",function(a){a.preventDefault(),this.data["delete"]("/api/hub/changelog/clear/"+this.hub).then(function(a){a.success&&(this.changes=[],this.renderReview())}.bind(this))}.bind(this)),c.on("submit",".js-o-changelog__role-form",function(b){b.preventDefault();var c=a(b.currentTarget),d=this.data.serializeForm(c);this.data.post("/api/hub/changelog/send",{hub:this.hub,roles:d.role.split(","),comment:d.comment,changes:this.selection}).then(function(a){a.success&&(this.fire("closeModal"),swal({allowOutsideClick:!0,showCancelButton:!1,title:"Your changelog has been successfully sent!",type:"success",timer:2e3}))}.bind(this))}.bind(this)),c.on("click",".js-o-changelog__back",function(a){a.stopPropagation(),this.renderReview()}.bind(this)),c.on("click",".js-o-changelog__close",function(a){a.preventDefault(),0===window.location.hash.indexOf("#changelog")&&(window.location.hash="#",window.location.reload())}.bind(this)),b()},getItem:function(a){return this.changes.find(function(b){return b.id==a}.bind(this))},renderReview:function(){var a=this.$ctx;this.changelogId?a.html(this.tpl.render("changelog-view",{changes:this.changes})):a.html(this.tpl.render("changelog-review",{changes:this.changes}))},renderAudience:function(){var a=this.$ctx;a.html(this.tpl.render("changelog-audience",this.roles))}})}(Tc.$),function(a){Tc.Module.Document=Tc.Module.extend({templates:[],document_id:null,project_id:null,hub_id:null,adding:!1,collaborators:[],sortables:{pages:[]},block_clipboard:null,block_loading_state:[],on:function(b){this.tpl=this.sandbox.getConfigParam("tpl"),this.data=this.sandbox.getConfigParam("data"),this.pusher=this.sandbox.getConfigParam("pusher"),this.sandbox.subscribe("events",this);var c=this,d=this.$ctx,e=(a(".document-sidebar",d),a(".btn-more > .dropdown",d));a(".btn-language > .dropdown",d),a("body").data("hub");ZeroClipboard.config({swfPath:"/swf/ZeroClipboard2.swf"}),this.document_id=d.data("document"),this.project_id=d.data("project"),this.hub_id=d.data("hub"),d.on("click",function(a){e.hide()}),a("body").off(".startworkspacetrial").on("click.startworkspacetrial",'.intercom-block-button[href="/#start-workspace-trial"]',function(b){b.preventDefault(),a(".intercom-modal-overlay").trigger("click"),this.createProject()}.bind(this)),a(".btn-toggle-code",d).on("click",function(){d.toggleClass("code-enabled")}),a(".btn-toggle-editing",d).on("click",function(){d.toggleClass("editor-enabled"),d.hasClass("editor-enabled")?c.enableEditing():c.disableEditing()}),a(".btn-toggle-media",d).on("click",function(){var a="PRINT",b=d.find('[data-media="'+a+'"]');b.hide()}),a(".btn-navigation-toggle",d).on("click",function(){var a=d.find(".document-nav"),b=a.height();d.find(".nav.nav-pages").css("padding-top",b+45+"px"),a.toggleClass("hide transparent"),d.toggleClass("sidebar-overlay"),d.find(".nav-search").toggleClass("hide"),d.find(".nav-tools").toggleClass("hide")}),a(".enable-search",d).on("click",function(){c.openPaymentModal("STYLEGUIDE_SEARCH")}),a(".btn-example",d).on("click",function(){Intercom("trackEvent","sg-hook-view-example",{}),window.open("https://brand.frontify.com/d/qAiubNBytHKf/style-guide","_blank")}),d.on("click",".js-navigation__language-link",function(b){var c=a(".nav-pages",d).find(".item-active:first").data("page"),e=a(b.currentTarget).data("url")+"/?page="+c;window.location.href=e}),a(".btn-more > a",d).on("click",function(b){return d.find(".m-dropdown--language").hide(),a(this).parent().find(".dropdown").toggle(),!1}),a(".btn-language > a",d).on("click",function(){return a(this).parent().find(".m-dropdown--language").toggle(),!1}),d.on("click",".js-m-btn-upgrade",function(){Intercom("trackEvent","sg-change-plan",{})});new ZeroClipboard(a(".mod-frontify-modal").find(".btn-copy-share-url").get(0));if(a(".mod-frontify-modal .fld-role-select").dropdown(),a(".btn-pattern-settings",d).on("click",function(){return a(".pattern-settings",d).addClass("visible"),a(".pattern-settings",d).removeClass("small"),a(".btn-more .dropdown",d).hide(),Intercom("trackEvent","sg-pattern-settings",{}),!1}),d.on("click",".btn-remove-attachment",function(b){var c=a(this).parents("li"),d=c.data("id");return a.ajax({url:"/api/attachment/remove/"+d,type:"DELETE",success:function(a){a.success&&c.remove()}}),!1}),d.on("click",".btn-hide-codesnippets",function(){c.handleCodeSnippets()}),a("html").keydown(function(b){switch(b.keyCode){case 69:if(b.metaKey||b.ctrlKey)return a(".btn-toggle-editing",d).trigger("click"),!1}}),d.on("click",".add-block .col-categories li a",function(b){var c=a(this).parent().data("category");return a(this).parents(".block-library").find(".col-category-items").hide(),a(this).parents(".block-library").find('.col-category-items[data-category="'+c+'"]').show(),!1}),d.on("click",".js-o-header .nav-tools .btn-delete-styleguide",function(){var b=(this.$ctx,a("body").data("hub"));swal({title:"Are you sure?",text:"This action will delete your style guide completely! Do you really want to delete your awesome data?",type:"warning",showCancelButton:!0,confirmButtonColor:"#C93B3E",confirmButtonText:"Yes, delete this Style Guide!",closeOnConfirm:!0},function(c){c&&a.ajax({url:"/api/hub/delete/"+b,type:"DELETE",success:function(a){a.success?(Intercom("trackEvent","sg-hook-delete-styleguide",{}),location.href="/"):alert(a.error)}})})}),window.location.hash){var f=window.location.hash;f="/"==f.substring(f.length-1,f.length)?f.substring(0,f.length-1):f,f=decodeURIComponent(f);var g=d.find('.nav-pages a[href="'+f+'"]');if(g.parent().hasClass("item-section")){var h=g.closest(".item").data("page"),i=g.parent().data("id");c.open(h,function(){0==c.block_loading_state.length?window.scrollTo(0,a('section[data-id="'+i+'"]').offset().top-40):a("body").data("scrollTo",i)})}else{var h=g.parent().data("page");c.open(h,function(){d.find(".js-o-header").hasClass("header-size-m")||d.find(".js-o-header").hasClass("header-size-l")?window.scrollTo(0,d.find(".js-o-header").height()):window.scrollTo(0,0)})}}else if(!d.data("printview")){var h=a(".nav-pages .item:first").data("page");c.open(h,function(){window.scrollTo(0,0)})}"onhashchange"in window&&a(window).bind("hashchange",function(b){var e=window.location.hash;if(e="/"==e.substring(e.length-1,e.length)?e.substring(0,e.length-1):e,e=decodeURIComponent(e),"#customize"==e&&d.find(".btn-customize-appearance").click(),0===window.location.hash.indexOf("#changelog")){var f=parseInt(window.location.hash.replace("#changelog-",""));f>0&&c.openChangelog(f)}var g=d.find('.nav-pages a[href="'+e+'"]');if(g.parent().hasClass("item-section")){var h=g.parents(".item").data("page"),i=g.parent().data("id");c.open(h,function(){window.scrollTo(0,a('section[data-id="'+i+'"]').offset().top-40)})}else{var h=g.parent().data("page");c.open(h,function(){if(d.attr("data-cut-block")){var b=d.find(".btn-toggle-block-library");a.each(b,function(b,c){a(c).addClass("cut-enabled"),a(c).find("i").removeClass("icon-plus"),a(c).find("i").addClass("icon-long-arrow-right")})}d.find(".js-o-header").hasClass("header-size-m")||d.find(".js-o-header").hasClass("header-size-l")?window.scrollTo(0,d.find(".js-o-header").height()):window.scrollTo(0,0)})}}),d.data("editing")&&a(".fileupload-logo",d).fileupload({dataType:"json",dropZone:a(".dropzone-logo",d),done:function(b,c){if(c.result&&c.result[0]){var e=(c.result[0].width<200?c.result[0].width:200,c.result[0].width<200?c.result[0].height:0,{appearance:{logo:{url:"/api/screen/thumbnail/"+c.result[0].hash+"/400",height:null,width:null}}});a.ajax({url:"/api/hub/settings/"+d.data("hub"),data:JSON.stringify(e),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){if(b.success){var c=a('<img class="logo-image" src="'+e.appearance.logo.url+'" alt="" />');c.css("width",""),c.css("height",""),c.css("display","block"),a(".appearance-settings .header-logo-image .preview",d).css("backgroundImage","url("+e.appearance.logo.url+")"),a(".ffy-logo .logo-image",d).length>0?a(".ffy-logo .logo-image",d).replaceWith(c):(c.hide(),0==a(".ffy-logo > a",d).length&&a(".ffy-logo",d).append('<a class="btn-logo btn-upload btn-upload-logo" href="/hub/'+d.data("hub")+'"></a>'),a(".ffy-logo > a",d).append(c),c.fadeIn()),a(".ffy-logo",d).addClass("logo-available")}}})}}}),d.on("click",".mod-frontify-modal .btn-sharing",function(){a(".mod-frontify-modal .btn-sharing",d).removeClass("btn-selected"),a(this).addClass("btn-selected"),a(".mod-frontify-modal .visibility-note",d).text(a(this).data("txt-visibility"));var b={visibility:a(this).data("visibility"),document:c.document_id};a.ajax({url:"/api/hub/settings/"+d.data("hub"),data:JSON.stringify(b),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){b.success&&(a(".mod-frontify-modal .fld-url-default .fld-input",d).text(b.link),a(".mod-frontify-modal .fld-url-default .btn-copy-share-url",d).attr("data-clipboard-text",b.link))}})}),d.on("focus",".mod-frontify-modal .fld-member-email .fld-input",function(){a(this).closest(".fld-group").find(".fld-invite-note").show(),a(this).closest(".mod-frontify-modal").find(".section-invite-actions").show(),a(this).closest(".mod-frontify-modal").find(".btn-done").hide()}),d.on("click",".mod-frontify-modal .btn-close, .mod-frontify-modal .btn-done",function(){a(".mod-frontify-modal .fld-member-email input",d).val(""),a(".mod-frontify-modal .fld-invite-note textarea",d).val(""),c.fire("closeModal",{id:"share"})}),d.on("click",".mod-frontify-modal .btn-cancel",function(){a(".mod-frontify-modal .fld-group",d).find(".fld-invite-note").hide(),a(".mod-frontify-modal",d).find(".section-invite-actions").hide(),a(".mod-frontify-modal",d).find(".btn-done").show()}),d.on("click",".mod-frontify-modal .btn-done",function(){var b=d.find(".mod-frontify-modal"),c=b.find(".option-customdomain .fld-url-custom > input").val(),e=d.data("hub"),f=a(this).closest(".m-modal__content--share").find(".fld-url-default .fld-input"),g=!1;c||(custom_domain_default=d.data("share-url-default"),f.text(custom_domain_default),g=!0);var h=/^[a-z0-9-\.]+\.[a-z]{2,4}/;if(h.test(c)||g){var i={cname:c};a.ajax({url:"/api/hub/settings/"+e,data:JSON.stringify(i),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success?f.text(c):a.error&&alert(a.error)}})}else alert("Error in Custom domain!")}),d.on("keyup",".mod-frontify-modal .option-customdomain .fld-url-custom > input",function(b){var c=a(this).val();c.indexOf(".")>=0?(a(".mod-frontify-modal .instructions table .custom_domain",d).text(c),a(".mod-frontify-modal .instructions").show()):(a(".mod-frontify-modal .instructions").hide(),a(".mod-frontify-modal .instructions table .custom_domain",d).text(""))}),d.on("click",".mod-frontify-modal .btn-invite",function(){a(this).text("Inviting...");var b={project:c.project_id,document:c.document_id,hub:d.data("hub"),trigger:"styleguide",email:a(".mod-frontify-modal .fld-member-email input",d).val(),note:a(".mod-frontify-modal .fld-invite-note textarea",d).val(),permission:a(".mod-frontify-modal .fld-role-select",d).val()};a.ajax({url:"/api/collaborator/add/",data:JSON.stringify(b),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){if(b.success)a.each(b.users,function(a,b){c.collaboratorAdd(b),c.collaborators.push(b)});else{var e=parseInt(a(".section-team .users-current").text());Intercom("trackEvent","sg-hook-user-limit",{current:e,styleguide:d.data("hub")}),swal({title:b.messages.title,text:b.messages.msg,type:"warning",showCancelButton:!0,confirmButtonText:"Upgrade",closeOnConfirm:!0},function(){c.openPaymentModal("CORE_USER_LIMIT")})}var f=[];a.each(c.collaborators,function(a,b){f.push(b.name)}),a(".mod-frontify-modal .btn-invite",d).text("Invite people"),a(".mod-frontify-modal .btn-manage-team",d).html("Shared with "+f.join(", ")),a(".mod-frontify-modal .fld-group",d).find(".fld-invite-note").hide(),a(".mod-frontify-modal",d).find(".section-invite-actions").hide(),a(".mod-frontify-modal",d).find(".btn-done").show(),a(".mod-frontify-modal .fld-group",d).find(".btn-manage-team").show(),a(".mod-frontify-modal .fld-member-email input",d).val(""),a(".mod-frontify-modal .fld-invite-note textarea",d).val(""),a(".section-team .users-current").text(c.collaborators.length)}})}),c.handleCodeSnippets("initial"),d.on("click",".nav-documents .item-expand",function(){var b=a(this).closest(".header-main").find(".document-nav");return"true"==b.attr("data-expand")?b.find(".btn-close").trigger("click"):(b.removeClass("hide"),b.find(".item-expand"),setTimeout(function(){b.removeClass("transparent")},20),a(".mod-frontify-modal-bg").show(),b.attr("data-expand",!0)),!1}),d.on("click",".nav-documents .item",function(){"dropdown"==a("body").attr("data-navigation-mode")&&d.find(".nav-documents .item-expand").trigger("click")}),d.on("click",".category-title",function(){if("enabled"==d.data("collapsible")){var b=a(this),c=b.next(".category-pages-container"),e=d.find(".category-pages-container");c.hasClass("state-open")?c.removeClass("state-open"):(e.removeClass("state-open"),c.addClass("state-open"))}}),d.on("click",".document-nav .btn-close",function(){var b=a(this).closest(".header-main").find(".document-nav");b.addClass("hide transparent"),a(".mod-frontify-modal-bg").hide(),b.find(".document-actions-dropdown").addClass("hide"),b.attr("data-expand",!1)}),a(document).keyup(function(a){27==a.keyCode&&"true"==d.find(".header-main .document-nav").attr("data-expand")&&d.find(".header-main .document-nav .btn-close").trigger("click")}),d.on("click",".mod-frontify-modal-bg",function(){"true"==d.find(".header-main .document-nav").attr("data-expand")&&d.find(".header-main .document-nav .btn-close").trigger("click")}),c.setNavigationSticky(),b()},enableSearch:function(){var b=this,c=this.$ctx,d=c.data("search-prefix"),e=new AlgoliaSearch(c.data("search-id"),c.data("search-key"));e.setSecurityTags(c.data("search-filter"));var f=e.initIndex(d+"document_page"),g=e.initIndex(d+"document_section"),h=e.initIndex(d+"color"),i=e.initIndex(d+"pattern"),j=e.initIndex(d+"document_block"),k={hitsPerPage:5,tags:[]},l={hitsPerPage:5,tags:[]},m={hitsPerPage:5,tags:["project_"+b.project_id]},n={hitsPerPage:5,tags:["project_"+b.project_id]},o="title",p="name",q="content",r="palette_name",s="section_title",t=a("body").data("translation-language");t&&(o+="_"+t,p+="_"+t,q+="_"+t,r+="_"+t,s+="_"+t);var u=Hogan.compile('<div class="s-page"><div class="title">{{{ _highlightResult.'+o+".value }}}</div></div>"),v=Hogan.compile('<div class="s-section"><div class="title">{{{ _highlightResult.'+o+".value }}} <span>({{{ page_"+o+" }}})</span></div></div>"),w=Hogan.compile('<div class="s-pattern"><div class="title">{{{ _highlightResult.'+p+".value }}} <span>({{{ granularity }}})</span></div></div>"),x=Hogan.compile('<div class="s-color"><div class="title"><span class="preview" style="background: #{{{ hex }}}"></span> {{{ _highlightResult.name.value }}} <span>(#{{{ hex }}}, {{{ '+r+" }}})</span></div></div>"),y=Hogan.compile('<div class="s-content"><div class="title">{{{ page_'+o+" }}} <span>/ {{{ "+s+" }}}</span></div><p>{{{ _highlightResult."+q+".value }}}</p></div>"),z=a(".nav-search input",c).typeahead({hint:!1},[{source:g.ttAdapter(k),displayKey:o,templates:{header:'<div class="category">Sections</div>',suggestion:function(a){return v.render(a)}}},{source:f.ttAdapter(l),displayKey:o,templates:{header:'<div class="category">Pages</div>',suggestion:function(a){return u.render(a)}}},{source:i.ttAdapter(m),displayKey:p,templates:{header:'<div class="category">Patterns</div>',suggestion:function(a){return w.render(a)}}},{source:h.ttAdapter(n),displayKey:p,templates:{header:'<div class="category">Colors</div>',suggestion:function(a){return x.render(a)}}},{source:j.ttAdapter({hitsPerPage:5,tags:[],attributesToSnippet:"content:10"}),displayKey:q,templates:{header:'<div class="category">Content</div>',suggestion:function(a){return y.render(a)}}}]);z.on("typeahead:selected",function(b,c){var d=a("body").data("baseurl"),e=d.split("/"),f=c.link.split("/");switch(t&&c.hasOwnProperty("link_"+t)&&(f=c["link_"+t].split("/")),e[1]){case"document":var g=f[2].replace("#","");g!=e[2]&&(e[2]=g,d=e.join("/"));break;case"d":var h=atob(a("body").data("searchmapping")),i=jQuery.parseJSON(h),g=f[2].replace("#","");a.each(i,function(a,b){a==g&&(d+="/"+b)})}f.splice(0,3),t?location.href=d+"/"+f.join("/"):location.href=d+"#/"+f.join("/")})},open:function(b,c){var d=this,e=this.$ctx,f=e.find(".nav-pages"),g=a(".page",e),h=a('.item[data-page="'+b+'"]');if(e.removeClass("sidebar-overlay"),f.find(".item-active").removeClass("item-active"),h.addClass("item-active"),g.data("id")==b)return void c();"undefined"==typeof b||0>=b?a(".page-content").addClass("no-page"):a(".page-content").removeClass("no-page"),g.addClass("hidden loading"),f.find(".nav-sections").hide(),h.find(".nav-sections").show();var i=h.closest(".category-pages-container");e.find(".category-pages-container").removeClass("state-open"),i.addClass("state-open");var j="/api/document/page/"+d.document_id+"/"+b;a("body").data("translation-language")&&(j+="?lang="+a("body").data("translation-language")),a.ajax({url:j,type:"GET",success:function(f){if(f.success){application.sandbox.config.context=a.extend(!0,{},d.sandbox.getConfigParam("context"),{pageId:b,pageTitle:f.page.title}),d.fire("page"),d.sandbox.removeModules([a(".page-content > .sections",e)]),a(".page-content .page-title",e).html(f.page.title),!f.page.title_translated&&a("body").data("translation-language")?a(".page-content .page-title",e).attr("data-translation-state","NEW"):f.page.title_translated&&a("body").data("translation-language")&&a(".page-content .page-title",e).removeAttr("data-translation-state"),a(".page-content > .sections",e).html(f.content),g.removeClass("hidden loading"),g.data("id",b),g.data("category-id",f.page.category_id),d.sandbox.addModules(a(".page-content > .sections",e)),f.page.empty?e.find(".page").addClass("page-empty"):e.find(".page").removeClass("page-empty"),e.data("editing")&&d.addEditorActions(),e.find(".js-o-header").hasClass("header-size-m")||e.find(".js-o-header").hasClass("header-size-l")?window.location&&window.location.hash&&window.location.hash.length>0&&window.scrollTo(0,e.find(".js-o-header").height()):window.scrollTo(0,0);var h=JSON.parse(localStorage.getItem("copyByReference"));h&&h.active&&(d.toggleCopyByReference("enable",h.block_id),d.toggleIndicators("copy-by-reference-enabled"),$block=e.find('.mod.block[data-block="'+h.block_id+'"]').find(".btn-copy-block-by-reference").addClass("state-active")),d.pusher&&d.pusher.channel("private-user-"+d.sandbox.getConfigParam("user")).bind("client-copy-by-reference",function(a){d.toggleIndicators("copy-by-reference-enabled"),"enabled"==a.state?d.toggleCopyByReference("enable",a.block):"disabled"==a.state&&d.toggleCopyByReference("disable")}),c()}}})},after:function(){var b=this,c=this.$ctx;if((c.data("editor")||c.data("translator"))&&b.initializeCommonEditor(),c.data("editor")&&b.initializeEditor(),b.enableSearch(),b.addEditorActions(),b.enableAppearanceSettings(),b.enablePatternSettings(),b.enablePasting(),b.enableStatsView(),c.on("focus",".nav-search input",function(d){var e=a(d.currentTarget);return e.hasClass("search-disabled")?(b.fire("openPayment",{feature:"STYLEGUIDE_SEARCH"},["events"]),!1):(a(".nav-tools .btn-toggle-editing",c).hide(),a(".nav-tools .btn-share",c).hide(),a(this).css("width","312px"),void Intercom("trackEvent","sg-focused-search",{}))}),c.on("focusout",".nav-search input",function(){a(".nav-tools .btn-toggle-editing",c).show(),a(".nav-tools .btn-share",c).show(),a(this).css("width","120px")}),c.data("editmode")&&(a(".btn-toggle-editing",c).trigger("click"),b.onEnableEditing()),0===window.location.hash.indexOf("#changelog")){var d=parseInt(window.location.hash.replace("#changelog-",""));d>0&&b.openChangelog(d)}},enableStatsView:function(){var b=(this.$ctx,a(".o-stats"));b.find(".settings-sections > div").on("click",function(c){return b.find(".settings-sections > div").removeClass("selected"),a(this).addClass("selected"),b.find(".settings-section").hide(),b.find('.settings-section[data-section="'+a(this).data("section")+'"]').show(),!1})},enablePatternSettings:function(){var b=this,c=this.$ctx,d=a(".pattern-settings",c),e=a(".resources-css",d).get(0),e=(Sortable.create(e,{handle:".btn-move-resource",ghostClass:"sortable-ghost",onStart:function(a){},onUpdate:function(b){var d=a(b.item).data("resource"),e=c.data("project"),f={sort:b.newIndex+1};a.ajax({url:"/api/project/resources/"+e+"/"+d,type:"POST",data:JSON.stringify(f),success:function(a){}})}}),a(".resources-js",d).get(0));Sortable.create(e,{handle:".btn-move-resource",ghostClass:"sortable-ghost",onStart:function(a){},onUpdate:function(b){var d=a(b.item).data("resource"),e=c.data("project"),f={sort:b.newIndex+1};a.ajax({url:"/api/project/resources/"+e+"/"+d,type:"POST",data:JSON.stringify(f),success:function(a){}})}});a(".btn-add-resource",d).on("click",function(){a(this).parent().find(".fld").focus()}),a(".resource-status",d).on("click",function(){if(!a(this).hasClass("icon-spinner")){var b=a(this).parent().prev(),d=b.data("type"),e=a(this).closest(".row-resource").find(".fld-resource-url").val();if(a(this).parent().hasClass("valid")){var f=c.data("project"),g=b.find(".row-resource").length,h={type:d,url:e,sort:g+1},i=a(this),j=a(this).closest(".row-resource-add");j.css("opacity",.8),i.find(".fa").addClass("icon-spinner icon-spin"),a.ajax({url:"/api/project/resources/"+f,type:"PUT",data:JSON.stringify(h),success:function(d){j.css("opacity",1);var e='<li class="row row-resource" data-resource="'+d.resource.id+'" data-url="'+d.resource.url+'">';e+='<div class="btn-move-resource"><i class="icon-bars"></i></div>',e+='<input class="fld fld-text fld-resource-url" type="text" placeholder="" value="'+d.resource.url+'" />',e+='<div class="btn-remove-resource"><i class="icon-trash"></i></div>',e+="</li>";var f=a(e);b.append(f),j.find(".fld").val(""),j.removeClass("valid"),i.find(".fa").removeClass("icon-spinner icon-spin");var g=a(".pattern iframe",c);a.each(g,function(a,b){b.contentDocument.location.reload(!0)})}})}}}),d.on("click",".btn-remove-resource",function(){var d=a(this).parent(),e=c.data("project"),f=d.data("resource");swal({title:"Are you sure?",text:"You are about to delete this external resource",type:"warning",showCancelButton:!0,confirmButtonColor:"#C93B3E",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){a.ajax({url:"/api/project/resources/"+e+"/"+f,type:"DELETE",success:function(e){if(e.success){d.remove();var f=a(".pattern iframe",c);a.each(f,function(a,b){b.contentDocument.location.reload(!0)}),b.fire("swal",{template:"c-swal-external-resource-deleted",type:"success"})}}})})}),d.find(".settings-sections > div").on("click",function(b){return d.find(".settings-sections > div").removeClass("selected"),a(this).addClass("selected"),d.find(".settings-section").hide(),d.find('.settings-section[data-section="'+a(this).data("section")+'"]').show(),!1}),d.on("keyup",".row-resource-add .fld-resource-url",function(){a(this).val()&&""!=a(this).val().trim()?a(this).parent().addClass("valid"):a(this).parent().removeClass("valid")}),d.on("blur",".resources .fld-resource-url",function(){var b=a(this).val();if(a(this).val()!=a(this).data("resource-url")){var d=a(this).closest(".row-resource").data("resource"),e=c.data("project"),f={url:b};a.ajax({url:"/api/project/resources/"+e+"/"+d,type:"POST",data:JSON.stringify(f),success:function(a){}})}}),d.find(".sel-css-precompiler li").on("click",function(){var b=a(this).data("value"),d=a(this).closest(".fld-sel");d.find("> span").text(a(this).text()),d.find(".dropdown").hide(),"NONE"==b?a('li[data-tab="code-editor-css"]').text("CSS"):a('li[data-tab="code-editor-css"]').text(b);var e={pattern_css_precompiler:b};a.ajax({url:"/api/project/update/"+c.data("project"),data:JSON.stringify(e),contentType:"application/json; charset=utf-8",method:"POST",success:function(b){if(b.success){var d=a(".pattern iframe",c);a.each(d,function(a,b){b.contentDocument.location.reload(!0)})}}})}),d.find(".sel-css-reset li").on("click",function(){var b=a(this).data("value"),d=a(this).closest(".fld-sel");d.find("> span").text(a(this).text()),d.find(".dropdown").hide();var e={pattern_css_reset:b};a.ajax({url:"/api/project/update/"+c.data("project"),data:JSON.stringify(e),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){if(b.success){var d=a(".pattern iframe",c);a.each(d,function(a,b){b.contentDocument.location.reload(!0)})}}})}),d.find(".fld-sel > span, .fld-sel > i").on("click",function(){a(this).parent().find(".dropdown").toggle()}),d.find(".fld-sel").on("click",function(a){a.stopPropagation()}),a("html").click(function(){d.find(".dropdown").hide(),c.find(".m-dropdown--language").hide()})},enableAppearanceSettings:function(){var b=this,c=this.$ctx,d=c.find(".appearance-settings"),e=c.find("header");d.on("mouseleave",function(){d.addClass("small")}),d.on("mouseenter",function(){d.removeClass("small")}),a(".fld-document-background-image",d).fileupload({dataType:"json",dropZone:a(".header-document-background-image",d),add:function(b,c){a(".header-document-background-image span",d).text(a(".header-document-background-image",d).data("txt-loading")),c.submit()},done:function(c,f){if(a(".header-document-background-image span",d).text(a(".header-document-background-image",d).data("txt-default")),f.result&&f.result[0]){var g={appearance:{background:{url:"/api/screen/thumbnail/"+f.result[0].hash}}};a.ajax({type:"POST",url:"/api/document/settings/"+b.document_id,data:JSON.stringify(g),success:function(b){b.success&&(e.data("overriden-background",!0),d.find(".header-document-background-image").data("url",g.appearance.background.url),e.css("backgroundImage","url("+g.appearance.background.url+")"),a(".header-document-background-image .preview",d).css("backgroundImage","url("+g.appearance.background.url+")"))}})}}}),a(".fld-header-background-image",d).fileupload({dataType:"json",dropZone:a(".header-background-image",d),add:function(b,c){a(".header-background-image span",d).text(a(".header-background-image",d).data("txt-loading")),c.submit()},done:function(b,f){if(a(".header-background-image span",d).text(a(".header-background-image",d).data("txt-default")),f.result&&f.result[0]){var g={appearance:{background:{url:"/api/screen/thumbnail/"+f.result[0].hash}}};a.ajax({url:"/api/hub/settings/"+c.data("hub"),data:JSON.stringify(g),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){b.success&&(d.find(".header-background-image").data("url",g.appearance.background.url),a(".header-background-image .preview",d).css("backgroundImage","url("+g.appearance.background.url+")"),e.data("overriden-background")||e.css("backgroundImage","url("+g.appearance.background.url+")"),e.attr("data-master-image",g.appearance.background.url))}})}}}),a(".settings-drawer .btn-close-settings",c).on("click",function(){a(".settings-drawer").removeClass("visible")})},enableEditing:function(){var b=this.$ctx,c=this;b.find(".nav-pages"),b.find(".nav-documents");a(".section-title",b).attr("contenteditable",!0),a(".page-title",b).attr("contenteditable",!0),a('.header-hero > [data-editable="true"]',b).attr("contenteditable",!0),
a('.nav-pages .category-title[data-editable="true"]',b).attr("contenteditable",!0),a(".document-nav .document-items .sub-item .title").attr("contenteditable",!0),a(".document-nav .document-items .sub-item .description").attr("contenteditable",!0),c.fire("enableEditing",{},function(){}),c.onEnableEditing({})},disableEditing:function(){var b=this,c=this.$ctx;a("[contenteditable]",c).removeAttr("contenteditable"),b.fire("disableEditing",{},function(){}),b.onDisableEditing({}),"?edit"==window.location.search&&(location.href=window.location.origin+window.location.pathname+window.location.hash),c.removeAttr("data-cut-block");var d=c.find(".btn-toggle-block-library");a.each(d,function(b,c){a(c).removeClass("cut-enabled"),a(c).find("i").removeClass("icon-long-arrow-right"),a(c).find("i").addClass("icon-plus")})},addEditorActions:function(){var b=this.$ctx,c=a(".page",b),d=(a("body").data("hub"),a(a("#add-block",b).text()));d.data("scope","page"),d.data("position","first"),c.find("section").first().prepend(d),d=d.clone(),d.data("scope","section"),d.data("position","first"),d.insertAfter(c.find(".section-title")),d=d.clone(),d.data("scope","unknown"),d.data("position","after"),d.insertAfter(c.find(".block"));var e=a('<div class="block-actions">                                    <a href="javascript:;" class="btn-copy-block-by-reference">                                        <i class="icon-copy"></i>                                    </a>                                    <a href="javascript:;" class="btn-cut-block">                                        <i class="icon-scissors"></i>                                    </a>                                    <a href="javascript:;" class="btn-delete-block">                                        <i class="icon-trash-o"></i>                                    </a>                                </div>');a(".block",b).append(e),a.each(c.find(".block"),function(b,c){if(a(c).data("help")){var d="sg-help-block";a(c).find(".block-actions").prepend('<a href="'+a(c).data("help")+'" target="_blank" onclick="Intercom(\'trackEvent\', \''+d+'\', {});" class="btn-help-block">                                                            <i class="icon-question"></i>                                                         </a>')}if(a(c).hasClass("referenced")){var e=a('<a href="javascript:;" class="btn-copy-block-by-reference-indicator"><i class="icon-link"></i></a>');a(c).find(".block-actions").append(e)}})},initializeCommonEditor:function(){var b=this,c=this.$ctx,d=c.find(".nav-pages"),e=c.find(".nav-documents");c.on("keypress",".page-content h2 input",function(b){return 13==b.keyCode?(a(this).trigger("blur"),!1):void 0}),d.on("keydown",".category-title",function(b){return 13===b.keyCode?(a(this).trigger("blur"),window.getSelection().removeAllRanges(),!1):27===b.keyCode?(a(this).text(a(this).attr("content-original")),a(this).blur(),window.getSelection().removeAllRanges(),!1):void 0}),d.on("focus",".category-title",function(b){a(this).attr("content-original",a(this).text())}),d.on("blur",".category-title",function(){var b=a(this),c=b.closest(".category"),d=c.data("category"),e={title:a(this).text()};return""==a(this).text()?(a(this).text(a(this).attr("content-original")),!1):(a("body").data("translation-language")&&(e.language=a("body").data("translation-language")),void a.ajax({url:"/api/document/category/"+d,data:JSON.stringify(e),type:"PATCH",success:function(b){b.success&&c.find(".item-link-internal a").each(function(){var c=a(this),d=c.attr("href").split("/").slice(2);d.unshift(b.href),c.attr("href",d.join("/"))})}}))}),c.on("blur",'.document-nav .sub-item > .title[data-editable="true"]',function(){var b=a(this).parent().data("document"),d=a(this).closest(".sub-item");if(d.hasClass("item-dirty"))return!1;var e={title:a(this).text()};return""==a(this).text()?(a(this).text(a(this).attr("content-original")),!1):(a("body").data("translation-language")&&(e.language=a("body").data("translation-language")),void a.ajax({url:"/api/hub/document/"+b,data:JSON.stringify(e),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){if(a.success){var f=c.find('.nav-documents .item[data-document="'+b+'"] > a'),g=f.prop("href").split("/");-1==g.indexOf("document")&&(g[g.length-1]=a.slug,f.prop("href",g.join("/")),d.find("a").prop("href",g.join("/"))),f.text(e.title)}}}))}),c.on("blur",'.document-nav .sub-item > .description[data-editable="true"]',function(){if(a(this).closest(".sub-item").hasClass("item-dirty"))return!1;var b={description:a(this).text()};a("body").data("translation-language")&&(b.language=a("body").data("translation-language")),a.ajax({url:"/api/hub/document/"+a(this).parent().data("document"),data:JSON.stringify(b),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success}})}),c.on("focus",'.item > a[data-editable="true"]',function(b){a(this).attr("content-original",a(this).text())}),e.on("keydown",'.item > a[data-editable="true"]',function(b){return 13!==b.keyCode||b.ctrlKey||b.metaKey?27===b.keyCode?(a(this).text(a(this).attr("content-original")),a(this).blur(),window.getSelection().removeAllRanges(),!1):void 0:(a(this).trigger("blur"),window.getSelection().removeAllRanges(),!1)}),c.on("focus",".page-title",function(b){a(this).attr("content-original",a(this).html())}),c.on("blur",".page-title",function(c){var f=a(this).parents(".page").data("id"),g=a(this).html(),h={title:g};return a(this).attr("content-original")==g?!1:""==g?(a(this).html(a(this).attr("content-original")),!1):(a("body").data("translation-language")&&(h.language=a("body").data("translation-language")),a.ajax({url:"/api/document/page/"+b.document_id+"/"+f,data:JSON.stringify(h),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){if(a.success)if(f>0){var c=d.find('.item[data-page="'+f+'"] > a');c.attr("href",a.href),c.html(h.title),location.href=a.href}else e.find('.item[data-document="'+b.document_id+'"] > a').html(h.title)}}),!1)}),c.on("keypress",".page-title",function(b){return 13!=b.keyCode||b.ctrlKey||b.metaKey?27!==b.keyCode||b.ctrlKey||b.metaKey?void 0:(a(this).html(a(this).attr("content-original")),a(this).trigger("blur"),window.getSelection().removeAllRanges(),!1):(a(this).trigger("blur"),window.getSelection().removeAllRanges(),!1)}),c.on("keypress",".section-title",function(b){return 13!=b.keyCode||b.ctrlKey||b.metaKey?void 0:(a(this).trigger("blur"),!1)}),c.on("blur",'.header-hero *[data-editable="true"]',function(b){var d=(a(this),a(this).data("field"));if(d){var e=a(this).text(),f={};f[d]=e,a("body").data("translation-language")&&(f.language=a("body").data("translation-language")),a.ajax({url:"/api/hub/settings/"+c.data("hub"),data:JSON.stringify(f),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success}})}}),c.on("keypress",'.header-hero *[data-editable="true"]',function(b){return 13!=b.keyCode||b.ctrlKey||b.metaKey?void 0:(a(this).trigger("blur"),window.getSelection().removeAllRanges(),!1)}),c.on("focus",".section-title",function(b){a(this).attr("content-original",a(this).text())}),c.on("blur",".section-title",function(b){var c=a(this),e=a(this).parents(".page").data("id"),f=a(this).data("id");if(""==c.text())return c.text(c.attr("content-original")),!1;var g={title:a(this).text()};return a("body").data("translation-language")&&(g.language=a("body").data("translation-language")),a.ajax({url:"/api/document/section/"+e+"/"+f,data:JSON.stringify(g),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success&&d.find('.item-section[data-id="'+f+'"] > a').text(g.title)}}),!1}),c.on("click",".document-actions",function(){var b=a(this).closest(".document-actions");return"true"==b.attr("data-open")?(b.find(".document-actions-dropdown").addClass("transparent"),setTimeout(function(){b.find(".document-actions-dropdown").addClass("hide")},300),b.attr("data-open",!1)):(b.find(".document-actions-dropdown").removeClass("hide"),setTimeout(function(){b.find(".document-actions-dropdown").removeClass("transparent")},20),b.attr("data-open",!0)),!1}),c.on("click",".document-nav",function(){var b=a(this).find('.document-actions[data-open="true"]');b.find(".document-actions-dropdown").addClass("transparent"),setTimeout(function(){b.find(".document-actions-dropdown").addClass("hide")},300),b.attr("data-open",!1)}),a(window).on("click",function(){var a=c.find(".document-nav .document-items");"true"==a.attr("data-move")&&(a.find(".drag-handle").addClass("hide"),a.find(".document-actions").show(),a.find(".document-actions-dropdown").addClass("hide"),a.find(".sub-item.add-document").toggle(),a.attr("data-move",!1))}),c.on("keypress",'.document-items .sub-item [contenteditable="true"]',function(b){return 13==b.keyCode?(a(this).trigger("blur"),!1):void 0}),c.on("click",".document-items .sub-item",function(){a("body").hasClass("editor-enabled")||(location.href=a(this).find(".title").attr("href"))})},initializeEditor:function(){var b=this,c=this.$ctx,d=c.find(".nav-pages"),e=c.find(".nav-documents");c.find(".document-sidebar");if(c.on("click",".btn-add-page",function(b){if(c.hasClass("editor-enabled")){if(d.find(".item-new").length<=0){var e=a(this).parent().find("> ul"),f=a('<li class="item item-new" data-category="'+a(this).closest(".category").data("category")+'"><a><input type="text" placeholder="Untitled Page" /></a><ul class="nav-sections"></ul><span class="drag-handle"><i class="fa fa-bars"></i></span><span class="control-page-visibility tt-left tt-small"data-tooltip="Visible for everyone"><i class="fa fa-eye"></i></span></li>');f.appendTo(e),f.find("input").focus()}else d.find(".item-new input").focus();return!1}}),c.on("click",".btn-add-category",function(e){if(c.hasClass("editor-enabled")){if(d.find(".item-category-new").length<=0){var f=(a(this).parent(),a('<div class="category"><h4 class="category-title item-category-new" data-editable="true" contenteditable="true"><input type="text" placeholder="Untitled Category" /></h4><div class="category-pages-container state-open"><ul class="category-pages" data-sortable="true"></ul><a class="ffy-lnk btn-add-page" href="javascript:;">Add Page</a><button class="btn-delete-category">Delete</button></div><span class="category-drag-handle"><i class="fa fa-bars"></i></span></div>'));a(this).closest(".nav-pages").find(".category-items").append(f),f.find("input").focus(),b.enableSorting(f.find(".category-pages").get(0),!0)}else d.find(".item-category-new input").focus();return!1}}),c.on("keyup",".nav-pages .item input",function(b){return a(this).val().length>0?a(this).closest(".category").find(".btn-add-page").removeClass("disabled"):a(this).closest(".category").find(".btn-add-page").addClass("disabled"),13==b.keyCode?(a(this).trigger("blur"),!1):void 0}),e.on("keydown",".item input",function(b){return 13==b.keyCode?(a(this).trigger("blur"),!1):void 0}),c.on("blur",".nav-pages .item-new input",function(){var d=a(this).parent().parent(),e=d.find("a"),f=a(this).val().trim();if(""!=f){a(this).remove(),e.text(f);var g=a('<i class="fa fa-circle-o-notch fa-spin"></i>');e.append(g);var h={page:{document:b.document_id,category:d.data("category"),title:f}};d.hasClass("item-new")&&(a(".page",c).addClass("loading"),a.ajax({url:"/api/document/pages",data:JSON.stringify(h),contentType:"application/json; charset=utf-8",type:"POST",success:function(f){f.success&&(a(".page",c).addClass("hidden"),e.attr("href",f.page.href),d.attr("data-page",f.page.id),location.href=f.page.href,b.open(f.page.id,function(){}),d.removeClass("item-new"),g.removeClass("fa-spin fa-circle-o-notch").addClass("fa-check-circle"),setTimeout(function(){g.fadeOut(function(){g.remove()}),a(".page",c).removeClass("hidden loading")},500),Intercom("trackEvent","sg-added-page",{}))}})),d.hasClass("item-dirty")&&d.removeClass("item-dirty")}else d.remove()}),d.on("blur",".item-category-new input",function(){var c=a(this).parent(),d=a(this).val().trim(),e=a(this);if(""!=d){var f={document:b.document_id,title:d};c.hasClass("item-category-new")&&a.ajax({url:"/api/document/categories",data:JSON.stringify(f),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success&&(c.addClass("category-title"),c.removeClass("item-category-new"),c.removeClass("disabled"),c.parents(".category").data("category",a.category.id),e.remove(),c.text(a.category.title),c.closest(".category-title-container").find("i").removeClass("state-hidden"),Intercom("trackEvent","sg-added-category",{}))}})}else c.closest(".category").remove()}),e.on("blur",".item input",function(){var d=a(this).parent().parent(),e=d.find("a"),f=a(this).val().trim();if(""!=f){a(this).remove(),e.text(f);var g=a('<i class="fa fa-circle-o-notch fa-spin"></i>');e.append(g);var h={document:{hub:b.hub_id,title:f}};d.hasClass("item-new")&&(a(".page",c).addClass("loading"),a.ajax({url:"/api/hub/documents",data:JSON.stringify(h),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){b.success&&(a(".page",c).addClass("hidden"),a(".nav-documents",c).data("items",a(".nav-documents .item",c).length),e.attr("href",b.document.href),d.attr("data-document",b.document.id),location.href=b.document.href,d.removeClass("item-new"),g.removeClass("fa-spin fa-circle-o-notch").addClass("fa-check-circle"),setTimeout(function(){g.fadeOut(),a(".page",c).removeClass("hidden loading")},500))}})),d.hasClass("item-dirty")&&d.removeClass("item-dirty")}}),c.on("click",".control-page-visibility",function(c){var d=a(this),e=d.parent(".item").data("page"),f=d.find("i"),g=!1,h=d.data("visible-to-all");f.hasClass("icon-eye")?(g=!0,h=d.data("visible-to-editor-text"),f.removeClass("icon-eye").addClass("icon-eye-slash")):f.removeClass("icon-eye-slash").addClass("icon-eye"),d.attr("data-tooltip",h);var i={visibility:g?"editor":"everyone"};a.ajax({url:"/api/document/page/"+b.document_id+"/"+e,type:"POST",data:JSON.stringify(i),success:function(a){}})}),c.on("click",function(d){b.adding&&(c.find(".block-library.visible").removeClass("visible"),a(".add-block",c).addClass("hidden"),b.adding=!1)}),c.on("click",".btn-toggle-block-library",function(d){var e=a(this);if(e.hasClass("cut-enabled")){var f,g=c.attr("data-cut-block");if(g>0){var h=b.block_clipboard,i=a(this).closest(".page").data("id"),j=a(this).closest("section").data("id");e.parent().after(h),b.sandbox.addModules(h),h.removeClass("cut-enabled");var k=h.closest(".page").find(".add-block:first");h.after(k.clone().data("position","after"));var l=a(this).closest("section").find(".mod.block");a.each(l,function(b,c){a(c).data("block")==g&&(f=b)});var m={sort:f+1};a.ajax({url:"/api/document/block/"+i+"/"+j+"/"+g,data:JSON.stringify(m),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success&&(b.toggleIndicators("cut-enabled"),c.removeAttr("data-cut-block"))}})}}else if(e.hasClass("copy-by-reference-enabled")){var g=c.attr("data-copy-block-by-reference"),n=a(b.tpl.render("duplicate",{}));b.sandbox.addModules(n),b.fire("copyBlockByReference",{block:g,position:e},function(){b.toggleCopyByReference("disable"),b.toggleIndicators("copy-by-reference-enabled"),b.pusher&&b.pusher.channel("private-user-"+b.sandbox.getConfigParam("user")).trigger("client-copy-by-reference",{state:"disabled",block:g})})}else if($library=e.parent().find(".block-library"),$library.hasClass("visible"))$library.removeClass("visible"),e.parent().addClass("hidden"),b.adding=!1;else{c.find(".block-library.visible").removeClass("visible"),a(".add-block",c).not(e.parent()).addClass("hidden"),$library.addClass("visible"),e.parent().removeClass("hidden");var o=a(window).scrollTop(),p=o+a(window).height(),q=$library.offset().top,r=q+$library.height(),s=p>=r&&q>=o;if(!s){var t=r-p+40;a("html, body").animate({scrollTop:o+t},200)}b.adding=!0}return!1}),c.on("click",".block-library-item",function(e){var f=a(this),g=f.parents(".add-block"),h=a(this).parents("section"),i=a(this).parents(".page").data("id"),j=0;h&&h.data("id")>0?(j=h.data("id"),g.data("scope","section")):g.data("scope","page");var k={block_type:f.data("block-type"),scope:g.data("scope"),position:g.data("position"),block:g.prev().data("block")};return a.ajax({url:"/api/document/block/"+i+"/"+j,data:JSON.stringify(k),contentType:"application/json; charset=utf-8",type:"POST",success:function(e){if(e.success){c.find(".page").removeClass("page-empty"),g.find(".block-library").removeClass("visible");var f=a(e.block.content),h=a(a("#add-block",c).text());if(h.data("scope",k.scope),h.data("position","after"),"section"==k.block_type)f.insertAfter(g.parent()),h.insertAfter(f.find("> .section-title")),g.nextAll().appendTo(f);else{f.insertAfter(g);var j=a('<div class="block-actions">                                                            <a href="javascript:;" class="btn-copy-block-by-reference">                                                                <i class="icon-copy"></i>                                                            </a>                                                            <a href="javascript:;" class="btn-cut-block">                                                                <i class="icon-scissors"></i>                                                            </a>                                                            <a href="javascript:;" class="btn-delete-block">                                                                <i class="icon-trash-o"></i>                                                            </a>                                                        </div>');if(f.append(j),f.data("help")){var l="sg-help-block";f.find(".block-actions").prepend('<a href="'+f.data("help")+'" target="_blank" onclick="Intercom(\'trackEvent\', \''+l+'\', {});" class="btn-help-block">                                                                            <i class="icon-question"></i>                                                                          </a>')}h.insertAfter(f);b.sandbox.addModules(f)}switch(k.block_type){case"code":break;case"section":var m=f.find("> .section-title"),n=a('<li class="item-section" data-id="'+f.data("id")+'"><a href="#">'+m.text()+"</a></li>"),o=g.parent().data("id");o>0?n.insertAfter(d.find('.item[data-page="'+i+'"] .nav-sections .item-section[data-id="'+o+'"]')):d.find('.item[data-page="'+i+'"] .nav-sections').prepend(n),m.attr("contenteditable",!0),m.focus(),h.data("scope","section"),h.data("position","first");var p,q;window.getSelection&&document.createRange?(q=document.createRange(),q.selectNodeContents(m.get(0)),p=window.getSelection(),p.removeAllRanges(),p.addRange(q)):document.body.createTextRange&&(q=document.body.createTextRange(),q.moveToElementText(m.get(0)),q.select());break;case"callout":f.find(".callout").focus();break;case"text":f.find(".richtext").focus()}Intercom("trackEvent","sg-added-block",{document_id:b.document_id,block_type:k.block_type}),Intercom("trackEvent","sg-added-block-"+k.block_type,{})}}}),!1}),c.on("click",".btn-delete-block",function(c){var d=a(this).parents(".block"),e=a(this),f=d.data("block");return swal({title:"Are you sure?",text:"You are about to delete this content block",type:"warning",showCancelButton:!0,confirmButtonColor:"#C93B3E",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){a.ajax({url:"/api/document/block/"+f,type:"DELETE",success:function(c){if(c.success)d=a('.block[data-block="'+f+'"]'),d.next().hasClass("add-block")&&d.next().remove(),d.remove(),e.remove(),b.fire("swal",{template:"c-swal-block-deleted",type:"success"}),b.data.updateStorageUsage(!0);else if(c.referenced){var g='<ul class="a-rf-list">';a.each(c.reference_list,function(a,b){g+='<li class="a-rf-list__item">'+b.title+'<a href="'+b.link+'" target="_blank"><i class="icon-external-link"></i></a></li>'}),g+="</ul>",swal({allowOutsideClick:!0,html:!0,title:"Error!",text:"This block has been referenced "+c.reference_count+" time(s) in other styleguides: "+g,type:"error"})}}})}),!1}),c.on("click",".btn-cut-block",function(){var d=a(this).closest(".mod.block");c.attr("data-cut-block")?(c.removeAttr("data-cut-block"),d.removeClass("cut-enabled"),b.toggleIndicators("cut-enabled")):(c.attr("data-cut-block",d.data("block")),b.block_clipboard=d,d.addClass("cut-enabled"),b.toggleIndicators("cut-enabled"))}),c.on("click",".btn-copy-block-by-reference",function(){a(this).toggleClass("state-active");var d=a(this).closest(".mod.block"),e=d.data("block"),f="enabled";b.toggleIndicators("copy-by-reference-enabled"),c.attr("data-copy-block-by-reference")?(f="disabled",b.toggleCopyByReference("disable")):b.toggleCopyByReference("enable",e),b.pusher&&b.pusher.channel("private-user-"+b.sandbox.getConfigParam("user")).trigger("client-copy-by-reference",{state:f,block:e})}),c.on("click",".btn-delete-section",function(c){var e=a(this).parents("section"),f=a(this).parents(".page").data("id"),g=e.data("id");return swal({title:"Are you sure?",text:"You are about to delete this section",type:"warning",showCancelButton:!0,confirmButtonColor:"#C93B3E",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){a.ajax({url:"/api/document/section/"+f+"/"+g,type:"DELETE",success:function(a){if(a.success){var c=e.prev("section");e.find(".add-block:first").nextAll().appendTo(c),e.remove(),d.find('.item-section[data-id="'+g+'"]').remove(),b.fire("swal",{template:"c-swal-section-deleted",type:"success"})}}})}),!1}),c.on("click",".btn-move-document",function(b){var c=a(this).closest(".document-items");return"true"==c.attr("data-move")?c.find(".sub-item.add-document").toggle():(c.find(".document-actions").hide(),c.find(".document-actions-dropdown").addClass("hide"),c.find(".drag-handle").removeClass("hide"),c.find(".sub-item.add-document").toggle(),c.attr("data-move",!0)),!1}),a(".btn-add-document",c).on("click",function(c){var d={},e=a(this).closest(".sub-item.add-document"),f=a(b.tpl.render("document-item",d));e.before(f),f.find(".title").focus()}),c.on("blur",'.document-items .sub-item.item-dirty [contenteditable="true"]',function(){var d=a(this).closest(".sub-item.item-dirty").find(".title").text(),e=a(this).closest(".sub-item.item-dirty").find(".description").text(),f=a(this).closest(".sub-item.item-dirty"),g=a("body").attr("data-document-count");if(0==d.length)return!1;a("body").focus();var h={document:{hub:b.hub_id,title:d,description:e}};a.ajax({url:"/api/hub/documents",data:JSON.stringify(h),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){b.success&&(f.attr("data-document",b.document.id),f.find(".title").attr("href","/document/"+b.document.id),f.removeClass("item-dirty"),f.find(".document-actions").removeClass("disabled"),a("body").attr("data-document-count",parseInt(g)+1),c.find(".nav-documents").removeClass("hide"),a("body").attr("data-document-count")<=a("body").attr("data-navigation-max-items")&&"dropdown"!=a("body").attr("data-navigation-mode")&&c.find(".nav-documents .document-items").append('<li class="item item-link-internal" data-title="'+d+'" data-document="'+b.document.id+'"><a href="/document/'+b.document.id+'" data-editable="true">'+d+"</a></li>"),c.find(".ffy-lnk.btn-move-page").removeClass("state-hide"))}})}),c.on("click",".btn-delete-document",function(d){var e=a(this).closest(".sub-item"),f=e.attr("data-document"),g=a("body").attr("data-document-count");return 1==g&&b.document_id==f?swal({title:"Are you sure?",text:'You\'re going to delete your last document. <b style="color: #000;">This action will delete your Style Guide completely</b>. Continue?',type:"warning",html:!0,showCancelButton:!0,confirmButtonColor:"#C93B3E",confirmButtonText:"Yes, delete this Style Guide!",closeOnConfirm:!0},function(b){b&&a.ajax({url:"/api/hub/delete/"+hub_id,type:"DELETE",success:function(a){a.success?(Intercom("trackEvent","sg-hook-delete-styleguide",{}),location.href="/"):alert(a.error)}})}):swal({title:"Are you sure?",text:"You are about to delete this document and <b>ALL</b> of its pages.",type:"warning",html:!0,showCancelButton:!0,confirmButtonColor:"#C93B3E",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){a.ajax({url:"/api/hub/document/"+f,type:"DELETE",success:function(d){d.success&&(e.remove(),b.document_id==f&&(location.href="/hub/"+c.data("hub")),c.find('.nav-documents .item[data-document="'+f+'"]').remove(),a("body").attr("data-document-count",parseInt(g)-1),parseInt(g)-1==1&&(c.find(".nav-documents").addClass("hide"),c.find(".ffy-lnk.btn-move-page").addClass("state-hide")),b.fire("swal",{template:"c-swal-document-deleted",type:"success"}))}})}),!1}),a(".btn-delete-page",c).on("click",function(c){var e=a(this).parents(".page").data("id");return swal({title:"Are you sure?",text:"You are about to delete this page and <b>ALL</b> of its contents.",type:"warning",html:!0,showCancelButton:!0,confirmButtonColor:"#C93B3E",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){a.ajax({url:"/api/document/page/"+b.document_id+"/"+e,type:"DELETE",success:function(a){a.success&&(location.href="/document/"+b.document_id+"?edit",d.find('.item[data-page="'+e+'"]').remove(),b.fire("swal",{template:"c-swal-page-deleted",type:"success"}))}})}),!1}),a(".btn-move-page",c).on("click",function(d){var e=[],f=c.find(".document-nav").find(".sub-item");a.each(f,function(b,c){var d=a(c);return d.attr("data-title")?"DEFAULT"!==d.attr("data-mode")?!1:void(d.data("document")!=a(".mod-document").data("document")&&e.push({document_id:d.attr("data-document"),document_title:d.attr("data-title")})):!1});var g=b.tpl.render("pagemove",{documents:e});b.fire("openModal",{$content:g},["events"])}),d.on("click",".btn-delete-category",function(d){var e=a(this).closest(".category"),f=e.data("category"),g=e.find("ul li").length;return g>0?(swal({title:"Delete Category",text:"There are still pages in this category, please delete them first.",type:"error",showCancelButton:!1,confirmButtonColor:"#C93B3E",confirmButtonText:"Ok",closeOnConfirm:!0}),!1):c.hasClass("editor-enabled")?(swal({title:"Are you sure?",text:"You are about to delete this category and all of its pages.",type:"warning",showCancelButton:!0,confirmButtonColor:"#C93B3E",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){a.ajax({url:"/api/document/category/"+f,type:"DELETE",success:function(d){if(d.success&&(e.remove(),b.fire("swal",{template:"c-swal-category-deleted",type:"success"}),a(".page",c).data("category-id")==f)){var g=a(".nav-pages",c).find(".item[data-page]:first").data("page");b.open(g,function(){})}}})}),!1):void 0}),c.data("editing")){var f=d.find('[data-sortable="true"]');a.each(f,function(a,c){b.enableSorting(c,!1)});var g=c.find(".document-nav .document-items");a.each(g,function(a,c){b.enableSorting(c,!1)})}},disableDnd:function(){a("body").on("dragstart",function(){return!1}).on("drop",function(){return!1})},enableDnd:function(){a("body").on("dragstart",function(){return!0}).on("drop",function(){return!0})},enableSorting:function(b,c){var d=(this.$ctx,this),e=a(b).attr("class").split(" ");"category-pages"==e[0]||"uncategorized-pages"==e[0]?d.sortables.pages.push(Sortable.create(b,{group:"pages",handle:".drag-handle",draggable:".item",forceFallback:!0,animation:150,disabled:!c,onStart:function(c){a(b).addClass("state-dragging"),d.disableDnd(),d.category_source=a(c.item).closest(".category").find(".category-title").html(),d.category_source=d.category_source.trim().toLowerCase()},onEnd:function(c){a(b).removeClass("state-dragging"),d.enableDnd()},onAdd:function(b){var c=a(b.item).data("page"),e=a(b.item).closest(".category").data("category"),f=window.location.hash;f="/"==f.substring(f.length-1,f.length)?f.substring(0,f.length-1):f;var g=a(b.item).closest(".category").find(".category-title").html(),h=a(b.item).find("a").html();h=h.trim().toLowerCase(),g&&(g=g.trim().toLowerCase()),moved_page="#/"+d.category_source+"/"+h,f==moved_page?g?location.href="#/"+g+"/"+h:location.href="#/"+h:g?a(b.item).find("a").attr("href","#/"+g+"/"+h):a(b.item).find("a").attr("href","#/"+h),"undefined"==typeof e&&(e=0);var i={sort:b.newIndex+1,category:e};a.ajax({url:"/api/document/page/"+d.document_id+"/"+c,type:"POST",data:JSON.stringify(i),success:function(a){}})},onUpdate:function(b){var c=a(b.item).data("page"),e={sort:b.newIndex+1};a.ajax({url:"/api/document/page/"+d.document_id+"/"+c,type:"POST",data:JSON.stringify(e),success:function(a){}})}})):"category-items"==e[0]?d.sortables.categories=Sortable.create(b,{group:"categories",handle:".category-drag-handle",draggable:".category",animation:150,forceFallback:!0,disabled:!0,onStart:function(c){a(b).addClass("state-dragging"),d.disableDnd()},onEnd:function(c){a(b).removeClass("state-dragging"),d.enableDnd()},onUpdate:function(b){var c=a(b.item).data("category"),e={sort:b.newIndex+1};a.ajax({url:"/api/document/category/"+d.document_id+"/"+c,type:"POST",data:JSON.stringify(e),success:function(a){}})}}):"document-items"==e[0]&&(d.sortables.documents=Sortable.create(b,{group:"documents",draggable:".sub-item",handle:".drag-handle",forceFallback:!0,animation:150,onStart:function(a){d.disableDnd()},onEnd:function(a){d.enableDnd()},onUpdate:function(b){var c=a(b.item).data("document"),d={sort:b.newIndex+1};a.ajax({url:"/api/hub/document/"+c,type:"POST",data:JSON.stringify(d),success:function(a){}})}}))},onEnableEditing:function(b){a.each(this.sortables,function(b,c){c.length?a.each(c,function(a,b){b.option("disabled",!1)}):"function"==typeof c.option&&c.option("disabled",!1)})},onDisableEditing:function(b){a.each(this.sortables,function(b,c){c.length?a.each(c,function(a,b){b.option("disabled",!0)}):"function"==typeof c.option&&c.option("disabled",!0)})},parseColor:function(a){return tinycolor(a)},enablePasting:function(){var a=this,b=this.$ctx;b.on("paste","*[contenteditable]",function(b){b.preventDefault();var c=b.originalEvent||b,d="";window.clipboardData&&window.clipboardData.getData&&(d=window.clipboardData.getData("Text")),c.clipboardData&&c.clipboardData.getData&&(d=c.clipboardData.getData("text/plain")),a.pasteHtmlAtCaret(d)})},pasteHtmlAtCaret:function(a){var b,c;if(window.getSelection){if(b=window.getSelection(),b.getRangeAt&&b.rangeCount){c=b.getRangeAt(0),c.deleteContents();var d=document.createElement("div");d.innerHTML=a;for(var e,f,g=document.createDocumentFragment();e=d.firstChild;)f=g.appendChild(e);c.insertNode(g),f&&(c=c.cloneRange(),c.setStartAfter(f),c.collapse(!0),b.removeAllRanges(),b.addRange(c))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(a)},urlPrompt:function(a){var b=prompt("Enter a url","http://");a(/^((http|https)...)/.test(b)?b:"http://"+b)},onBlockReady:function(b){var c=this.$ctx,d=this;if(0==d.block_loading_state.length&&a.each(c.find(".mod.block"),function(b,c){(a(c).hasClass("b-image")||a(c).hasClass("b-imagegrid")||a(c).hasClass("b-annotations")||a(c).hasClass("b-annotations")||a(c).hasClass("b-pattern"))&&d.block_loading_state.push(a(c).data("block"))}),a.each(d.block_loading_state,function(a,c){if(b.block==c){var e=d.block_loading_state.indexOf(c);e>-1&&d.block_loading_state.splice(e,1)}}),0==d.block_loading_state.length&&!isNaN(a("body").data("scrollTo"))){var e=a("body").data("scrollTo");window.scrollTo(0,a('section[data-id="'+e+'"]').offset().top-40),a("body").data("scrollTo","undefined")}},openPaymentModal:function(a){this.fire("openPayment",{feature:a})},handleCodeSnippets:function(b){var c=this.$ctx,d=1;if("initial"==b)a("body").hasClass("code-enabled")?(a("body").addClass("code-enabled"),c.find(".btn-hide-codesnippets").text("Hide Code Snippets"),c.find(".b-typofonts .code, .b-typofonts .font-usage").addClass("visible")):(a("body").removeClass("code-enabled"),c.find(".btn-hide-codesnippets").text("Show Code Snippets"),c.find(".b-typofonts .code.visible, .b-typofonts .font-usage.visible").removeClass("visible"),d=0);else{a("body").hasClass("code-enabled")?(a("body").removeClass("code-enabled"),c.find(".btn-hide-codesnippets").text("Show Code Snippets"),
c.find(".b-typofonts .code.visible, .b-typofonts .font-usage.visible").removeClass("visible"),d=0):(a("body").addClass("code-enabled"),c.find(".btn-hide-codesnippets").text("Hide Code Snippets"),c.find(".b-typofonts .code, .b-typofonts .font-usage").addClass("visible"));var e={settings:{styleguide:{code_snippets:d}}};a.ajax({url:"/api/user/setting/",type:"POST",data:JSON.stringify(e),success:function(a){}})}},toggleIndicators:function(b){var c=a("body").find(".btn-toggle-block-library");a.each(c,function(c,d){a(d).toggleClass(b),a(d).find("i").toggleClass("icon-plus"),a(d).find("i").toggleClass("icon-long-arrow-right")})},toggleCopyByReference:function(a,b){var c=this.$ctx;if("disable"==a)c.removeAttr("data-copy-block-by-reference"),localStorage.removeItem("copyByReference"),c.find(".mod.block").find(".btn-copy-block-by-reference").removeClass("state-active");else{c.attr("data-copy-block-by-reference",b);var d={active:!0,block_id:b};localStorage.setItem("copyByReference",JSON.stringify(d))}},setNavigationSticky:function(b){var c=this.$ctx,d=!1;"enabled"==c.attr("data-sticky")?d=!0:"enabled"==c.attr("data-sticky")?d=!1:"undefined"==typeof c.attr("data-sticky")&&(c.find(".js-o-header").hasClass("header-size-m")||c.find(".js-o-header").hasClass("header-size-l"))&&(d=!0);var e=c.find(".document-sidebar");if(d&&e.length>0){var f=e.offset().top,g=function(){var b=a(window).scrollTop();b>=f?e.addClass("sticky"):e.removeClass("sticky")};g(),a(window).scroll(function(){g()})}else a(window).unbind("scroll")},createProject:function(){var b=this.sandbox.getConfigParam("context").brand;this.data.get("/api/project/initialize/"+b.id).then(function(c){if(c.create_workspace){var d=a(this.tpl.render("c-createproject",a.extend(!0,{},c,{brand:b})));this.fire("openModal",{modifier:"default",$content:d},["events"])}else if(c.workspace_trial_not_started)this.fire("showTrialStart",{type:"workspace",product:"WORKSPACE"});else if(c.workspace_trial_expired)this.fire("showTrialEnd",{type:"workspace"});else if(c.workspace_trial_expired_no_perm||c.workspace_trial_not_started_no_perm){var d=a(this.tpl.render("requestupgrade-modal-workspace",{owner_name:c.owner_name,owner_mail:c.owner_mail}));this.fire("openModal",{modifier:"default",$content:d},["events"])}}.bind(this))},openChangelog:function(a){var b=this.tpl.render("changelog",{id:a});this.fire("openModal",{$content:b,closeable:!1})},onUpdateHubHeading:function(b){a(".header-hero .title",this.$ctx).text(b.heading)},onUpdateHubSubheading:function(b){a(".header-hero p",this.$ctx).text(b.subheading)},onUpdateHubTitle:function(a){}})}(Tc.$),function(a){Tc.Module.Export=Tc.Module.extend({on:function(a){var b=this.$ctx;this.sandbox.subscribe("events",this),this.data=this.sandbox.getConfigParam("data"),b.on("click",".js-o-export__team",function(a){a.preventDefault(),this.fire("closeModal",["events"]),this.fire("openTeamSettings",["events"])}.bind(this)),b.on("click",".js-o-export__print",function(a){a.preventDefault(),Intercom("trackEvent","sg-hook-show-printview",{}),window.open("?print=all","","height=1200,width=900")}.bind(this)),b.on("click",".js-o-export__upgrade-public-sharing",function(a){this.fire("openPayment",{feature:"STYLEGUIDE_PUBLIC_SHARING"})}.bind(this));var c=new Tc.Module.CSettings(b,this.sandbox),d=c.getSetting("public_link_enabled");d.saved=function(a){var c=b.find(".js-o-export__public-link");this.data.post("/api/hub/settings/"+a.id,{public_link_enabled:a.public_link_enabled}).then(function(a){var c=this.sandbox.getModuleById(b.find(".mod-c-copylink").data("terrificId"));c.setValue(a.share_url)}.bind(this)),a.public_link_enabled?c.removeClass("state-hidden"):c.addClass("state-hidden")}.bind(this),a()}})}(Tc.$),function(a){Tc.Module.Medialibrary=Tc.Module.extend({on:function(b){var c=this.$ctx;this.tpl=this.sandbox.getConfigParam("tpl"),this.data=this.sandbox.getConfigParam("data"),this.$form=c.find(".js-o-medialibrary__form"),this.$assets=c.find(".js-o-medialibrary__asset-list"),this.document=a("body").data("document"),this.filterData={},this.sandbox.subscribe("events",this),this.render(),c.on("click",".js-o-medialibrary__filter-selected",function(b){b.stopPropagation();var d=(a(b.currentTarget),c.find(".js-o-medialibrary__filter-menu"));d.hasClass("state-open")?d.removeClass("state-open"):d.addClass("state-open")}.bind(this)),c.on("click",".js-o-medialibrary__filter-menu",function(a){a.stopPropagation()}.bind(this)),a("body").on("click.medialibrary",function(a){c.find(".js-o-medialibrary__filter-menu").removeClass("state-open")}.bind(this)),c.on("change",".js-o-medialibrary__filter-radio",function(b){a(b.currentTarget);this.search()}.bind(this)),c.on("submit",".js-o-medialibrary__form",function(a){a.preventDefault(),this.search()}.bind(this)),c.on("click",".js-o-medialibrary__asset-item",function(b){b.stopPropagation();var c="/document/"+this.document+"/show/"+a(b.currentTarget).data("o-viewer-hash");page(c)}.bind(this)),b()},after:function(){page("/document/:id/show/:hash",function(a,b){this.showViewer(a)}.bind(this)),page()},render:function(){this.$ctx;this.data.get("/api/filters/"+this.document).then(function(b){var c=a.deparam(window.location.search.substring(1));this.filterData=b.data,this.$form.html(this.tpl.render("medialibrary-filters",{filterData:this.filterData,filters:this.processFilters(c)})),-1===window.location.pathname.indexOf("/show/")?this.search():this.search(!0)}.bind(this))},search:function(b){var c=this.data.serializeForm(this.$form),d=this.$ctx,e=!1;""===c.q&&""===c.presets&&(c.limit=25,e=!0);var f=a.param(c);c=this.processFilters(c),d.find(".js-o-medialibrary__filter-selected").html(this.tpl.render("medialibrary-filter-label",{filterCount:c.filterCount})),b||history.pushState(null,null,"/document/"+this.document+"/?"+f),this.data.get("/api/assets/search/"+this.document+"/?"+f).then(function(a){a.success&&(a.data.length>0?(e&&this.shuffle(a.data),this.$assets.html(this.tpl.render("medialibrary-results",a.data)),this.$assets.flexImages({container:".js-o-medialibrary__asset-item",rowHeight:250,truncate:!1})):this.$assets.html("No results found."))}.bind(this))},onViewerClosed:function(){history.pushState(null,null,"/document/"+this.document+"/")},onViewerAssetChange:function(a){var b="/document/"+this.document+"/show/"+a.hash;history.pushState(null,null,b)},shuffle:function(a){var b,c,d;for(d=a.length;d;d--)b=Math.floor(Math.random()*d),c=a[d-1],a[d-1]=a[b],a[b]=c},getViewerInfo:function(b,c){var d=a.extend({},c,{show_download_sizes:!0});return d},showViewer:function(a){var b=this.$ctx;this.document=a.params.id,this.fire("showAssetInViewer",{$ctx:b,hash:a.params.hash})},processFilters:function(b){var c=b.presets?b.presets.split(","):[];b.presets=this.filterData.presets.items.map(function(b){return b.checked=-1!==a.inArray(b.key,c),b});var d=b.filetypes?b.filetypes.split(","):[];b.filetypes=this.filterData.filetypes.items.map(function(b){return b.checked=-1!==a.inArray(b.key,d),b});var e=b.orientations?b.orientations.split(","):[];return b.orientations=this.filterData.orientations.items.map(function(b){return b.checked=-1!==a.inArray(b.key,e),b}),b.filterCount=this.getFilterCount(b),b},getFilterCount:function(a){var b=a.presets.filter(function(a){return a.checked}).length;return b+=a.filetypes.filter(function(a){return a.checked}).length,b+=a.orientations.filter(function(a){return a.checked}).length}})}(Tc.$),function(a){Tc.Module.Share=Tc.Module.extend({on:function(b){var c=this.$ctx;this.tpl=this.sandbox.getConfigParam("tpl"),this.data=this.sandbox.getConfigParam("data"),this.account=this.sandbox.getConfigParam("account"),this.sandbox.subscribe("events",this);var d=a(".mod-document").data("hub");this.data.get("/api/hub/settings/"+d).then(function(a){this.info=a,c.html(this.tpl.render("share-settings",a)),this.sandbox.addModules(c.find(".js-o-share__container")),this.settings=new Tc.Module.CSettings(c,this.sandbox);var b=this.settings.getSetting("title");b.saved=function(a){this.fire("updateHubTitle",{title:a.title})}.bind(this);var d=this.settings.getSetting("heading");d.saved=function(a){this.fire("updateHubHeading",{heading:a.heading})}.bind(this);var e=this.settings.getSetting("description");e.saved=function(a){this.fire("updateHubSubheading",{subheading:a.description})}.bind(this);var f=this.settings.getSetting("cname");f.saved=function(b){this.data.post("/api/hub/settings/"+a.hub.id,b).then(function(a){a.success?-1!=b.cname.indexOf(".frontify.com")||this.account.isEnterprise()?c.find(".js-co-settings__domain-info").empty():c.find(".js-co-settings__domain-info").html(this.tpl.render("c-settingsdomain-info",{domain:b.cname,cname:"domains.frontify.com"})):f.showErrors(a.errors)}.bind(this))}.bind(this);var g=this.settings.getSetting("delete_styleguide");g.deleted=function(a){location.href="/"}.bind(this)}.bind(this))}})}(Tc.$),function(a){Tc.Module.Stats=Tc.Module.extend({on:function(b){this.sandbox.subscribe("events",this),this.data=this.sandbox.getConfigParam("data"),this.range="page",this.period="day",this.viewerChart=null,this.visitorChart=null,this.barBackgroundColor="#5FC8D7",this.barAlternativeBackgroundColor="#02546E",this.barHoverColor="#55B3C1",this.fontColor="rgba(57,64,77,0.5)",this.scaleOptions={xAxes:[{stacked:!0,gridLines:{display:!1},ticks:{fontColor:this.fontColor},scaleLabel:{fontColor:this.fontColor}}],yAxes:[{stacked:!0,gridLines:{color:"rgba(0,0,0,0.05)"},ticks:{beginAtZero:!0,fontColor:this.fontColor},scaleLabel:{fontColor:this.fontColor}}]};var c=this.$ctx;c.on("click",".js-o-stats__range",function(b){var d=a(b.currentTarget),e=d.data("range");this.range!=e&&(this.range=e,c.find(".js-o-state__range-value").text(d.text()),this.render())}.bind(this)),c.on("click",".js-o-stats__period-toggle",function(b){var d=a(b.currentTarget);d.data("period")!==this.period&&(this.period=d.data("period"),c.find(".js-o-state__context-value").text(d.text()),this.render())}.bind(this)),b()},after:function(){},render:function(){var a=this.sandbox.getConfigParam("context");this.setContextTitle(a),this.data.get("/api/stats/page/"+a.project.id+"/"+a.pageId+"/?filter="+this.period+"&range="+this.range).then(function(a){a.success&&(a.chart_data.length>0&&this.drawCharts(a.chart_data),a.today_data&&this.updateNumbers(a.today_data))}.bind(this))},drawCharts:function(a){for(var b=[],c=[],d=0;d<a.length;d++)c.push(parseInt(a[d].total_views)),b.push(a[d].label);null===this.viewerChart?this.viewerChart=this.createViewerChart(c,b):this.updateViewerChart(c,b),b=[];for(var e=[],f=[],d=0;d<a.length;d++)e.push(parseInt(a[d].anonymous_visitors)),f.push(parseInt(a[d].loggedin_visitors)),b.push(a[d].label);null===this.visitorChart?this.visitorChart=this.createVisitorChart(e,f,b):this.updateVisitorChart(e,f,b)},onPage:function(){this.statsOpen()&&"page"==this.range&&this.render()},onOpenStats:function(){this.render()},setContextTitle:function(b){if("page"==this.range)this.$ctx.find(".js-o-stats__context-title").text(b.pageTitle);else{var c=a(".nav-documents .document-items .item-active a").text();this.$ctx.find(".js-o-stats__context-title").text(c)}},updateNumbers:function(a){this.$ctx.find(".js-o-stats__summary-total-views").html(a.total_views),this.$ctx.find(".js-o-stats__summary-total-visitors").text(a.total_visitors)},statsOpen:function(){return this.$ctx.closest(".js-co-powerbar__drawer").hasClass("state-open")},createViewerChart:function(b,c){var d=this.scaleOptions;return Math.max.apply(Math,b)<3&&(d.yAxes[0].ticks.stepSize=1),new Chart(a(".js-o-stats__chart-views",this.$ctx),{type:"bar",data:{labels:c,datasets:[{data:b,label:"# of Visits",backgroundColor:this.barBackgroundColor,hoverBackgroundColor:this.barHoverColor}]},options:{legend:{display:!1},scales:d}})},updateViewerChart:function(a,b){this.viewerChart.data.datasets[0].data=a,this.viewerChart.data.labels=b,this.viewerChart.update()},createVisitorChart:function(b,c,d){var e=this.scaleOptions;return Math.max.apply(Math,b)+Math.max.apply(Math,c)<3&&(e.yAxes[0].ticks.stepSize=1),new Chart(a(".js-o-stats__chart-visitors",this.$ctx),{type:"bar",data:{labels:d,datasets:[{label:"logged in",backgroundColor:this.barBackgroundColor,data:c},{label:"anonymous",backgroundColor:this.barAlternativeBackgroundColor,data:b}]},options:{scales:e,legend:{position:"bottom",labels:{fontColor:"#999"}}}})},updateVisitorChart:function(a,b,c){this.visitorChart.data.datasets[0].data=b,this.visitorChart.data.datasets[1].data=a,this.visitorChart.data.labels=c,this.visitorChart.update()}})}(Tc.$),function(a){Tc.Module.BlockAnnotations=Tc.Module.extend({on:function(b){var c=this.$ctx;this.id=c.data("block"),this.data=this.sandbox.getConfigParam("data"),this.tpl=this.sandbox.getConfigParam("tpl"),this.editing=a(".mod-document").hasClass("editor-enabled"),this.editable=c.data("editable"),this.count=c.find(".js-b-annotations__bubble").length||0,this.$canvas=c.find(".js-b-annotations__canvas"),this.$details=c.find(".js-b-annotations__details"),this.$loader=a(this.tpl.render("progress",{id:this.id})),this.$css=c.find(".js-b-annotations__styles"),this.isTranslator=a("body").data("translation-language")&&"1"==a("body").data("translator"),this.selection=null,this.started=!1,this.$dragging=null,this.sandbox.addModules(this.$loader),this.sandbox.subscribe("events",this),this.setBubbleColor(this.$css.data("bubble")),b()},after:function(){var b=this.$ctx;this.enableRichtext(),this.enableImageUpload(),this.updateImage(),b.on("click",".js-b-annotations__canvas",function(a){if(this.editing&&this.editable){var b=this._getOffset(a.currentTarget,a);this.addAnnotation(b.x,b.y)}}.bind(this)),b.on("click",".js-b-annotations__new",function(){this.editing&&this.addAnnotation(50,50)}.bind(this)),b.on("click",".js-b-annotations__bubble",function(a){a.stopPropagation()}.bind(this)),b.on("mouseenter",".js-b-annotations__item",function(c){var d=a(c.currentTarget);a(".js-b-annotations__bubble",b).addClass("state-hidden"),a('.js-b-annotations__bubble[data-id="'+d.data("id")+'"]',b).removeClass("state-hidden")}.bind(this)),b.on("mouseleave",".js-b-annotations__item",function(){a(".js-b-annotations__bubble",b).removeClass("state-hidden")}.bind(this)),b.on("mouseenter",".js-b-annotations__bubble",function(c){var d=a(c.currentTarget);a(".js-b-annotations__item",b).addClass("state-hidden");var e=a('.js-b-annotations__item[data-id="'+d.data("id")+'"]',b);e.removeClass("state-hidden");var f=e.find("span");if(f.is(":not(:empty)")){var g=e.outerWidth(),h=d.position().left+50,i=this.$canvas.width();h+g>i&&(g=i-h),this.$details.width(g).html(f.html()),d.append(this.$details),this.$details.velocity("fadeIn",{duration:50})}}.bind(this)),this.editable&&(b.on("mouseleave",".js-b-annotations__bubble",function(){this.$details.velocity("reverse",function(){this.$details.detach()}.bind(this)),this.$dragging||a(".js-b-annotations__item",b).removeClass("state-hidden")}.bind(this)),b.on("mousedown",".js-b-annotations__bubble",function(b){var c=a(b.currentTarget);this.editing&&(c.addClass("state-dragging"),this.$dragging=c)}.bind(this)),b.on("mousemove",".js-b-annotations__image-wrap",function(a){if(this.$dragging){var b=this._getOffset(this.$canvas.get(0),a);this.$dragging.css({left:b.x+"%",top:b.y+"%"})}}.bind(this)),b.on("mouseup",".js-b-annotations__image-wrap",function(a){if(this.$dragging){this.$dragging.removeClass("state-dragging");var c=this.$dragging.data("id"),d=this._getOffset(this.$canvas.get(0),a),e={settings:{}};e.settings["annotations["+(c-1)+"]"]={left:d.x,top:d.y},this.data.updateBlock(b,e),this.$dragging=null}}.bind(this))),b.on("click",".js-b-annotations__settings",function(c){var d=a(c.currentTarget);if(d.hasClass("state-open"))d.closest(".js-b-annotations__actions").removeClass("state-open");else{d.closest(".js-b-annotations__actions").addClass("state-open");var e=b.data("block"),f=d.next(".js-cm-btn-dropdown__menu");f.html(this.tpl.render("c-loader")),this.data.get("/api/document/block/"+e).then(function(a){a.data.translator_only=this.isTranslator,f.html(this.tpl.render("b-annotations-settings",a.data)),this.settings=new Tc.Module.CSettings(f.find(".js-b-annotations__settings-overlay"),this.sandbox);var c=this.settings.getSetting("border");c.saved=function(a){var c=b.find(".js-b-annotations__image-wrap");a.border?c.addClass("state-border"):c.removeClass("state-border"),this.data.updateBlock(b,{settings:{border:a.border}})}.bind(this);var d=this.settings.getSetting("retina");d.saved=function(a){var c=b.find(".js-b-annotations__image-wrap");a.retina?c.addClass("state-retina"):c.removeClass("state-retina"),this.updateImage(),this.data.updateBlock(b,{settings:{retina:a.retina}})}.bind(this);var e=this.settings.getSetting("downloadable");e.saved=function(a){var c=b.find(".btn-download");b.find(".js-b-annotations__inherited").remove(),a.downloadable?c.removeClass("btn-editor"):c.addClass("btn-editor"),this.data.updateBlock(b,{settings:{downloadable:a.downloadable,downloadable_inherited:!1}})}.bind(this);var g=this.settings.getSetting("bubble");g.saved=function(a){this.setBubbleColor(a.bubble),this.data.updateBlock(b,{settings:{bubble:a.bubble}})}.bind(this)}.bind(this))}}.bind(this)),b.on("click",".js-b-annotations__replace",function(c){a(".js-m-dropzone__upload",b).trigger("click")}),b.on("click",".btn-download, .fileupload-replace",function(a){a.stopPropagation()}),b.on("keydown",'.js-b-annotations__item [data-editable="true"]',function(b){var c=a(b.currentTarget),d=c.closest(".js-b-annotations__item");if(8==b.keyCode){var e=c.html().trim();""==e&&(b.preventDefault(),this.removeAnnotation(d.data("id")))}else 9==b.keyCode&&!b.shiftKey&&d.is("li:nth-last-of-type(2)")&&this.addAnnotation(50,50)}.bind(this)),b.on("click",".btn-delete-annotation",function(b){var c=a(b.currentTarget),d=c.closest(".js-b-annotations__item").data("id");this.removeAnnotation(d)}.bind(this)),b.on("blur",'.js-b-annotations__item [data-editable="true"]',function(c){var d=a(c.currentTarget),e=d.closest(".js-b-annotations__item"),f=e.data("id"),g=d.html().trim(),h={settings:{}};h.settings["annotations["+(f-1)+"]"]={content:g},this.data.updateBlock(b,h)}.bind(this)),b.on("click",".js-b-annotations__mode",function(c){var d=a(c.currentTarget).data("mode"),e={settings:{mode:d}},f=b.find(".js-b-annotations__mode-wrap");return f.removeClass("state-mode-full state-mode-figure"),f.addClass("state-mode-"+d),this.data.updateBlock(b,e),!1}.bind(this))},setBubbleColor:function(a){var b=tinycolor(a);if(b.isValid()){var c=b.toHsl(),d=c.l>.5?"#000":"#fff";this.$css.text('.b-annotations[data-block="'+this.id+'"] .b-annotations__bubble, .b-annotations[data-block="'+this.id+'"] .b-annotations__item:before {background-color: '+a+";color: "+d+";}")}},enableRichtext:function(){var b=this.$ctx;a(window).on("mouseup",function(){this.editing&&this.started&&(this.createHint(),this.started=!1)}.bind(this)),b.on("mousedown",'.js-b-annotations__item [data-editable="true"]',function(){this.started=!0}.bind(this)),b.on("mousedown mouseup",".tooltip",function(a){return a.stopPropagation(),!1}.bind(this)),b.on("keypress",'.js-b-annotations__item [data-editable="true"]',function(){b.find(".tooltip").remove()}.bind(this)),a(document).on("mousedown",function(){b.find(".tooltip").remove()}.bind(this)),b.on("click",".btn-bold",function(a){a.preventDefault(),document.execCommand("bold",!1,null)}.bind(this)),b.on("click",".btn-italic",function(a){a.preventDefault(),document.execCommand("italic",!1,null)}.bind(this)),b.on("click",".btn-code",function(c){c.preventDefault();var d=window.getSelection().getRangeAt(0),e=d.commonAncestorContainer.parentElement;if(a(e).is("code"))return void a(e).replaceWith(e.textContent);var f=document.createElement("code");d.surroundContents(f),b.find(".tooltip").remove()}.bind(this)),b.on("click",".btn-link",function(a){a.preventDefault();var b=window.getSelection().getRangeAt(0);"A"===b.startContainer.parentNode.tagName||"A"===b.endContainer.parentNode.tagName?document.execCommand("unlink",!1,null):this.urlPrompt(function(a){document.execCommand("createLink",!1,a)})}.bind(this))},enableImageUpload:function(){var b=this.$ctx;a(".js-m-dropzone__upload",b).fileupload({dataType:"json",dropZone:a(".js-m-dropzone",b),start:function(){var c=a(".js-m-dropzone",b);c.find(".icon-image").replaceWith(this.$loader)}.bind(this),progress:function(a,b){var c=parseInt(b.loaded/b.total*100,10);this.fire("progress",{id:this.id,progress:c})}.bind(this),done:function(c,d){if(d.result&&d.result[0]){var e={settings:{asset:d.result[0].id,caption:d.result[0].name}};if(!this.isTranslator){var f=a(".js-m-dropzone__upload",b);f.attr("name","files_replace"),f.fileupload("option","url","/api/screen/replace/"+d.result[0].id)}this.data.updateBlock(b,e);var g=d.result[0].id,h="/api/screen/thumbnail/"+d.result[0].hash,i=a(".btn-download",b);i.attr("href","/api/screen/download/"+d.result[0].hash);var j=a(".js-b-annotations__figure",b);j.data("id",g),j.data("href","/api/screen/download/"+g);var k=this.$canvas;k.data("width",d.result[0].width),k.data("height",d.result[0].height),k.data("src",h),b.addClass("state-available"),this.updateImage()}}.bind(this)})},onEnableEditing:function(){var b=this.$ctx;return b.hasClass("referenced")?!1:(this.editing=!0,void a("[data-editable]",b).attr("contenteditable",!0))},onDisableEditing:function(){var b=this.$ctx;this.editing=!1,this.fire("closeDropdown",b.find(".js-b-annotations__settings")),a("[data-editable]",b).removeAttr("contenteditable")},addAnnotation:function(a,b){var c=this.$ctx;if(c.hasClass("state-available")){var d={settings:{"annotations[]":{left:a,top:b,content:""}}};this.data.updateBlock(c,d),this.count++,this.addAnnotationToImage(a,b),this.addAnnotationToList(),c.find('.js-b-annotations__item[data-id="'+this.count+'"] span').focus()}},addAnnotationToImage:function(b,c){var d=(this.$ctx,a('<div class="b-annotations__bubble js-b-annotations__bubble" data-id="'+this.count+'">'+this.count+"</div>"));d.data("id",this.count),d.css({left:b+"%",top:c+"%"}),this.$canvas.append(d)},addAnnotationToList:function(){var b=this.$ctx,c=a('<li class="b-annotations__item js-b-annotations__item" data-id="'+this.count+'"><span data-editable="true" contenteditable="true"></span><button class="btn-delete-annotation"><i class="icon-times-circle"></i></button></li>');a(".js-b-annotations__new",b).before(c)},removeAnnotation:function(b){var c=this.$ctx,d={settings:{}};d.settings["annotations["+(b-1)+"]"]=null,this.data.updateBlock(c,d),a('.js-b-annotations__bubble[data-id="'+b+'"]').remove(),a('.js-b-annotations__item[data-id="'+b+'"]').remove();var e=a(".js-b-annotations__item",c);a.each(e,function(c,d){var e=a(d),f=e.data("id");if(f>b){var g=a('.js-b-annotations__bubble[data-id="'+f+'"]');g.text(f-1),g.data("id",f-1),g.attr("data-id",f-1),e.data("id",f-1),e.attr("data-id",f-1)}}),c.find('.js-b-annotations__item[data-id="'+(b-1)+'"] span').focus(),this.count--},updateImage:function(){var b=this.$ctx,c=a(".js-b-annotations__image-wrap",b),d=c.hasClass("state-retina"),e=this.$canvas,f=a(".js-b-annotations__figure",b),g=c.width();d&&(g*=2);var h=Math.min(e.data("width"),g),i=e.data("src")+"/"+h;if(!e.data("src"))return!1;var j=new Image;j.onload=function(){var a=e.data("width"),c=e.data("height");d&&(a/=2,c/=2),f.css({maxWidth:a}),e.css({paddingBottom:100*c/a+"%"});var g=e.find(".js-b-annotations__image");g.length>0?g.replaceWith('<img class="b-annotations__image js-b-annotations__image" src="'+i+'" alt="'+e.data("alt")+'" />'):e.prepend('<img class="b-annotations__image js-b-annotations__image" src="'+i+'" alt="'+e.data("alt")+'" />'),this.fire("BlockReady",{block:b.data("block")})}.bind(this),j.src=i},_getSelection:function(){var a=this.$ctx,b={text:"",from:0,to:0,rect:{}};if(window.getSelection&&"Caret"==window.getSelection().type&&a.find(".tooltip").remove(),window.getSelection&&"Range"==window.getSelection().type||window.getSelection().rangeCount>0){var c=this.selection=window.getSelection();if(b.text=c.toString(),b.from=c.anchorOffset,b.to=c.focusOffset,c.rangeCount&&(range=c.getRangeAt(0).cloneRange(),range.getBoundingClientRect)){var d=range.getBoundingClientRect();b.rect={top:d.top,left:d.left+d.width/2}}}if(b.from>b.to){var e=b.from;b.from=b.to,b.to=e}return b},createHint:function(){var b=this.$ctx,c=this._getSelection();if(""!==c.text.trim()){if(this.editing)var d='<div class="tooltip tooltip-edit"><a class="btn-bold" href="javascript:;"><i class="icon-bold"></i></a><a class="btn-italic" href="javascript:;"><i class="icon-italic"></i></a><a class="btn-link" href="javascript:;"><i class="icon-link"></i></a><a class="btn-code" href="javascript:;"><i class="icon-code"></i></a></div>',e=a(d);e.css({top:c.rect.top,left:c.rect.left}),b.append(e)}},urlPrompt:function(a){var b=prompt("Enter a url","http://");a(/^((http|https)...)/.test(b)?b:"http://"+b)},_getOffset:function(a,b){var c=a.getBoundingClientRect(),d={x:this._calculate(b.clientX-c.left,c.right-c.left),y:this._calculate(b.clientY-c.top,c.bottom-c.top)};return d},_calculate:function(a,b){var c=100*a/b;return c}})}(Tc.$),function(a){Tc.Module.BlockAttributes=Tc.Module.extend({on:function(b){var c=this.$ctx;this.data=this.sandbox.getConfigParam("data");var d=a("tbody td",c);a.each(d,function(b,c){a(c).wrapInner('<div data-editable="true"></div>')}),a(".btn-toggle-editing").on("click",function(){a(".mod-document").hasClass("editor-enabled")&&!c.hasClass("referenced")?a('[data-editable="true"]',c).attr("contenteditable",!0):a('[data-editable="true"]',c).removeAttr("contenteditable")}),a(".mod-document").hasClass("editor-enabled")&&a('[data-editable="true"]',c).attr("contenteditable",!0),b()},after:function(){var b=this.$ctx,c=this;b.on("blur","td > [contenteditable]",function(a){c.save()}),b.on("keydown","td > [contenteditable]",function(d){if(8==d.keyCode){var e=(a(this).find("> div").html(),a(this).closest("tr")),f=0;return void a(e).find("td").each(function(b,e){var g=a(e).find("> div").html();if(""==g&&f++,4==f){var h=a("tr").last();a(h).remove(),f=0,d.preventDefault(),c.save()}})}if(9==d.keyCode&&!d.shiftKey){var g=a("tr",b).length,h=a("th",b).length,i=a(this).parent().get(0).cellIndex,j=a(this).closest("tr").get(0).rowIndex;if(g==j+1&&h==i+1){var k=a('<tr><td><div data-editable="true" contenteditable></div></td><td><div data-editable="true" contenteditable></div></td><td><div data-editable="true" contenteditable></div></td><td><div data-editable="true" contenteditable></div></td></tr>');a("table",b).append(k)}}})},save:function(){var b=this.$ctx,c=[],d=[],e=a("thead th",this.$ctx);a.each(e,function(b,d){var e=a(d),f=e.data("field");c[b]=f});var f=a("tbody tr",b);a.each(f,function(b,e){var f={};a(e).children("td").each(function(b,d){var e=a(d).find("> div").html();f[c[b]]=e}),d.push(f)});var g=(b.data("block"),b.parents(".page").data("id"),b.parents("section").data("id"));1>g&&(g=0);var h={settings:{data:d}};this.data.updateBlock(b,h)}})}(Tc.$),function(a){Tc.Module.BlockBreakpoints=Tc.Module.extend({full_width:1680,full_width_visual:800,on:function(a){this.$ctx;a()},after:function(){var b=this,c=this.$ctx,d=a(".breakpoint",c),e=b.full_width_visual,f="",g=0;a.each(d,function(c,d){var h=parseInt(a(d).data("width"));if(!isNaN(h)&&h>0){var i=Math.round(h/b.full_width*b.full_width_visual)-g;e-=i,a(d).css("width",i),0!=c&&(f+="\n"),f+="/* Breakpoint: "+a(d).data("label")+" */\n",f+="@media only screen and (max-width: "+h+"px) { }\n",g+=i}else a(d).css("width",e)}),a(".code-css",c).text(f),a("pre code",c).each(function(a,b){hljs.highlightBlock(b)})}})}(Tc.$),function(a){Tc.Module.BlockBrowsercompatibility=Tc.Module.extend({on:function(a){this.$ctx;a()}})}(Tc.$),function(a){Tc.Module.BlockCallout=Tc.Module.extend({selection:null,started:!1,on:function(b){var c=this,d=this.$ctx,e=(d.data("block"),d.parents(".page").data("id"),d.parents("section").data("id"));1>e&&(e=0),this.data=this.sandbox.getConfigParam("data"),a(window).on("mouseup",function(){a(".mod-document").hasClass("editor-enabled")&&c.started&&(c.createHint(),c.started=!1)}),a(".callout",d).on("mousedown",function(a){c.started=!0}),d.on("mousedown mouseup",".tooltip",function(a){return a.stopPropagation(),!1}),a(".callout",d).on("keypress",function(a){d.find(".tooltip").remove()}),a(document).on("mousedown",function(){d.find(".tooltip").remove()}),a(".btn-toggle-editing").on("click",function(){a(".mod-document").hasClass("editor-enabled")&&!d.hasClass("referenced")?a(".callout",d).attr("contenteditable",!0):a(".callout",d).removeAttr("contenteditable")}),a(".mod-document").hasClass("editor-enabled")&&d.find(".callout").attr("contenteditable",!0),d.on("click",".btn-bold",function(a){a.preventDefault(),document.execCommand("bold",!1,null)}),d.on("click",".btn-italic",function(a){a.preventDefault(),document.execCommand("italic",!1,null)}),d.on("click",".btn-unordered-list",function(a){a.preventDefault(),document.execCommand("insertUnorderedList",!1,null)}),d.on("click",".btn-ordered-list",function(a){a.preventDefault(),document.execCommand("insertOrderedList",!1,null)}),d.on("click",".btn-clear",function(a){a.preventDefault(),document.execCommand("removeFormat",!1,null)}),d.on("click",".btn-h1",function(b){b.preventDefault();var c=window.getSelection().getRangeAt(0),e=c.commonAncestorContainer.parentElement;if(a(e).is("h3"))return void a(e).replaceWith(e.textContent);var f=document.createElement("h3");c.surroundContents(f),d.find(".tooltip").remove()}),d.on("click",".btn-link",function(a){a.preventDefault();var b=window.getSelection().getRangeAt(0);"A"===b.startContainer.parentNode.tagName||"A"===b.endContainer.parentNode.tagName?document.execCommand("unlink",!1,null):c.urlPrompt(function(a){document.execCommand("createLink",!1,a)})}),d.on("click",".btn-change-type",function(){var b=a(this).data("type"),e={settings:{type:b}},f=d.find(".callout,.placeholder");return f.removeClass("callout-tip"),f.removeClass("callout-warning"),f.removeClass("callout-info"),f.removeClass("callout-note"),f.addClass("callout-"+b),c.data.updateBlock(d,e),!1}),a(".callout",d).on("blur",function(){a(this).find("span").contents().unwrap();var b=a(this).html(),e={settings:{content:b}};return c.data.updateBlock(d,e).then(function(){c.update()}),!1}),a(".callout",d).text().trim().length<1&&d.addClass("block-empty"),b()},after:function(){this.$ctx},update:function(){var b=this.$ctx,c=a(".callout",b);c.text().length>0?b.removeClass("block-empty"):b.addClass("block-empty")},_getSelection:function(){var a=this,b=this.$ctx,c={text:"",from:0,to:0,rect:{}};if(window.getSelection&&"Caret"==window.getSelection().type&&b.find(".tooltip").remove(),window.getSelection&&"Range"==window.getSelection().type||window.getSelection().rangeCount>0){var d,e=window.getSelection();if(a.selection=e,c.text=e.toString(),c.from=e.anchorOffset,c.to=e.focusOffset,e.rangeCount&&(d=e.getRangeAt(0).cloneRange(),d.getBoundingClientRect)){var f=d.getBoundingClientRect();c.rect={top:f.top,left:f.left+f.width/2}}}if(c.from>c.to){var g=c.from;c.from=c.to,c.to=g}return c},createHint:function(){var b=this,c=this.$ctx,d=b._getSelection();if(""!==d.text.trim()){if(a(".mod-document").hasClass("editor-enabled"))var e='<div class="tooltip tooltip-edit"><a class="btn-h1" href="javascript:;">H1</a><a class="btn-bold" href="javascript:;"><i class="icon-bold"></i></a><a class="btn-italic" href="javascript:;"><i class="icon-italic"></i></a><a class="btn-unordered-list" href="javascript:;"><i class="icon-list-ul"></i></a><a class="btn-ordered-list" href="javascript:;"><i class="icon-list-ol"></i></a><a class="btn-link" href="javascript:;"><i class="icon-link"></i></a></div>',f=a(e);f.css({top:d.rect.top,left:d.rect.left}),c.append(f)}},urlPrompt:function(a){var b=prompt("Enter a url","http://");a(/^((http|https)...)/.test(b)?b:"http://"+b)}})}(Tc.$),function(a){Tc.Module.BlockChecklist=Tc.Module.extend({templates:[],on:function(b){var c=this,d=this.$ctx,e=a("body").data("project");this.tpl=c.sandbox.getConfigParam("tpl"),c.sandbox.subscribe("events",c),
this.data=this.sandbox.getConfigParam("data"),c.templates.flyout=this.tpl.compile("b-checklist-flyout"),c.templates.template=this.tpl.compile("b-checklist-template"),c.templates.visibility=this.tpl.compile("b-checklist-visibility"),c.templates.email=this.tpl.compile("b-checklist-email"),d.on("click",".js-item-status",function(){var b=a(this).find("i"),e=a(this).closest(".b-checklist__item");if(!a(".mod-document").hasClass("editor-enabled")||d.hasClass("referenced"))return!1;if(e.hasClass("item-dirty"))return!1;var f=new Date,g=Date.UTC(f.getUTCFullYear(),f.getUTCMonth(),f.getUTCDate(),f.getUTCHours(),f.getUTCMinutes(),f.getUTCSeconds(),f.getUTCMilliseconds());e.hasClass("state-checked")?(b.addClass("icon-square-o"),b.removeClass("icon-check-square-o"),e.removeClass("state-checked"),e.find(".b-checklist__item__content > span:not(.meta)").attr("contenteditable",!0),e.find(".b-checklist__item__content .meta").remove(),e.removeAttr("data-checked")):e.find("span").text().length>0&&(b.removeClass("icon-square-o"),b.addClass("icon-check-square-o"),e.addClass("state-checked"),e.find(".b-checklist__item__content > span:not(.meta)").removeAttr("contenteditable",!0),e.find(".b-checklist__item__content").append('<span class="meta">a few seconds ago</span>'),e.attr("data-checked",g)),c.update()}),d.on("click",".b-checklist__item--avater > img",function(){var b=a(this).closest(".b-checklist__item");if(!a(".mod-document").hasClass("editor-enabled")||d.hasClass("referenced"))return!1;if(b.hasClass("item-dirty")||b.hasClass("state-checked"))return!1;var f=a(this).closest(".b-checklist__item--avater"),g=d,h=g.find(".m-members");h.size()>0?h.remove():c.loadCollaborators(e,function(b){var d=a(c.templates.flyout(b));f.append(d),d.velocity("slideDown",{duration:200})})}),d.on("click",".member-item",function(){var b=a(this).closest(".b-checklist__item .b-checklist__item--avater"),d={name:a(this).data("name"),id:a(this).data("id"),avatar:a(this).data("avatar")};b.data("name",d.name).data("id",d.id).data("avatar",d.avatar),b.attr("data-tooltip","Assigned to "+d.name),b.find("img").attr("src",d.avatar),c.update(),data={name:d.name},b.find(".m-members").empty();var e=a(c.templates.email(data));b.find(".m-members").append(e)}),d.on("blur",".b-checklist__item.item-dirty .b-checklist__item__content > span",function(){return 0!==a(this).text().length&&(a(this).closest(".b-checklist__item").removeClass("item-dirty"),a(this).closest(".b-checklist__item").addClass("b-checklist__draggable"),c.update(),c.renderTemplate(),setTimeout(function(){d.find(".b-checklist__item.item-dirty .b-checklist__item__content > span").focus()},10)),!1}),d.on("blur",".b-checklist__item .b-checklist__item__content > span",function(){return 0!==a(this).text().length&&c.update(),!1}),d.on("click",".js-item-delete",function(){return a(this).closest(".b-checklist__item").hasClass("item-dirty")?!1:(a(this).closest(".b-checklist__item").remove(),void c.update())}),d.on("keypress",".b-checklist__item__content > span, .b-checklist__head h3",function(b){return 13==b.keyCode?(a(this).trigger("blur"),window.getSelection().removeAllRanges(),!1):void 0}),d.on("blur",".b-checklist__head h3",function(){0!==a(this).text().length&&c.update()}),d.on("click",".visibility",function(){var b="public"==d.attr("data-visibility")?!0:!1;b?(d.attr("data-visibility","private"),a(this).removeClass("state-public"),d.find(".b-checklist__item--avater").removeClass("state-hide")):(d.attr("data-visibility","public"),a(this).addClass("state-public"),d.find(".b-checklist__item--avater").addClass("state-hide"));var e=d.find(".visibility");e.html(c.templates.visibility({visible:b})),c.renderVisibility(),c.update()}),d.on("click",".m-email__notify",function(){var b={block_id:d.data("block"),item_id:a(this).closest(".b-checklist__item").attr("data-element"),url:a("body").data("share-url-default")};a.ajax({url:"/api/task/notify/",type:"POST",data:JSON.stringify(b),success:function(a){a.success?d.find(".m-email__cancel").trigger("click"):c.displayError("Error","Something went wrong. Please contact support@frontify.com!")}})}),d.on("click",".m-email__cancel",function(){d.find(".m-members").remove()}),b()},loadCollaborators:function(b,c){this.$ctx;return a.ajax({url:"/api/collaborator/list/"+b,type:"GET",success:function(b){b.success&&(a.each(b.collaborators,function(a,b){b.name||(b.name=b.email)}),c(b))}}),!1},enableSorting:function(b){var c=this.$ctx,d=this;d.sortable=Sortable.create(b,{group:"checklist",ghostClass:"sortable-ghost",handle:".drag-handle",draggable:".b-checklist__draggable",onUpdate:function(b){return!a("body").hasClass("editor-enabled")||c.hasClass("referenced")?!1:(d.reOrderItems(),void d.update())}})},after:function(){var b=this.$ctx,c=this;$sortable_items=b.find('[data-sortable="true"]'),a.each($sortable_items,function(a,b){c.enableSorting(b)}),c.renderVisibility(),c.renderTemplate(),c.reOrderItems()},update:function(b){if(!a("body").hasClass("editor-enabled"))return!1;var c=this.$ctx,d=[],e=c.find(".item-list .b-checklist__item"),f=(a(".page").data("id"),c.parents("section").data("id"));1>f&&(f=0);c.data("block");a.each(e,function(b,c){var e=a(c);return e.hasClass("item-dirty")?!1:(item_properties={status:e.hasClass("state-checked"),content:e.find(".b-checklist__item__content > span:not(.meta)").text(),date_checked:e.attr("data-checked")?e.attr("data-checked"):null,user:{name:e.find(".b-checklist__item--avater").data("name"),id:e.find(".b-checklist__item--avater").data("id"),avatar:e.find(".b-checklist__item--avater").data("avatar")}},void d.push(item_properties))});var g={settings:{title:c.find(".b-checklist__head h3").text(),visible:"public"==c.attr("data-visibility")?!0:!1,items:d}};this.data.updateBlock(c,g)},onEnableEditing:function(b){var c=this.$ctx;a('[data-editable="true"]',c).attr("contenteditable",!0)},onDisableEditing:function(b){var c=this.$ctx;a('[data-editable="true"]',c).removeAttr("contenteditable",!0)},renderVisibility:function(){var a=this,b=this.$ctx,c=b.find(".visibility"),d="public"==b.attr("data-visibility")?!0:!1;c.html(a.templates.visibility({visible:d}))},renderTemplate:function(){var a=this,b=this.$ctx,c="public"==b.attr("data-visibility")?!0:!1,d=b.find(".item-list");d.append(a.templates.template({visible:c}))},reOrderItems:function(){var b=this.$ctx,c=b.find(".item-list li");a.each(c,function(b,c){a(c).attr("data-element",b+1)})},displayError:function(a,b){swal({title:a,text:b,type:"error",showCancelButton:!1,confirmButtonText:"OK",closeOnConfirm:!0},function(){})}})}(Tc.$),function(a){Tc.Module.BlockCode=Tc.Module.extend({codemirror:null,on:function(b){var c=this.$ctx,d=c.data("mode"),e=a(".mode-switcher",c).find('[value="'+d+'"]');a(".mode",c).text(e.text()),a(".mode-switcher",c).val(d),b()},after:function(){var b=this,c=this.$ctx,d=c.data("block"),e=c.parents(".page").data("id"),f=c.parents("section").data("id");1>f&&(f=0);var g=!0;a(".btn-toggle-editing").on("click",function(){a(".mod-document").hasClass("editor-enabled")&&!c.hasClass("referenced")&&b.codemirror.setOption("readOnly",!1)}),a(".mod-document").hasClass("editor-enabled")&&(g=!1),a(".mode-switcher",c).on("change",function(){var g=a(this).val();b.codemirror.setOption("mode",g),a(".mode",c).text(a(this).find('[value="'+g+'"]').text());var h={settings:{mode:g}};a.ajax({url:"/api/document/block/"+e+"/"+f+"/"+d,data:JSON.stringify(h),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success}})}),b.codemirror=CodeMirror.fromTextArea(c.find("textarea").get(0),{mode:c.data("mode"),theme:"solarized",lineNumbers:!0,lineWrapping:!1,readOnly:g,viewportMargin:1/0,extraKeys:{"Ctrl-Space":"autocomplete",Tab:function(a){var b=Array(a.getOption("indentUnit")+1).join(" ");a.replaceSelection(b,"end","+input")}}});var h=null;b.codemirror.on("change",function(){clearTimeout(h),h=setTimeout(function(){var c={settings:{code:b.codemirror.getValue()}};a.ajax({url:"/api/document/block/"+e+"/"+f+"/"+d,data:JSON.stringify(c),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success}})},300)})}})}(Tc.$),function(a){Tc.Module.BlockColor=Tc.Module.extend({templates:[],$items:null,$placeholder:null,sortable:null,clip:null,color_count:null,colorspaces:[],on:function(b){var c=this.$ctx;this.tpl=this.sandbox.getConfigParam("tpl"),this.data=this.sandbox.getConfigParam("data"),this.templates.item=this.tpl.compile("b-color-item"),this.templates.flyout=this.tpl.compile("b-color-flyout"),this.sandbox.subscribe("events",this),this.$items=a(".data .colors",c),this.$placeholder=a(".placeholder",c);var d=a(".mod-document").data("editing");c.on("click",".btn-change-view",function(b){var d=a(b.currentTarget).data("view"),e={settings:{view:d}};return this.$items.removeClass("view-list"),this.$items.removeClass("view-grid"),this.$items.removeClass("view-card"),this.$placeholder.find(".colors").removeClass("view-list"),this.$placeholder.find(".colors").removeClass("view-grid"),this.$placeholder.find(".colors").removeClass("view-card"),this.$items.addClass("view-"+d),this.$placeholder.find(".colors").addClass("view-"+d),this.data.updateBlock(c,e),!1}.bind(this)),d&&(a(".btn-toggle-editing").on("click",function(){a(".mod-document").hasClass("editor-enabled")&&!c.hasClass("referenced")?a('[data-editable="true"]',c).attr("contenteditable",!0):a('[data-editable="true"]',c).removeAttr("contenteditable")}),a(".mod-document").hasClass("editor-enabled")&&a('[data-editable="true"]',c).attr("contenteditable",!0)),c.on("blur",'.palette-title[data-editable="true"]',function(b){var d=a(b.currentTarget),e={name:d.text()};""!=e.name?d.attr("data-empty","false"):d.attr("data-empty","true"),a("body").data("translation-language")&&(e.language=a("body").data("translation-language")),a.ajax({url:"/api/color/palette/"+c.data("project")+"/"+c.data("palette"),dataType:"json",data:JSON.stringify(e),type:"POST",success:function(a){a.success}})}.bind(this)),c.on("blur",'.palette-description[data-editable="true"]',function(b){var d=a(b.currentTarget),e={description:d.text()};""!=e.description?d.attr("data-empty","false"):d.attr("data-empty","true"),a("body").data("translation-language")&&(e.language=a("body").data("translation-language")),a.ajax({url:"/api/color/palette/"+c.data("project")+"/"+c.data("palette"),dataType:"json",data:JSON.stringify(e),type:"POST",success:function(a){a.success}})}.bind(this)),c.on("focus",'.palette-description[data-empty="true"]',function(b){a(b.currentTarget).text("").attr("data-empty","false")}),c.on("focus",'.palette-title[data-empty="true"]',function(b){a(b.currentTarget).text("").attr("data-empty","false")}),c.on("blur",'.colors [data-editable="true"]',function(b){if(!a("body").hasClass("editor-enabled"))return!1;var c=a(b.currentTarget),d=c.parents(".color"),e=d.data("id"),f=c.data("field");if(f){var g={},h=c.text();g[f]=h,a.ajax({url:"/api/color/update/"+e,dataType:"json",data:JSON.stringify(g),type:"POST",success:function(a){if(a.success){c.attr("data-empty",!1);var b=a.color[f],e=c.data("prefix");e?c.text(e+b):c.text(b),"hex"==f&&(d.find(".color-value-rgb .r").text(a.color.r),d.find(".color-value-rgb .g").text(a.color.g),d.find(".color-value-rgb .b").text(a.color.b),d.find(".color-preview").css("background","#"+a.color.hex))}else console.error("color update failed")}})}}.bind(this)),c.on("keydown",'[data-editable="true"]',function(b){return 13==b.keyCode?(a(b.currentTarget).trigger("blur"),!1):void 0}.bind(this)),c.on("click",".color-add .preview",function(b){a(b.currentTarget).parent().find(".fld").focus()}.bind(this)),c.on("click",".btn-choose-color-system",function(b){var d=a(b.currentTarget),e={};c.data("project"),c.data("palette");if(this.colorspaces&&a.each(this.colorspaces,function(a,b){e[b]=!0}.bind(this)),!d.hasClass("state-open")){var f=this.templates.flyout(e);return d.after(f),d.addClass("state-open"),!1}c.find(".colorspace").detach(),d.removeClass("state-open")}.bind(this)),c.on("change",'.colorspace li input[type="checkbox"]',function(b){var d=a(b.currentTarget).closest("li"),e=a(b.currentTarget).is(":checked"),f=!1;if(e){var g=this.colorspaces.indexOf(d.data("colorspace"));-1==g&&(this.colorspaces.push(d.data("colorspace")),f=!0),d.addClass("active"),c.find(".data").find(".color-value-"+d.data("colorspace")).closest("li").css("display","block");var h={settings:{"colorspaces[]":d.data("colorspace")}};c.find(".color").find(".color-value-"+d.data("colorspace")+" div").attr("contenteditable",!0),c.find(".color").find(".color-value-"+d.data("colorspace")+" div").focus()}else{var g=this.colorspaces.indexOf(d.data("colorspace"));g>-1&&(this.colorspaces.splice(g,1),f=!0),c.find(".data").find(".color-value-"+d.data("colorspace")).closest("li").hide();var h={settings:{}};h.settings["colorspaces[="+d.data("colorspace")+"]"]=null,d.removeClass("active")}f&&this.data.updateBlock(c,h),b.stopPropagation()}.bind(this)),c.on("click",'.colors [data-editable="true"]',function(b){var c=a(b.currentTarget);return a("body").hasClass("editor-enabled")?void(1==c.data("empty")&&c.text("").focus()):!1}.bind(this)),b()},initializeClipboard:function(){return!1},enableSorting:function(b){var c=this.$ctx;this.sortable=Sortable.create(b,{group:"colors",ghostClass:"sortable-ghost",handle:".color-preview",onStart:function(a){},onUpdate:function(b){if(!a("body").hasClass("editor-enabled")||c.hasClass("referenced"))return!1;var d=a(b.item).data("id"),e={sort:b.newIndex+1};a.ajax({url:"/api/color/update/"+d,type:"POST",data:JSON.stringify(e),success:function(a){}})}})},after:function(){var b=this.$ctx,c=b.data("project"),d=b.data("palette");if(this.colorspaces=[],!(1>c)){var e="/api/color/library/"+c;""!=d&&(e+="?palette="+d),a("body").data("translation-language")&&(e+=""!=d?"&":"?",e+="language="+a("body").data("translation-language")),a.ajax({url:e,headers:{ReferenceToken:b.data("reference-hash")},success:function(c){this.$items.empty();var e=a(".mod-document").data("editing");if(b.find(".palette-title").text(c.palettes[d].name),b.find(".palette-description").html(c.palettes[d].description),b.find(".palette-title").attr("data-empty",!c.palettes[d].name||""==c.palettes[d].name),b.find(".palette-description").attr("data-empty",!c.palettes[d].description),c.palettes[d].name&&""!=c.palettes[d].name||b.find(".palette-title").text(b.find(".palette-title").data("placeholder")),c.palettes[d].description||b.find(".palette-description").text(b.find(".palette-description").data("placeholder")),this.color_count=0,c.palettes[d].colors&&a.each(c.palettes[d].colors,function(b,f){c.palettes[d].colorspaces&&a.each(c.palettes[d].colorspaces,function(a,b){f["field_"+b]=!0;var c=this.colorspaces.indexOf(b);-1==c&&this.colorspaces.push(b)}.bind(this)),f.editable=e;var g=a(this.templates.item(f));switch(this.$items.append(g),f.type){case"SOLID":f.alpha<255?(g.find(".color-preview-opaque").css({backgroundColor:g.data("color-opaque")}),g.find(".color-preview-transparent").css({backgroundColor:g.data("color")})):g.find(".color-preview").css({backgroundColor:g.data("color")});break;case"GRADIENT":g.find(".color-preview").attr("style",f.css)}this.color_count++}.bind(this)),this.color_count>0){var f=b.find(".palette-title");a(".data .colors",b).show(),b.removeClass("block-empty"),"true"!=f.attr("data-empty")||a("body").hasClass("editor-enabled")||f.text("")}else a(".data .colors",b).hide(),b.addClass("block-empty");this.fire("BlockReady",{block:b.data("block")},function(){this.initializeClipboard()}.bind(this))}.bind(this)}),a(".color-add input",b).on("keyup",function(d){if(13==d.keyCode){var e=a(d.currentTarget),f=a(d.currentTarget).data("color"),g=f.toRgb(),h={palette:b.data("palette"),hex:f.toHex(),r:g.r,g:g.g,b:g.b,alpha:255*g.a};return a(".data .colors",b).show(),b.removeClass("block-empty"),a.ajax({url:"/api/color/create/"+c,type:"POST",data:JSON.stringify(h),success:function(c){if(c.success){a.each(this.colorspaces,function(a,b){c.color["field_"+b]=!0}.bind(this));var d=a(this.templates.item(c.color));d.find(".color-preview").css({background:f.toRgbString()}),a('[data-editable="true"]',d).attr("contenteditable",!0),this.$items.append(d),this.$items.show(),e.val(""),e.parent().find(".preview").css("background","#F8F8F8");var g=b.find('[data-sortable="true"]');a.each(g,function(a,b){this.enableSorting(b)}.bind(this))}}.bind(this)}),!1}var i=tinycolor(a(d.currentTarget).val());"undefined"!=typeof i&&(a(d.currentTarget).data("color",i),a(d.currentTarget).parent().find(".preview").css("background",i.toRgbString()))}.bind(this)),b.on("click",".btn-delete-color",function(b){var c=a(b.currentTarget).closest(".color"),d=c.data("id");return this.fire("swal",{template:"c-swal-block-color-delete",callback:function(){a.ajax({url:"/api/color/removeall/"+d,type:"DELETE",success:function(a){c.remove(),this.fire("swal",{template:"c-swal-block-color-deleted",type:"success"})}.bind(this)})}.bind(this)}),!1}.bind(this))}},onEnableEditing:function(b){var c=this.$ctx,d=a(".mod-document").data("editing");if(this.clip&&this.clip.destroy(),this.sortable)this.sortable.option("disabled",!1);else if(a("body").data("editor")&&!c.hasClass("referenced")&&d){var e=c.find('[data-sortable="true"]');a.each(e,function(a,b){this.enableSorting(b)}.bind(this))}var f=c.find(".palette-title"),g=c.find(".palette-description");"true"==f.attr("data-empty")&&f.text(f.data("placeholder")),"true"==g.attr("data-empty")&&g.text(g.data("placeholder"))},onDisableEditing:function(a){var b=this.$ctx;this.sortable&&this.sortable.option("disabled",!0);var c=b.find(".palette-title"),d=b.find(".palette-description");"true"==c.attr("data-empty")&&c.text(""),"true"==d.attr("data-empty")&&d.text("")}})}(Tc.$),function(a){Tc.Module.BlockColordownload=Tc.Module.extend({templates:[],$items:null,on:function(b){var c=this,d=this.$ctx;this.tpl=c.sandbox.getConfigParam("tpl");var e=a(".page").data("id"),f=d.parents("section").data("id");1>f&&(f=0);var g=d.data("block"),h=d.find(".palette-chooser");c.templates.item=this.tpl.compile("b-colordownload-item"),c.$items=a(".colors",d),d.on("click",".btn-choose-palettes",function(){h.toggle(),"true"==h.attr("data-visible")?h.removeAttr("data-visible"):h.attr("data-visible",!0)}),d.on("click",".palette-chooser > ul > li",function(){var b=a(this).closest("ul").find("li"),h=[];a.each(b,function(b,c){a(c).find("input").is(":checked")&&h.push(a(c).find("input").val())});var i={settings:{palettes:h}};a.ajax({url:"/api/document/block/"+e+"/"+f+"/"+g,data:JSON.stringify(i),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){b.success&&(d.find(".palettes > ul").empty(),a.each(h,function(b,c){var e=a('<li><input type="checkbox" name="palettes" data-id="'+c+'" /></li>');d.find(".palettes > ul").append(e)}),c.after())}})}),b()},after:function(){var b=this,c=this.$ctx,d=c.data("project"),e=(c.data("palette"),[]),f="/api/color/library/"+d;a.ajax({url:f,headers:{ReferenceToken:c.data("reference-hash")},success:function(d){var f=c.find(".palettes > ul > li > input");a.each(f,function(b,c){e.push(a(c).data("id"))}),b.$items.empty(),c.find(".palette-chooser > ul").empty();var g=0,h=a(".download",c).attr("href")+e.join(",");if(a(".download",c).attr("href",h),"undefined"==typeof d.palettes.length)a.each(d.palettes,function(d,f){f.name||(f.name="Unnamed Palette");var h=e.indexOf(parseInt(d));if(h>-1)var i=a('<li><label><input type="checkbox" name="palettes" value="'+d+'" checked />'+f.name+"</label></li>");else if(e.length>0)var i=a('<li><label><input type="checkbox" name="palettes" value="'+d+'" />'+f.name+"</label></li>");else{var i=a('<li><label><input type="checkbox" name="palettes" value="'+d+'" checked />'+f.name+"</label></li>");h=0}c.find(".palette-chooser > ul").append(i),h>-1&&a.each(f.colors,function(c,d){var e=a(b.templates.item(d));switch(50>g&&b.$items.append(e),d.type){case"SOLID":d.alpha<255?(e.find(".color-preview-opaque").css({backgroundColor:e.data("color-opaque")}),e.find(".color-preview-transparent").css({backgroundColor:e.data("color")})):e.find(".color-preview").css({backgroundColor:e.data("color")});break;case"GRADIENT":e.find(".color-preview").attr("style",d.css)}g++})});else if(0==d.palettes){var i=a("<li><span>no Color-Palettes found</li>");c.find(".palette-chooser > ul").append(i)}}})}})}(Tc.$),function(a){Tc.Module.BlockColorscale=Tc.Module.extend({templates:[],dragStarted:!1,$draggedColor:null,draggedColorWidth:null,$chooser:null,open:!1,on:function(b){var c=this,d=this.$ctx;this.tpl=c.sandbox.getConfigParam("tpl");var e=a(".page").data("id"),f=d.parents("section").data("id");1>f&&(f=0);var g=d.data("block");a(".resize",d);c.templates.tooltip=this.tpl.compile("b-colorscale-tooltip"),d.on("mousedown",".handle",function(b){var d=a(this).parent();c.$draggedColor=d,c.draggedColorWidth=d.width(),c.dragStarted=!0}),d.on("dblclick",".handle",function(b){c.dragStarted=!1;var e=a(this).parent(),f=796,g=a(".scale > .color",d);return a.each(g,function(b,c){var d=a(c).width(),g=a(c).data("id");g!=e.data("id")&&(f-=d)}),e.css("width",f),c.save(),!1}),d.on("mousemove",function(a){if(c.dragStarted){var b=parseInt(a.clientX-c.$draggedColor.offset().left);c.$draggedColor.css("width",b)}}),d.on("mouseup",function(a){c.dragStarted&&(c.save(),c.dragStarted=!1)}),a(".btn-add-color",d).on("click",function(){var b=a('<div class="color color-temporary" style="background: #EEE; width: 40px"><div class="handle"></div></div>');a(".scale",d).append(b),a(".color-chooser",d).hide(),b.append(c.$chooser.clone())}),d.on("click",".color-chooser .color",function(b){var e=a(this).closest(".color-chooser").parent();return e.css("background",a(this).data("hex")),e.data("id",a(this).data("id")),e.removeClass("color-temporary"),a(".color-chooser",d).hide(),c.save(),!1}),d.on("click",".btn-change-size",function(){var b=a(this).data("size"),h={settings:{size:b}};return d.find(".scale").removeClass("scale-small"),d.find(".scale").removeClass("scale-tall"),d.find(".scale").addClass("scale-"+b),a.ajax({url:"/api/document/block/"+e+"/"+f+"/"+g,data:JSON.stringify(h),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success}}),c.save(),!1}),b()},after:function(){var b=this,c=this.$ctx,d=c.data("project"),e="/api/color/library/"+d;a.ajax({url:e,success:function(c){b.$chooser=a(b.templates.tooltip(c))}})},save:function(){var b=this.$ctx,c=a(".page").data("id"),d=b.parents("section").data("id");1>d&&(d=0);var e=b.data("block"),f=a(".scale > .color",b),g={settings:{colors:[]}};a.each(f,function(b,c){var d=a(c).width(),e=a(c).data("id");e>0&&g.settings.colors.push({id:e,width:d})}),a.ajax({url:"/api/document/block/"+c+"/"+d+"/"+e,data:JSON.stringify(g),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success}})}})}(Tc.$),function(a){Tc.Module.BlockDownloads=Tc.Module.extend({templates:[],sortable:null,on:function(b){var c=this,d=this.$ctx;this.tpl=c.sandbox.getConfigParam("tpl"),this.templates.item=this.tpl.compile("b-downloads-item"),this.data=this.sandbox.getConfigParam("data"),this.data=this.sandbox.getConfigParam("data"),c.sandbox.subscribe("events",c);var e=(d.data("block"),d.parents(".page").data("id"),d.parents("section").data("id"));"undefined"==typeof e&&(e=0),a(".btn-toggle-editing").on("click",function(){a(".mod-document").hasClass("editor-enabled")&&d.data("editable")&&a('[data-editable="true"]',d).attr("contenteditable",!0)}),a(".mod-document").hasClass("editor-enabled")&&d.data("editable")&&a('[data-editable="true"]',d).attr("contenteditable",!0),d.on("click",".download:not(.btn-upload)",function(b){return a(".mod-document").hasClass("editor-enabled")?(b.stopPropagation(),!1):void 0});var f=d.find('[data-sortable="true"]');a.each(f,function(a,b){c.enableSorting(b)}),(a(".mod-document").data("editor")||a(".mod-document").data("translator"))&&(d.on("click",".js-download > a",function(b){return a(".mod-document").hasClass("editor-enabled")?(b.stopPropagation(),!1):void 0}),d.on("blur",'h4[data-editable="true"]',function(b){var e=a(this).closest(".download"),f=e.data("id"),g=a(this),h={settings:{}};return h.settings["downloads[attachment="+f+"]"]={title:g.text(),id:e.data("translation-id")},c.data.updateBlock(d,h),!1}),d.on("keydown","[contenteditable]",function(b){return 13===b.keyCode?(a(this).trigger("blur"),window.getSelection().removeAllRanges(),!1):void 0})),a(document).on("click",function(){a(".js-settings-wrapper").removeClass("state-open")}),b()},after:function(){var b=this,c=this.$ctx,d=(c.data("block"),c.parents(".page").data("id"),c.parents("section").data("id"));a("body").data("hub");"undefined"==typeof d&&(d=0),c.on("click",".js-settings",function(b){var c=a(this).closest(".js-settings-wrapper");c.hasClass("state-open")?c.removeClass("state-open"):(a(".js-settings-wrapper").removeClass("state-open"),c.addClass("state-open"))}),c.on("click",".js-action-delete",function(d){var e=a(this);return b.fire("swal",{template:"c-swal-block-downloads-delete",closeOnConfirm:!0,callback:function(){var d=e.closest(".js-download"),f={settings:{}};f.settings["downloads[attachment="+d.attr("data-id")+"]"]=null,b.data.updateBlock(c,f),a(".mod-document").data("translation-language")||b.deleteAttachment(d.attr("data-id")),d.remove()}}),!1}),c.on("click",".js-action-replace",function(){var b=a(".js-file-replace-form",c),d=a(this).closest(".js-download");b.find(".js-asset-id",c).val(d.attr("data-id")),b.find(".js-replace-file-field",c).trigger("click")}),a(".js-replace-file-field",c).fileupload({dataType:"json",dropZone:a(".upload-dropzone-replacer",c),add:function(d,e){var f=a(e.form.context),g=f.find(".js-asset-id").val();if("undefined"==typeof g||0==g)return!1;e.assetId=g;var h=a(b.templates.item(e.originalFiles));b.data.checkStorageLimit(e.files[0].size).then(function(){h.append(a('<div class="loading"><div class="progress"></div></div>'));var d=e.files[0].name;h.find("h4").text(d),h.find(".ico").addClass("ico-"+d.split(".").pop()),h.find(".meta span").text(b.humanFileSize(e.files[0].size)+" - "+d.split(".").pop()),a('.js-downloads li[data-id="'+e.assetId+'"]',c).after(h),a('.js-downloads li[data-id="'+e.assetId+'"]',c).remove(),e.context=h,e.submit()})},progress:function(b,c){var d=parseInt(c.loaded/c.total*100,10);a(".progress",c.context).css("width",d+"%")},done:function(d,e){if(a(".mod-document").data("translation-language")||b.deleteAttachment(e.assetId),e.result&&e.result[0]){b.data.updateStorageUsage(e.result[0].size);var f={settings:{}},g={attachment:e.result[0].id,title:e.result[0].filename};a(".mod-document").data("translation-language")&&(g.translated=!0),f.settings["downloads[attachment="+e.assetId+"]"]=g,b.data.updateBlock(c,f);var h=e.result[0].id;e.context.find(".loading").remove(),e.context.find(".js-download-link").attr("href","/api/attachment/download/"+h),e.context.find(".js-action-download").attr("href","/api/attachment/download/"+h),e.context.attr("data-id",h)}}}),a(".fileupload-download",c).fileupload({dataType:"json",dropZone:a(".upload-dropzone",c),add:function(d,e){var f=a(b.templates.item(e.originalFiles));Math.round(e.files[0].size/1024,0);b.data.checkStorageLimit(e.files[0].size).then(function(){f.find(".js-ico").after(a('<div class="loading"><div class="progress"></div></div>'));var d=e.files[0].name;f.find("h4").text(d);var g=b.humanFileSize(e.files[0].size)+" - "+d.split(".").pop();f.find(".meta span").text(g),a(".js-downloads",c).append(f),e.context=f,e.submit(),e.submit()})},progress:function(b,c){var d=parseInt(c.loaded/c.total*100,10);a(".progress",c.context).css("width",d+"%")},done:function(a,d){if(d.result&&d.result[0]){var e={settings:{"downloads[]":{attachment:d.result[0].id,title:d.result[0].filename,id:d.result[0].id}}};b.data.updateBlock(c,e);var f=d.result[0].id;d.context.find(".loading").remove(),d.context.find(".js-download-link").attr("href","/api/attachment/download/"+f),d.context.find(".js-action-download").attr("href","/api/attachment/download/"+f),d.context.find(".js-ico").addClass("ico-"+d.result[0].ext_class),d.context.attr("data-id",f)}}})},humanFileSize:function(a){var b=Math.floor(Math.log(a)/Math.log(1024));return Math.ceil(1*(a/Math.pow(1024,b)).toFixed(2))+" "+["B","KB","MB","GB","TB"][b]},deleteAttachment:function(b){a.ajax({url:"/api/attachment/remove/"+b,type:"GET",success:function(a){}})},enableSorting:function(b){var c=this.$ctx,d=this,e=(a(".page").data("id"),c.parents("section").data("id"));1>e&&(e=0),this.sortable=Sortable.create(b,{group:"download",ghostClass:"sortable-ghost",handle:".js-drag-handle",onUpdate:function(b){if(b.oldIndex!==b.newIndex){var e=(c.data("block"),[]);a.each(c.find(".js-downloads > li"),function(b,c){var d=a(c),f={attachment:d.attr("data-id"),title:d.find("h4").text(),id:d.attr("data-translation-id")};e.push(f)});var f={settings:{downloads:e}};d.data.updateBlock(c,f)}}})}})}(Tc.$),function(a){Tc.Module.BlockExample=Tc.Module.extend({on:function(b){var c=this.$ctx,d=a(".page").data("id"),e=c.closest("section").data("id");1>e&&(e=0);var f=c.data("block");a(".btn-toggle-editing").on("click",function(){a(".mod-document").hasClass("editor-enabled")?a('[data-editable="true"]',c).attr("contenteditable",!0):a('[data-editable="true"]',c).removeAttr("contenteditable")}),c.on("keydown",'[data-editable="true"]',function(b){return 13==b.keyCode?(a(this).trigger("blur"),window.getSelection().removeAllRanges(),!1):void 0}),c.on("blur",'[data-editable="true"]',function(b){var c=a(this).html(),g={settings:{content:c}};a.ajax({url:"/api/document/block/"+d+"/"+e+"/"+f,data:JSON.stringify(g),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success}})}),b()},after:function(){var b=this.$ctx;a(".mod-document").hasClass("editor-enabled")&&b.find('[data-editable="true"]').attr("contenteditable",!0)}})}(Tc.$),function(a){Tc.Module.Blockfontdownload=Tc.Module.extend({templates:[],$items:null,on:function(b){var c=this,d=this.$ctx;this.tpl=c.sandbox.getConfigParam("tpl"),c.templates.item=this.tpl.compile("b-fontdownload-item"),c.$items=a(".colors",d),b()},after:function(){var b=this,c=this.$ctx,d=c.data("project"),e=(c.data("palette"),"/api/color/library/"+d);a(".download",c).attr("href","/api/color/export/"+d+"/zip"),a.ajax({url:e,success:function(c){b.$items.empty(),a.each(c.palettes,function(c,d){a.each(d.colors,function(c,d){var e=a(b.templates.item(d));switch(b.$items.append(e),d.type){case"SOLID":d.alpha<255?(e.find(".color-preview-opaque").css({backgroundColor:e.data("color-opaque")}),e.find(".color-preview-transparent").css({backgroundColor:e.data("color")})):e.find(".color-preview").css({backgroundColor:e.data("color")});break;case"GRADIENT":e.find(".color-preview").attr("style",d.css)}})})}})}})}(Tc.$),function(a){Tc.Module.BlockIcons=Tc.Module.extend({templates:[],$items:null,on:function(b){var c=this,d=this.$ctx;this.tpl=c.sandbox.getConfigParam("tpl"),this.data=c.sandbox.getConfigParam("data"),c.sandbox.subscribe("events",c),c.templates.item=this.tpl.compile("b-icons-item"),c.templates.item_svg=this.tpl.compile("b-icons-item-svg"),c.$items=a(".library .icons",d),d.on("click",".color-selector a",function(){d.find(".color").removeClass("active"),a(this).addClass("active");var b=a(this).data("color");a(".icons",d).css("color",b)}),a(".btn-toggle-editing").on("click",function(){a(".mod-document").hasClass("editor-enabled")?a('[data-editable="true"]',d).attr("contenteditable",!0):a('[data-editable="true"]',d).removeAttr("contenteditable")}),a(".mod-document").hasClass("editor-enabled")&&d.find('[data-editable="true"]').attr("contenteditable",!0),d.on("blur",'.library-title[data-editable="true"]',function(b){var c=(a(this),d.data("library")),e=a(this).data("field");if(e){var f=a(this).text(),g={id:c};g[e]=f,a.ajax({url:"/api/icon/library/"+c,dataType:"json",data:JSON.stringify(g),type:"POST",success:function(a){a.success}})}}),d.on("keydown",'[data-editable="true"]',function(b){return 13==b.keyCode?(a(this).trigger("blur"),window.getSelection().removeAllRanges(),
!1):void 0}),d.on("click",".dropzone",function(){a(".fileupload",d).trigger("click")}),d.on("click",".icons-provider .nav a",function(){var b=a(this).data("tab");d.find(".icons-provider .nav li.active").removeClass("active"),a(this).find("li").addClass("active"),d.find(".provider-content.active").removeClass("active"),d.find(".tab-"+b).addClass("active")}),b()},update:function(){var b=this,c=this.$ctx,d=c.data("library"),e="/api/icon/library/"+d;a.ajax({url:e,headers:{ReferenceToken:c.data("reference-hash")},success:function(d){var e=b.$items.find(".col-left"),f=b.$items.find(".col-middle"),g=b.$items.find(".col-right");if(e.empty(),f.empty(),g.empty(),d.icons){a(".placeholder",c).hide();var h=d.icons.length,i="item";d.svg_support&&(i="item_svg",a(".svg-wrapper",c).html(d.html)),a.each(d.icons,function(c,d){var j=a(b.templates[i](d));c>h/3*2?g.append(j):c>h/3?f.append(j):e.append(j)})}else a(".placeholder",c).show(),a("body").hasClass("editor-enabled")&&a(".icons-provider",c).show();d.library&&(a(".library-title",c).text(d.library.name),a("style",c).text(d.css_live))}})},after:function(){var b=this,c=this.$ctx;a("body").data("hub");b.update();var d=a(".page").data("id"),e=c.parents("section").data("id");1>e&&(e=0);var f=c.data("block");a(".fileupload",c).fileupload({dataType:"json",dropZone:a(".dropzone",c),add:function(a,c){var d=Math.round(c.files[0].size/1024,0);b.data.checkStorageLimit(d).then(function(){c.submit()})},done:function(g,h){if(h.result&&h.result[0]){var i={settings:{library:h.result[0].library_id,asset:h.result[0].id}},j=h.result[0].downloadhash;a.ajax({url:"/api/document/block/"+d+"/"+e+"/"+f,data:JSON.stringify(i),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){b.success&&(a(".btn-download-library",c).attr("href","/api/icon/download/"+j),c.addClass("icons-available"),c.addClass("icons-block-"+i.settings.library))}}),c.data("library",i.settings.library),c.data("asset",i.settings.asset),b.update(),a(".icons-provider",c).hide()}}})},onEnableEditing:function(b){var c=this.$ctx;c.hasClass("icons-available")||a(".icons-provider",c).show()},onDisableEditing:function(b){var c=this.$ctx;a(".icons-provider",c).hide()}})}(Tc.$),function(a){Tc.Module.BlockImage=Tc.Module.extend({on:function(b){var c=this,d=this.$ctx;this.tpl=this.sandbox.getConfigParam("tpl"),this.data=this.sandbox.getConfigParam("data"),this.$loader=a(this.tpl.render("progress",{id:c.id})),this.settings=null,this.isTranslator=a("body").data("translation-language")&&"1"==a("body").data("translator"),c.sandbox.addModules(this.$loader),c.sandbox.subscribe("events",c),d.on("click",".js-b-image__settings",function(b){var c=a(b.currentTarget);if(c.hasClass("state-open"))c.closest(".js-b-image__actions").removeClass("state-open");else{c.closest(".js-b-image__actions").addClass("state-open");var e=d.data("block"),f=c.next(".js-cm-btn-dropdown__menu");f.html(this.tpl.render("c-loader")),this.data.get("/api/document/block/"+e).then(function(a){a.data.translator_only=this.isTranslator,f.html(this.tpl.render("b-image-settings",a.data)),this.settings=new Tc.Module.CSettings(f.find(".js-b-image__settings-overlay"),this.sandbox);var b=this.settings.getSetting("border");b.saved=function(a){var b=d.find(".js-b-image__canvas");a.border?b.addClass("bordered"):b.removeClass("bordered"),this.data.updateBlock(d,{settings:{border:a.border}})}.bind(this);var c=this.settings.getSetting("retina");c.saved=function(a){var b=d.find(".js-b-image__canvas");a.retina?b.addClass("retina"):b.removeClass("retina"),this.updateImage(),this.data.updateBlock(d,{settings:{retina:a.retina}})}.bind(this);var e=this.settings.getSetting("downloadable");e.saved=function(a){var b=d.find(".btn-download");d.find(".js-b-image__inherited").remove(),a.downloadable?b.show():b.hide(),this.data.updateBlock(d,{settings:{downloadable:a.downloadable,downloadable_inherited:!1}})}.bind(this);var g=this.settings.getSetting("background");g.saved=function(a){var b=d.find(".js-b-image__canvas");b.css({"background-color":a.background}),this.data.updateBlock(d,{settings:{background:a.background}})}.bind(this);var h=this.settings.getSetting("padding");h.saved=function(a){var b=d.find(".js-b-image__canvas");b.css({padding:a.padding+"px"}),this.data.updateBlock(d,{settings:{padding:a.padding}})}.bind(this)}.bind(this))}}.bind(this)),d.on("click",".js-b-image__replace",function(b){a(".js-m-dropzone__upload",d).trigger("click")}),d.on("click",".btn-change-mode",function(){var b=a(this).data("mode"),e={settings:{mode:b}},f=d.find(".js-b-image__wrap");return f.removeClass("mode-original"),f.removeClass("mode-figure"),f.addClass("mode-"+b),c.data.updateBlock(d,e),!1}),d.on("click",".btn-replace",function(b){a(".js-m-dropzone__upload",d).trigger("click")}),d.on("click",".js-b-image__canvas-gif-replay",function(a){var b=d.find(".b-image__image"),c=b.attr("src");b.attr("src",c),a.stopPropagation()}),a(".mod-document").hasClass("editor-enabled")&&d.find(".js-b-image__caption").attr("contenteditable",!0),d.on("blur",".js-b-image__caption",function(b){var e=a(this),f={settings:{caption:e.html()}};return c.data.updateBlock(d,f),!1}),b()},after:function(){var b=this,c=this.$ctx;b.updateImage(),a(".js-m-dropzone__upload",c).fileupload({dataType:"json",dropZone:a(".js-m-dropzone",c),add:function(a,c){var d=Math.round(c.files[0].size/1024,0);b.data.checkStorageLimit(d).then(function(){c.submit()})},start:function(){var d=a(".js-m-dropzone",c);d.find(".icon-image").replaceWith(b.$loader)},progress:function(a,c){var d=parseInt(c.loaded/c.total*100,10);b.fire("progress",{id:b.id,progress:d})},done:function(d,e){if(e.result&&e.result[0]){this.data.updateStorageUsage(!0);var f=c.find(".js-b-image__figure"),g=e.result[0].name,h=h||e.result[0].name.indexOf("2x")>0,i=f.find(".js-b-image__canvas");if(f.length>0||this.isTranslator)g=f.find(".js-b-image__caption").text(),h=i.hasClass("retina");else{var j=a(".js-m-dropzone__upload",c);j.attr("name","files_replace"),j.fileupload("option","url","/api/screen/replace/"+e.result[0].id)}var k={settings:{asset:e.result[0].id,caption:g,retina:h}};b.data.updateBlock(c,k),c.find(".btn-download").attr("href","/api/screen/download/"+e.result[0].hash),a(".js-b-image__wrap",c).html(b.tpl.render("b-image-figure",{id:e.result[0].id,thumbnail_url:"/api/screen/thumbnail/"+e.result[0].hash,caption:g,retina:h,border:i.hasClass("bordered"),padding:parseInt(i.css("padding")),viewer:e.result[0].hash,height:e.result[0].height,width:e.result[0].width,background:i.css("background-color")||"transparent"})),c.addClass("state-available"),b.updateImage()}}.bind(this)})},updateImage:function(){var b=this,c=this.$ctx,d=a(".js-b-image__canvas",c),e=d.hasClass("retina")?2*d.parent().width():d.parent().width(),f=d.data("width")||500,g=Math.min(f,e);0==g&&(g=f);var h=a(".mod-document").data("cdn")+d.data("src")+"/"+g;if(!d.data("src"))return!1;var i=new Image;i.onload=function(){var a=i.width;a=d.hasClass("retina")?g/2:g,d.find("img").length>0?d.find("img").replaceWith('<img class="b-image__image" src="'+h+'" alt="'+d.data("alt")+'" width="'+a+'" />'):d.append('<img class="b-image__image" src="'+h+'" alt="'+d.data("alt")+'" width="'+a+'" />'),b.fire("BlockReady",{block:c.data("block")},function(){})},i.src=h},onEnableEditing:function(a){var b=this.$ctx;b.hasClass("referenced")||b.find(".js-b-image__caption").attr("contenteditable",!0)},onDisableEditing:function(a){var b=this.$ctx;b.find(".js-b-image__caption").removeAttr("contenteditable"),this.fire("closeDropdown",b.find(".js-b-image__settings"))},getViewerInfo:function(b,c){var d=this.$ctx,e=a.extend({},c);c.caption&&("figure"==c.mode?e.description=c.caption:e.title=c.caption);var f=d.find(".js-b-image__canvas");return e.background=f.css("background-color"),e}})}(Tc.$),function(a){Tc.Module.BlockImagegrid=Tc.Module.extend({templates:[],sortable:null,on:function(b){var c=this.$ctx;this.data=this.sandbox.getConfigParam("data"),this.tpl=this.sandbox.getConfigParam("tpl"),this.$loader=a(this.tpl.render("progress",{id:this.id}));var d=this;d.sandbox.addModules(this.$loader),d.sandbox.subscribe("events",d),c.on("click",".btn-toggle-border",function(){var b=a(this).data("enabled"),e={settings:{border:!b}},f=c.find(".grid .image");return b?(f.removeClass("bordered"),a(this).data("enabled",!1)):(f.addClass("bordered"),a(this).data("enabled",!0)),d.data.updateBlock(c,e),!1}),c.on("click",".btn-remove",function(){var b=a(this).parents(".item").data("asset"),e={settings:{}};return e.settings["assets[asset="+b+"]"]=null,a(this).closest(".item").remove(),d.data.updateBlock(c,e),a.ajax({url:"/api/assets/"+b,type:"DELETE",success:function(a){d.data.updateStorageUsage(!0)}}),!1}),c.find(".js-co-viewer__open").on("click",function(b){var c=a(this),d=c.find("a");"javascript:;"===d.attr("href")||a(".mod-document").hasClass("editor-enabled")||b.stopPropagation()}),c.on("click",".btn-link",function(b){var e=a(this).parents(".item"),f=e.data("asset"),g=e.find("figcaption").text(),h=e.find(".js-image-link").attr("href"),i=a('[data-modal-id="block"] .js-cm-modal__content'),j={url:h},k=a(d.tpl.render("b-imagegrid-settings",j));i.html(k),d.fire("openModal",{id:"block"}),k.on("click",".btn-done",function(){i.removeClass("has-error"),d.fire("closeModal",{id:"block"})}),k.on("click",".btn-save",function(){var b=a(this).parent(".mod-frontify-modal").find(".js-url-field").val();/^(f|ht)tps?:\/\//i.test(b)||(b="http://"+b);var h=/^(http|https|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(b);if(!h)return i.hasClass("has-error")||(i.addClass("has-error"),i.find(".js-url-field-wrapper").after('<span style="display: block; margin-bottom: 20px; color: #D0021B">Your link is invalid, please check if your url begins with http(s)://</span>')),!1;var j={settings:{}};j.settings["assets[asset="+f+"]"]={asset:f,url:b,caption:g},d.data.updateBlock(c,j).then(function(){e.find(".js-image-link").attr("href",b).addClass("state-active")}),i.removeClass("has-error"),d.fire("closeModal",{id:"block"})}),k.on("click",".btn-remove",function(){var a={settings:{}};a.settings["assets[asset="+f+"]"]={asset:f,url:"",caption:g},d.data.updateBlock(c,a).then(function(){e.find(".js-image-link").attr("href","javascript:;").removeClass("state-active")}),i.removeClass("has-error"),d.fire("closeModal",{id:"block"})}),b.stopPropagation()}),c.on("click",".btn-download",function(a){a.stopPropagation()}),c.on("click",".btn-replace",function(b){b.stopPropagation();var d=a(".js-imagegrid-replace-form",c),e=a(b.currentTarget).closest(".item").data("asset");d.find(".js-asset-id",c).val(e),d.find(".js-b-imagegrid__replace",c).trigger("click")}.bind(this)),b()},update:function(){var b=this,c=this.$ctx,d=a(".item",c);a.each(d,function(b,c){var d=a(c).find(".image"),e=2*a(c).width(),f=a(".mod-document").data("cdn")+d.data("src")+"/"+e;d.find("img").length>0?d.find("img").replaceWith('<img src="'+f+'" alt="'+d.data("alt")+'" />'):d.append('<img src="'+f+'" alt="'+d.data("alt")+'" />')}),b.fire("BlockReady",{block:c.data("block")},function(){})},after:function(){var b=this,c=this.$ctx;a("body").data("hub");b.update(),c.on("click",".btn-change-grid",function(){var d=a(this).data("columns"),e={settings:{columns:d}};return c.find(".grid").removeClass("grid-2"),c.find(".grid").removeClass("grid-3"),c.find(".grid").removeClass("grid-4"),c.find(".grid").addClass("grid-"+d),b.data.updateBlock(c,e),b.update(),!1}),a(".mod-document").hasClass("editor-enabled")&&c.find("figcaption,.title").attr("contenteditable",!0),c.on("blur",".title",function(d){var e=a(this),f=a(this).closest(".item").data("asset"),g={settings:{}};g.settings["assets[asset="+f+"]"]={title:e.html()},b.data.updateBlock(c,g)}),c.on("blur","figcaption",function(d){var e=a(this),f=a(this).parents(".item").data("asset"),g={settings:{}};g.settings["assets[asset="+f+"]"]={caption:e.html()},b.data.updateBlock(c,g)}),c.on("keypress",".title",function(b){return 13==b.keyCode?(a(this).trigger("blur"),!1):void 0}),a(".js-b-imagegrid__replace",c).fileupload({dataType:"json",add:function(b,c){var d=this.$ctx,e=Math.round(c.files[0].size/1024,0),f=a(c.form.context),g=f.find(".js-asset-id").val();return"undefined"==typeof g||0==g?!1:(c.assetId=g,void this.data.checkStorageLimit(e).then(function(){c.context=a('<li class="item"></li>');var b=a('<div class="loading"><div class="progress"></div></div>'),e=a('.item[data-asset="'+c.assetId+'"]',d);if(c.$entry=e,window.File&&window.FileList&&window.FileReader){var f=new FileReader;f.onload=function(d){var f=a('<img class="preview" src="'+d.target.result+'" />');c.context.append(b),c.context.append(f),e.replaceWith(c.context),c.submit()},f.readAsDataURL(c.files[0])}}))}.bind(this),progress:function(b,c){var d=parseInt(c.loaded/c.total*100,10);a(".progress",c.context).css("width",d+"%")},progressall:function(a,c){var d=parseInt(c.loaded/c.total*100,10);b.fire("progress",{id:b.id,progress:d})},stop:function(a,d){b.$loader.detach(),c.find(".dropzone .icon-image").show(),b.fire("progressReset",{id:b.id})},done:function(d,e){var f=e.$entry;if(a(".mod-document").data("translation-language")||b.deleteAsset(e.assetId),e.result&&e.result[0]){this.data.updateStorageUsage(!0);var g={settings:{}},h={asset:e.result[0].id,title:e.result[0].filename,caption:"",id:f.data("id")};a(".mod-document").data("translation-language")&&(h.translated=!0),g.settings["assets[asset="+f.data("asset")+"]"]=h,b.data.updateBlock(c,g);var i=e.result[0].id,j=a(".mod-document").data("cdn")+"/api/screen/thumbnail/"+e.result[0].hash,k='<li class="item" data-asset="'+i+'">';k+='<figure data-href="/api/screen/download/'+i+'">',k+='<div class="image js-co-viewer__open" data-o-viewer-hash="'+e.result[0].hash+'" data-src="/api/screen/thumbnail/'+e.result[0].hash+'"><a href="javascript:;" class="js-image-link"><div class="overlay"></div></a>',k+='<div class="inline-actions">',k+='<a href="'+j+'" class="btn btn-icon btn-download"><i class="icon-download"></i></a>',a(".mod-document").data("translation-language")||(k+='<button class="btn btn-editor btn-icon btn-link"><i class="icon-link"></i></button>',k+='<button class="btn btn-editor btn-icon btn-remove"><i class="icon-trash"></i></button>'),k+='<button class="btn btn-editor btn-icon btn-replace"><i class="icon-upload"></i></button>',k+="</div>",k+='</div><div class="title" placeholder="Title" contenteditable="true">'+e.result[0].name+'</div><figcaption contenteditable="true" placeholder="Add a description..."></figcaption></figure>';var l=a(k);if(l.data("asset",i),a(".btn-toggle-border",c).data("enabled")&&l.find(".image").addClass("bordered"),l.find(".image").append('<img src="'+j+'" />').data("alt",e.result[0].name),e.context.replaceWith(l),a("body").data("editor")&&!a(".mod-document").data("translation-language")){var m=c.find('[data-sortable="true"]');a.each(m,function(a,c){b.enableSorting(c)})}}}.bind(this)}),a(".fileupload",c).fileupload({dataType:"json",dropZone:a(".dropzone",c),add:function(d,e){var f=Math.round(e.files[0].size/1024,0);b.data.checkStorageLimit(f).then(function(){e.context=a('<li class="item"></li>');var b=a('<div class="loading"><div class="progress"></div></div>');if(window.File&&window.FileList&&window.FileReader){var d=new FileReader;d.onload=function(d){var f=a('<img class="preview" src="'+d.target.result+'" />');e.context.append(b),e.context.append(f),a(".grid",c).append(e.context),e.submit()},d.readAsDataURL(e.files[0])}else e.context.append(b),a(".grid",c).append(e.context),e.submit()})},start:function(){var d=a(".dropzone",c);d.find(".icon-image").hide().after(b.$loader)},progress:function(b,c){var d=parseInt(c.loaded/c.total*100,10);a(".progress",c.context).css("width",d+"%")},progressall:function(a,c){var d=parseInt(c.loaded/c.total*100,10);b.fire("progress",{id:b.id,progress:d})},stop:function(a,d){b.$loader.detach(),c.find(".dropzone .icon-image").show(),b.fire("progressReset",{id:b.id})},done:function(d,e){if(e.result&&e.result[0]){this.data.updateStorageUsage(!0);var f={settings:{"assets[]":{asset:e.result[0].id,title:e.result[0].name,caption:"",id:e.result[0].id}}};b.data.updateBlock(c,f);var g=e.result[0].id,h=a(".mod-document").data("cdn")+"/api/screen/thumbnail/"+e.result[0].hash,i='<li class="item" data-asset="'+g+'">';i+='<figure data-href="/api/screen/download/'+g+'">',i+='<div class="image js-co-viewer__open" data-o-viewer-hash="'+e.result[0].hash+'" data-src="/api/screen/thumbnail/'+e.result[0].hash+'"><a href="javascript:;" class="js-image-link"><div class="overlay"></div></a>',i+='<div class="inline-actions">',i+='<a href="'+h+'" class="btn btn-icon btn-download"><i class="icon-download"></i></a>',i+='<button class="btn btn-editor btn-icon btn-link"><i class="icon-link"></i></button>',i+='<button class="btn btn-editor btn-icon btn-remove"><i class="icon-trash"></i></button>',i+='<button class="btn btn-editor btn-icon btn-replace"><i class="icon-upload"></i></button>',i+="</div>",i+='</div><div class="title" placeholder="Title" contenteditable="true">'+e.result[0].name+'</div><figcaption contenteditable="true" placeholder="Add a description..."></figcaption></figure>';var j=a(i);if(j.data("asset",g),a(".btn-toggle-border",c).data("enabled")&&j.find(".image").addClass("bordered"),j.find(".image").append('<img src="'+h+'" />').data("alt",e.result[0].name),e.context.replaceWith(j),a("body").data("editor")&&!a(".mod-document").data("translation-language")){var k=c.find('[data-sortable="true"]');a.each(k,function(a,c){b.enableSorting(c)})}}}.bind(this)})},enableSorting:function(b){var c=this.$ctx,d=this;d.sortable=Sortable.create(b,{group:"images",handle:".image",ghostClass:"sortable-ghost",onUpdate:function(b){var e=[];a.each(c.find("ul > li"),function(b,c){var d={asset:a(c).data("asset"),title:a(c).find(".image").data("alt"),caption:a(c).find("figcaption").html(),url:a(c).find(".js-image-link").attr("href"),id:a(c).data("id")};e.push(d)});var f={settings:{assets:e}};d.data.updateBlock(c,f)}})},onDisableEditing:function(b){var c=this.$ctx,d=this;a("figcaption,.title",c).removeAttr("contenteditable"),d.sortable&&d.sortable.option("disabled",!0)},onEnableEditing:function(b){var c=this.$ctx,d=this;if(a("figcaption,.title",c).attr("contenteditable",!0),d.sortable)d.sortable.option("disabled",!1);else if(a("body").data("editor")&&!a(".mod-document").data("translation-language")){var e=c.find('[data-sortable="true"]');a.each(e,function(a,b){d.enableSorting(b)})}},getViewerInfo:function(b,c){var d=(this.$ctx,a.extend({},c));if(a.isArray(c.assets)){var e=c.assets.map(function(a){return parseInt(a.asset)}).indexOf(parseInt(b));d.title=c.assets[e].title,d.description=c.assets[e].caption}return d},deleteAsset:function(b){a.ajax({url:"/api/screen/delete/"+b,type:"GET",success:function(a){}})}})}(Tc.$),function(a){Tc.Module.BlockMedia=Tc.Module.extend({on:function(a){var b=this.$ctx;this.tpl=this.sandbox.getConfigParam("tpl"),this.data=this.sandbox.getConfigParam("data"),this.sandbox.subscribe("events",this),b.on("click",".btn-embed",function(){this.embed()}.bind(this)),a()},embed:function(){var b=this.$ctx,c=b.find(".fld-url"),d=b.find(".media-add"),e=b.find(".embed"),f=a(this.tpl.render("loader")),g=a.trim(c.val()),h={url:g};d.after(f),a.ajax({url:"/api/oembed/embed/",data:JSON.stringify(h),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){f.remove(),a.success?(h={settings:{url:g,media:a.media,html:a.media.html}},e.html(a.media.html),d.remove(),this.data.updateBlock(b,h).then(function(a){this.fire("BlockReady",{block:b.data("block")},function(){})}.bind(this))):this.displayError(b.data("text-error-title"),b.data("text-error-description"))}.bind(this)})},displayError:function(a,b){swal({title:a,text:b,type:"error",showCancelButton:!1,confirmButtonText:"OK",closeOnConfirm:!0})}})}(Tc.$),function(a){Tc.Module.BlockPattern=Tc.Module.extend({templates:[],$items:null,codemirror_html:null,codemirror_css:null,codemirror_js:null,errors:{},on:function(b){var c=this,d=this.$ctx;this.tpl=c.sandbox.getConfigParam("tpl"),c.data=this.sandbox.getConfigParam("data"),c.sandbox.subscribe("events",c),c.templates.item=this.tpl.compile("b-pattern-item"),c.templates.visibility=this.tpl.compile("b-pattern-visibility"),c.$items=a(".patterns",d),a(".mod-document").hasClass("editor-enabled")&&!d.hasClass("referenced")&&a('[data-editable="true"]',d).attr("contenteditable",!0),d.on("click",".code-error",function(){var b=a(this);b.removeClass("state-error");var d=b.closest(".code-editor").data("type"),e=c.errors[d];e&&(a(e.node).removeClass("inline-error-hidden"),c.errors[d].changed())}),d.on("click",".btn-change-breakpoint",function(){if(a(this).data("width")>800){a(".document-sidebar").fadeOut("fast");var b=(a(this).data("width")-800)/2;a("iframe",d).animate({width:a(this).data("width"),marginLeft:-b,marginRight:-b},function(){c.resize()})}else a(".document-sidebar").fadeIn("fast"),a("iframe",d).animate({width:a(this).data("width"),marginLeft:0,marginRight:0},function(){c.resize()})}),d.on("blur",'.pattern-title[data-editable="true"], .pattern-description[data-editable="true"]',function(b){if(a(".mod-document").hasClass("editor-enabled")){var c=a(this),e={};e[c.data("field")]=c.text(),a.ajax({url:"/api/patterns/"+d.data("pattern"),dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",method:"PUT",success:function(a){a.success}})}}),d.on("keydown",'[data-editable="true"]',function(b){return a(".mod-document").hasClass("editor-enabled")&&13==b.keyCode?(a(this).trigger("blur"),window.getSelection().removeAllRanges(),!1):void 0}),d.on("click",".visibility",function(){if(a(".mod-document").hasClass("editor-enabled")){var b=a(this).hasClass("state-private")?"public":"private";c.data.updateBlock(d,{settings:{visibility:b}}),c.renderVisibility(b)}}),d.on("click",".nav li",function(){var b=a(this).closest("ul").find("li.active"),d=a(this).closest(".code").find(".code-editor.active");b.removeClass("active"),d.removeClass("active");a(this).closest(".code").find(".code-editor."+a(this).data("tab")).addClass("active");a(this).addClass("active"),c.codemirror_html.refresh(),c.codemirror_css.refresh(),c.codemirror_js.refresh()}),b()},after:function(){var b=this,c=this.$ctx,d=c.data("block"),e=c.data("pattern"),f=c.parents(".page").data("id"),g=c.parents("section").data("id");if(1>g&&(g=0),a(".btn-create-pattern",c).on("click",function(){var e={project:c.data("project"),name:c.data("txt-placeholder-title"),granularity:"ATOM",mode:"CODE"};c.addClass("available"),a.ajax({url:"/api/patterns",method:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(e),success:function(e){if(e.success){c.data("pattern",e.pattern.id);var h={settings:{id:e.pattern.id}};a.ajax({url:"/api/document/block/"+f+"/"+g+"/"+d,data:JSON.stringify(h),contentType:"application/json; charset=utf-8",method:"POST",success:function(a){a.success}}),b.loadPattern(e.pattern.id)}}})}),e>0)b.initializeCode(),b.fire("BlockReady",{block:c.data("block")});else{var h=a(".btn-choose-pattern select",c);a.ajax({url:"/api/patterns/list/"+c.data("project"),dataType:"json",contentType:"application/json; charset=utf-8",method:"GET",success:function(b){b.success&&a.each(b.patterns,function(a,b){h.append('<option value="'+b.id+'">'+b.name+"</option>")})}}),h.on("change",function(){c.addClass("available"),c.data("pattern",h.val());var e={settings:{id:h.val()}};a.ajax({url:"/api/document/block/"+f+"/"+g+"/"+d,data:JSON.stringify(e),contentType:"application/json; charset=utf-8",method:"POST",success:function(a){a.success}}),b.loadPattern(h.val())})}},loadPattern:function(b){var c=this,d=this.$ctx,e=d.data("pattern"),f="/api/patterns/"+e;a.ajax({url:f,success:function(b){if(b.success){var e=b.pattern;e.height=parseInt(e.height)+15,$pattern=a(c.templates.item(e)),c.$items.append($pattern),a(".mod-document").hasClass("editor-enabled")&&a('[data-editable="true"]',d).attr("contenteditable",!0),c.initializeCode(),c.fire("BlockReady",{block:d.data("block")},function(){})}}})},initializeCode:function(){var b=this,c=this.$ctx,d=!0;if(a(".mod-document").hasClass("editor-enabled")&&!c.hasClass("referenced")&&(d=!1),c.data("deleted"))return void c.find(".patterns").hide();c.find("iframe").iFrameResize({resizeFrom:"child",minHeight:20});var e=c.find(".visibility");if(e.length>0){var f=e.hasClass("state-private")?"private":"public";b.renderVisibility(f);var g=c.find(".code-editor.code-editor-html"),h=c.find(".code-editor.code-editor-css"),i=c.find(".code-editor.code-editor-js"),j=g.find("textarea").val(),k=h.find("textarea").val(),l=i.find("textarea").val();j&&"null"!=j||c.find(".code-editor.code-editor-html textarea").val("<!--"+c.data("txt-placeholder-code")+"-->"),k&&"null"!=k||c.find(".code-editor.code-editor-css textarea").val(""),l&&"null"!=l||c.find(".code-editor.code-editor-js textarea").val(""),b.codemirror_html=CodeMirror.fromTextArea(g.find("textarea").get(0),{mode:g.data("mode"),theme:"solarized",lineNumbers:!0,lineWrapping:!1,readOnly:d,viewportMargin:1/0,extraKeys:{"Ctrl-Space":"autocomplete",Tab:function(a){var b=Array(a.getOption("indentUnit")+1).join(" ");a.replaceSelection(b,"end","+input")}}}),b.codemirror_css=CodeMirror.fromTextArea(h.find("textarea").get(0),{mode:"css",theme:"solarized",lineNumbers:!0,lineWrapping:!1,readOnly:d,viewportMargin:1/0,extraKeys:{"Ctrl-Space":"autocomplete",Tab:function(a){var b=Array(a.getOption("indentUnit")+1).join(" ");a.replaceSelection(b,"end","+input")}}}),b.codemirror_js=CodeMirror.fromTextArea(i.find("textarea").get(0),{mode:"javascript",theme:"solarized",lineNumbers:!0,lineWrapping:!1,readOnly:d,viewportMargin:1/0,extraKeys:{"Ctrl-Space":"autocomplete",Tab:function(a){var b=Array(a.getOption("indentUnit")+1).join(" ");a.replaceSelection(b,"end","+input")}}}),b.codemirror_html.on("change",a.debounce(500,function(){b.saveHTML()})),b.codemirror_js.on("change",a.debounce(2e3,function(){b.saveJS()})),b.codemirror_css.on("change",a.debounce(500,function(){b.saveCSS()}))}},saveHTML:function(){var b=this,c=this.$ctx,d=c.find("iframe"),e=c.find(".code-editor.code-editor-html"),f=e.data("snippet")||null,g=e.data("saved")||0;if(!f){if(g)return;b.codemirror_html.setOption("readOnly",!0),e.addClass("disabled")}e.data("saved",1);var h={snippets:{html:{id:f,code:b.codemirror_html.getValue()}}};a.ajax({url:"/api/patterns/"+c.data("pattern"),dataType:"json",method:"PUT",contentType:"application/json; charset=utf-8",data:JSON.stringify(h),success:function(a){e.hasClass("disabled")&&(e.removeClass("disabled"),b.codemirror_html.setOption("readOnly",!1),b.codemirror_html.focus()),e.data("snippet",a.pattern.snippets.html.id),a.success?(b.clearError(b.codemirror_html,"html"),d.contents().find("#ffy-markup").html(a.pattern.snippets.html.compiled),b.resize()):b.displayError(b.codemirror_html,"html",a.errors.html)}})},saveJS:function(){var b=this,c=this.$ctx,d=c.find("iframe"),e=c.find(".code-editor.code-editor-js"),f=e.data("snippet")||null,g=e.data("saved")||0;if(!f){if(g)return;b.codemirror_js.setOption("readOnly",!0),e.addClass("disabled")}e.data("saved",1);var h={snippets:{js:{id:f,code:b.codemirror_js.getValue()}}};a.ajax({url:"/api/patterns/"+c.data("pattern"),dataType:"json",method:"PUT",contentType:"application/json; charset=utf-8",data:JSON.stringify(h),success:function(a){e.hasClass("disabled")&&(e.removeClass("disabled"),b.codemirror_js.setOption("readOnly",!1),b.codemirror_js.focus()),e.data("snippet",a.pattern.snippets.js.id),a.success?(b.clearError(b.codemirror_js,"js"),d.get(0).contentDocument.location.reload(!0)):b.displayError(b.codemirror_js,"js",a.errors.js)}})},saveCSS:function(){var b=this,c=this.$ctx,d=c.find("iframe"),e=d.contents().find("#ffy-styles"),f=c.find(".code-editor.code-editor-css"),g=f.data("snippet")||null,h=f.data("saved")||0;if(!g){if(h)return;b.codemirror_css.setOption("readOnly",!0),f.addClass("disabled")}f.data("saved",1);var i={snippets:{css:{id:g,code:b.codemirror_css.getValue()}}};a.ajax({url:"/api/patterns/"+c.data("pattern"),dataType:"json",method:"PUT",contentType:"application/json; charset=utf-8",data:JSON.stringify(i),success:function(a){f.hasClass("disabled")&&(f.removeClass("disabled"),b.codemirror_css.setOption("readOnly",!1),b.codemirror_css.focus()),f.data("snippet",a.pattern.snippets.css.id),a.success?(b.clearError(b.codemirror_css,"css"),e.text(a.pattern.snippets.css.compiled),b.resize()):b.displayError(b.codemirror_css,"css",a.errors.css)}})},renderVisibility:function(a){var b=this,c=this.$ctx,d=c.find(".visibility");d.html(b.templates.visibility({visibility:a})),"private"==a?d.addClass("state-private"):d.removeClass("state-private")},clearError:function(a,b){var c=this.$ctx;if(this.errors[b]){var d=this.errors[b];d.clear(),delete this.errors[b],c.find(".code-editor-"+b+" .code-error").removeClass("state-error")}},displayError:function(b,c,d){var e=this.$ctx;if(d&&d.line>0&&d.message){var f=b.getDoc(),g=d.line-1,h=a('<div class="inline-editor-error inline-error-hidden"><div class="inline-error-message">'+d.message+"</div></div>").get(0);this.clearError(b,c),this.errors[c]=f.addLineWidget(g,h,{coverGutter:!1,noHScroll:!0}),e.find(".code-editor-"+c+" .code-error").addClass("state-error")}},resize:function(){var a=this.$ctx,b=a.find("iframe").get(0);b.iFrameResizer.resize()},onEnableEditing:function(b){var c=this,d=this.$ctx;d.hasClass("referenced")||(a('[data-editable="true"]',d).attr("contenteditable",!0),c.codemirror_html&&c.codemirror_html.setOption("readOnly",!1),c.codemirror_css&&c.codemirror_css.setOption("readOnly",!1),c.codemirror_js&&c.codemirror_js.setOption("readOnly",!1))},onDisableEditing:function(b){var c=this,d=this.$ctx;a('[data-editable="true"]',d).removeAttr("contenteditable"),c.codemirror_html&&c.codemirror_html.setOption("readOnly",!0),c.codemirror_css&&c.codemirror_css.setOption("readOnly",!0),c.codemirror_js&&c.codemirror_js.setOption("readOnly",!0)}})}(Tc.$),function(a){Tc.Module.BlockPatternlisting=Tc.Module.extend({templates:[],$items:null,on:function(b){var c=this,d=this.$ctx;this.tpl=c.sandbox.getConfigParam("tpl"),c.templates.listing=this.tpl.compile("b-patternlisting"),c.$items=a(".patterns",d),b()},after:function(){var b=this,c=this.$ctx,d=c.data("project"),e="/api/patterns/list/"+d+"/?groupby=granularity";a.ajax({url:e,method:"GET",success:function(c){if(c.success){var d=a(b.templates.listing(c.patterns));b.$items.empty(),b.$items.append(d)}}})}})}(Tc.$),function(a){Tc.Module.BlockPersonalnote=Tc.Module.extend({on:function(b){var c=this,d=this.$ctx;c.sandbox.subscribe("events",c),this.data=this.sandbox.getConfigParam("data");var e=(a(".page").data("id"),d.parents("section").data("id"));1>e&&(e=0);d.data("block");d.on("blur",".note-content > textarea",function(){var b=a(this).val(),e={settings:{content:b}};c.data.updateBlock(d,e)}),d.on("click",".btn-toogle-visibility",function(b){
if(!a("body").hasClass("editor-enabled"))return!1;var e=d.attr("data-visibility");"public"==e?(d.attr("data-visibility","private"),d.find(".note-status").removeClass("public"),d.find(".note-status").addClass("private"),d.find(".note-status > span").text(d.data("text-visible-editors")),d.find(".note-status > i").removeClass("icon-eye").addClass("icon-eye-slash")):(d.attr("data-visibility","public"),d.find(".note-status").removeClass("private"),d.find(".note-status").addClass("public"),d.find(".note-status > span").text(d.data("text-visible-everyone")),d.find(".note-status > i").removeClass("icon-eye-slash").addClass("icon-eye"));var f={settings:{visibility:"private"==e?"public":"private"}};c.data.updateBlock(d,f)}),d.on("click",".note-status",function(){d.find(".btn-toogle-visibility").trigger("click")}),a("body").hasClass("editor-enabled")||(d.find(".note-content > textarea").attr("readonly","readonly"),d.find(".note-status").hide()),b()},after:function(){var b=this,c=this.$ctx,d=(a(".page").data("id"),c.parents("section").data("id"));1>d&&(d=0);var e=(c.data("block"),c.attr("data-creator"),new Date);"edit"==c.data("role")?(c.find(".note-status").addClass(c.attr("data-visibility")),"public"==c.attr("data-visibility")?c.find(".note-status").append('<i class="icon-eye"></i><span>'+c.data("text-visible-everyone")+"</span>"):c.find(".note-status").append('<i class="icon-eye-slash"></i><span>'+c.data("text-visible-editors")+"</span>")):(c.find(".note-status").hide(),c.addClass("viewmode")),c.attr("data-creator")||a.ajax({url:"/api/user/info/",contentType:"application/json; charset=utf-8",type:"GET",success:function(a){if(a.success){c.find(".note-creator").append('<img src="'+a.image+'" />'),c.find(".note-meta").append('<span class="note-author">'+a.name+"</span>"),c.find(".note-meta").append('<span class="note-date">'+c.data("text-added-on")+" "+e.toLocaleString()+"</span>");var d={settings:{creator:a.id,created:e.toLocaleString(),visibility:"private",image:a.image,name:a.name}};b.data.updateBlock(c,d)}}})},onEnableEditing:function(a){var b=this.$ctx;return b.hasClass("referenced")?!1:(b.find(".note-content > textarea").removeAttr("readonly","readonly"),void b.find(".note-status").show())},onDisableEditing:function(a){var b=this.$ctx;b.find(".note-content > textarea").attr("readonly","readonly"),b.find(".note-status").hide()}})}(Tc.$),function(a){Tc.Module.BlockQuote=Tc.Module.extend({selection:null,started:!1,on:function(b){var c=this,d=this.$ctx,e=(d.data("block"),d.parents(".page").data("id"),d.parents("section").data("id"));this.data=this.sandbox.getConfigParam("data"),1>e&&(e=0),a(window).on("mouseup",function(){a(".mod-document").hasClass("editor-enabled")&&c.started&&(c.createHint(),c.started=!1)}),a(".quote",d).on("mousedown",function(a){c.started=!0}),d.on("mousedown mouseup",".tooltip",function(a){return a.stopPropagation(),!1}),a(".quote",d).on("keypress",function(a){d.find(".tooltip").remove()}),a(document).on("mousedown",function(){d.find(".tooltip").remove()}),a(".btn-toggle-editing").on("click",function(){a(".mod-document").hasClass("editor-enabled")&&!d.hasClass("referenced")?a(".quote",d).attr("contenteditable",!0):a(".quote",d).removeAttr("contenteditable")}),a(".mod-document").hasClass("editor-enabled")&&d.find(".quote").attr("contenteditable",!0),d.on("click",".btn-bold",function(a){a.preventDefault(),document.execCommand("bold",!1,null)}),d.on("click",".btn-italic",function(a){a.preventDefault(),document.execCommand("italic",!1,null)}),d.on("click",".btn-clear",function(a){a.preventDefault(),document.execCommand("removeFormat",!1,null)}),a(".quote",d).on("blur",function(){a(this).find("span").contents().unwrap();var b=a(this).html(),e={settings:{content:b}};return c.data.updateBlock(d,e).then(function(){c.update()}),!1}),a(".quote",d).text().trim().length<1&&d.addClass("block-empty"),b()},after:function(){this.$ctx},update:function(){var b=this.$ctx,c=a(".quote",b);c.text().length>0?b.removeClass("block-empty"):b.addClass("block-empty")},_getSelection:function(){var a=this,b=this.$ctx,c={text:"",from:0,to:0,rect:{}};if(window.getSelection&&"Caret"==window.getSelection().type&&b.find(".tooltip").remove(),window.getSelection&&"Range"==window.getSelection().type||window.getSelection().rangeCount>0){var d,e=window.getSelection();if(a.selection=e,c.text=e.toString(),c.from=e.anchorOffset,c.to=e.focusOffset,e.rangeCount&&(d=e.getRangeAt(0).cloneRange(),d.getBoundingClientRect)){var f=d.getBoundingClientRect();c.rect={top:f.top,left:f.left+f.width/2}}}if(c.from>c.to){var g=c.from;c.from=c.to,c.to=g}return c},createHint:function(){var b=this,c=this.$ctx,d=b._getSelection();if(""!==d.text.trim()){if(a(".mod-document").hasClass("editor-enabled"))var e='<div class="tooltip tooltip-edit"><a class="btn-bold" href="javascript:;"><i class="icon-bold"></i></a><a class="btn-italic" href="javascript:;"><i class="icon-italic"></i></a></div>',f=a(e);f.css({top:d.rect.top,left:d.rect.left}),c.append(f)}},urlPrompt:function(a){var b=prompt("Enter a url","http://");a(/^((http|https)...)/.test(b)?b:"http://"+b)}})}(Tc.$),function(a){Tc.Module.BlockTable=Tc.Module.extend({resizing:!1,sortable:null,on:function(b){var c=this.$ctx;this.data=this.sandbox.getConfigParam("data"),this.tpl=this.sandbox.getConfigParam("tpl"),this.sandbox.subscribe("events",this),a(".btn-toggle-editing").on("click",function(){a(".mod-document").hasClass("editor-enabled")&&!c.hasClass("referenced")?a('[data-editable="true"]',c).attr("contenteditable",!0):a('[data-editable="true"]',c).removeAttr("contenteditable")}),a(".mod-document").hasClass("editor-enabled")&&a('[data-editable="true"]',c).attr("contenteditable",!0),b()},after:function(){var b=this.$ctx,c=this;(a(".mod-document").data("editor")||a(".mod-document").data("translator"))&&b.on("blur","*[contenteditable]",function(b){a(".mod-document").hasClass("editor-enabled")&&c.save()}),a(".mod-document").data("editor")&&(b.on("click",".btn-add-column",function(b){a(".mod-document").hasClass("editor-enabled")&&(c.addColumn(a(this).closest("th"),!1),c.save())}),b.on("click",".btn-add-row",function(d){a(".mod-document").hasClass("editor-enabled")&&("thead"==a(this).closest("tr").parent().get(0).localName?c.addRow(a("tbody",b),!0):c.addRow(a(this).closest("tr"),!1),c.save())}),b.on("click",".btn-remove-row",function(b){if(a(".mod-document").hasClass("editor-enabled")){var d=a(this);c.fire("swal",{template:"c-swal-block-table-row-delete",callback:function(){d.closest("tr").remove(),c.save(),c.fire("swal",{template:"c-swal-block-table-row-deleted",type:"success"})}})}}),b.on("click",".btn-remove-column",function(d){var e=a(this);a(".mod-document").hasClass("editor-enabled")&&c.fire("swal",{template:"c-swal-block-table-col-delete",callback:function(){var d=e.closest("th").index();e.closest("th").remove(),a("tbody tr td:nth-child("+(d+1)+")",b).remove(),c.save(),c.fire("swal",{template:"c-swal-block-table-col-deleted",type:"success"})}})}),b.on("mousedown",".resize",function(d){a(".mod-document").hasClass("editor-enabled")&&(a("th:last-child",b).removeAttr("width"),a(this).closest("th").addClass("resizing"),c.resizing=a(this).closest("th"))}),b.on("mouseup",".tbl",function(d){a(".mod-document").hasClass("editor-enabled")&&c.resizing&&(a(".resizing",b).removeClass("resizing"),c.resizing=!1,c.save())}),b.on("mousemove",".tbl",function(b){if(a(".mod-document").hasClass("editor-enabled")&&c.resizing){var d=Math.round(b.clientX-c.resizing.offset().left);c.resizing.css("width",d)}}),a(".mod-document").data("editor")&&b.data("is-editable")&&(a("tbody > tr > td:first-child",b).append('<div class="btn-add-row"><i class="icon-long-arrow-right"></i></div>'),a("tbody > tr > td:last-child",b).append('<div class="btn-remove-row"><i class="icon-trash"></i></div>'),a("thead > tr > th:first-child",b).append('<div class="btn-add-row"><i class="icon-long-arrow-right"></i></div>'),a("thead > tr > th",b).append('<div class="btn-remove-column"><i class="icon-trash"></i></div><div class="column-action resize"><i class="icon-caret-down"></i></div>'),a("thead > tr > th:last-child .resize",b).remove(),a("thead > tr > th",b).append('<div class="column-action btn-add-column"><i class="icon-long-arrow-down"></i></div>')),b.on("keydown","td > [contenteditable], th > [contenteditable]",function(d){if(a(".mod-document").hasClass("editor-enabled")&&9==d.keyCode){var e=a("tbody tr",b).length,f=a("thead th",b).length,g=a(this).parent().get(0).cellIndex,h=a(this).closest("tr").get(0).rowIndex;if(e!=h||f!=g+1||d.shiftKey||(c.addRow(a("tbody > tr:last-child",b),!1),c.save()),d.shiftKey){var i=a(this).parent().prev("th,td");i.length<=0&&(i=a(this).closest("tr").prev().find("td:last-child")),i.find(".value").focus()}else{var i=a(this).parent().next("th,td");i.length<=0&&(i=a(this).closest("tr").next().find("td:first-child")),i.find(".value").focus()}if(i.length>0){var j,k;window.getSelection&&document.createRange?(k=document.createRange(),k.selectNodeContents(i.find(".value").get(0)),j=window.getSelection(),j.removeAllRanges(),j.addRange(k)):document.body.createTextRange&&(k=document.body.createTextRange(),k.moveToElementText(i.find(".value").get(0)),k.select())}return d.stopPropagation(),d.preventDefault(),!1}}))},addColumn:function(b,c){if(a(".mod-document").hasClass("editor-enabled")){var d=this.$ctx,e=d.find(".tbl"),f=e.find("thead > tr"),g=e.find("tbody"),h="",i=f.find("th").length-1,j=b.index();j==i&&f.find(".btn-add-column").replaceWith('<div class="column-action resize"><i class="icon-caret-down"></i></div>');var k='<th width="'+h+'"><div class="value" data-editable="true" contenteditable="true"></div><div class="column-action btn-add-column"><i class="icon-long-arrow-down"></i></div>';j!=i&&(k+='<div class="column-action resize"><i class="icon-caret-down"></i></div>'),k+="</th>",c?b.prepend(k):b.after(k),j==i&&g.find(".btn-remove-row").remove(),k='<td><div class="value" data-editable="true" contenteditable="true"></div>',j==i&&(k+='<div class="btn-remove-row"><i class="icon-trash"></i></div>'),k+="</td>",g.find("tr > td:nth-child("+(j+1)+")").after(k)}},addRow:function(b,c){if(a(".mod-document").hasClass("editor-enabled")){for(var d=this.$ctx,e=d.find(".tbl"),f=e.find("thead > tr"),g=(e.find("tbody"),"<tr>"),h=1;h<=f.find("th").length;h++)g+="<td>",g+='<div class="value" data-editable="true" contenteditable="true"></div>',1==h&&(g+='<div class="btn-add-row"><i class="icon-long-arrow-right"></i></div>'),h==f.find("th").length&&(g+='<div class="btn-remove-row"><i class="icon-trash"></i></div>'),g+="</td>";g+="</tr>",c?b.prepend(g):b.after(g)}},save:function(){if(a(".mod-document").hasClass("editor-enabled")){var b=this.$ctx,c=[],d=[],e=[],f=a("thead th",b);a.each(f,function(b,d){var f=a(d),g=f.find(".value").text();c[b]=g,e.push({label:g,field:g,width:f.width()})});var g=a("tbody tr",b);a.each(g,function(b,c){var e={};a(c).children("td").each(function(b,c){var d=a(c).find("> div").html();e[b]=d}),d.push(e)});var h={settings:{data:d,columns:e}};this.data.updateBlock(b,h)}}})}(Tc.$),function(a){Tc.Module.BlockText=Tc.Module.extend({selection:null,started:!1,on:function(b){var c=this,d=this.$ctx;this.data=this.sandbox.getConfigParam("data"),a(window).on("mouseup",function(){a(".mod-document").hasClass("editor-enabled")&&c.started&&(c.createHint(),c.started=!1)}),a(".richtext",d).on("mousedown",function(a){c.started=!0}),d.on("mousedown mouseup",".tooltip",function(a){return a.stopPropagation(),!1}),a(".btn-toggle-editing").on("click",function(){a(".mod-document").hasClass("editor-enabled")&&!d.hasClass("referenced")?a(".richtext",d).attr("contenteditable",!0):a(".richtext",d).removeAttr("contenteditable")}),a(".mod-document").hasClass("editor-enabled")&&d.find(".richtext").attr("contenteditable",!0),a(".richtext",d).on("keypress",function(a){d.find(".tooltip").remove()}),a(document).on("mousedown",function(){d.find(".tooltip").remove()}),d.on("click",".btn-bold",function(a){a.preventDefault(),document.execCommand("bold",!1,null)}),d.on("click",".btn-italic",function(a){a.preventDefault(),document.execCommand("italic",!1,null)}),d.on("click",".btn-unordered-list",function(a){a.preventDefault(),document.execCommand("insertUnorderedList",!1,null)}),d.on("click",".btn-ordered-list",function(a){a.preventDefault(),document.execCommand("insertOrderedList",!1,null)}),d.on("click",".btn-clear",function(a){a.preventDefault(),document.execCommand("removeFormat",!1,null)}),d.on("click",".btn-h1",function(b){b.preventDefault();var c=window.getSelection().getRangeAt(0),e=c.commonAncestorContainer.parentElement;if(a(e).is("h3"))return void a(e).replaceWith(e.textContent);var f=document.createElement("h3");c.surroundContents(f),d.find(".tooltip").remove()}),d.on("click",".btn-code",function(b){b.preventDefault();var c=window.getSelection().getRangeAt(0),e=c.commonAncestorContainer.parentElement;if(a(e).is("code"))return void a(e).replaceWith(e.textContent);var f=document.createElement("code");c.surroundContents(f),d.find(".tooltip").remove()}),d.on("click",".btn-link",function(a){a.preventDefault();var b=window.getSelection().getRangeAt(0);"A"===b.startContainer.parentNode.tagName||"A"===b.endContainer.parentNode.tagName?document.execCommand("unlink",!1,null):c.urlPrompt(function(a){document.execCommand("createLink",!1,a)})}),a(".richtext",d).on("blur",function(){var b=(d.data("block"),d.parents(".page").data("id"),d.parents("section").data("id"));1>b&&(b=0),a(this).find("span").contents().unwrap();var e=a(this).html(),f={settings:{content:e}};return c.data.updateBlock(d,f).then(function(){c.update()}),!1}),a(".richtext",d).text().trim().length<1&&d.addClass("block-empty"),b()},after:function(){var a=this;this.$ctx;a.update()},update:function(){var b=this.$ctx,c=a(".richtext",b);c.text().length>0?b.removeClass("block-empty"):b.addClass("block-empty")},_getSelection:function(){var a=this,b=this.$ctx,c={text:"",from:0,to:0,rect:{}};if(window.getSelection&&"Caret"==window.getSelection().type&&b.find(".tooltip").remove(),window.getSelection&&"Range"==window.getSelection().type||window.getSelection().rangeCount>0){var d,e=window.getSelection();if(a.selection=e,c.text=e.toString(),c.from=e.anchorOffset,c.to=e.focusOffset,e.rangeCount&&(d=e.getRangeAt(0).cloneRange(),d.getBoundingClientRect)){var f=d.getBoundingClientRect();c.rect={top:f.top,left:f.left+f.width/2}}}if(c.from>c.to){var g=c.from;c.from=c.to,c.to=g}return c},createHint:function(){var b=this,c=this.$ctx,d=b._getSelection();if(""!==d.text.trim()){if(a(".mod-document").hasClass("editor-enabled"))var e='<div class="tooltip tooltip-edit"><a class="btn-h1" href="javascript:;">H1</a><a class="btn-bold" href="javascript:;"><i class="icon-bold"></i></a><a class="btn-italic" href="javascript:;"><i class="icon-italic"></i></a><a class="btn-unordered-list" href="javascript:;"><i class="icon-list-ul"></i></a><a class="btn-ordered-list" href="javascript:;"><i class="icon-list-ol"></i></a><a class="btn-link" href="javascript:;"><i class="icon-link"></i></a><a class="btn-code" href="javascript:;"><i class="icon-code"></i></a></div>',f=a(e);f.css({top:d.rect.top,left:d.rect.left}),c.append(f)}},urlPrompt:function(a){var b=prompt("Enter a url","http://");a(/^(http|https|mailto)/.test(b)?b:"http://"+b)}})}(Tc.$),function(a){Tc.Module.BlockTypofonts=Tc.Module.extend({templates:[],$items:null,codemirror_html:null,codemirror_css:null,typekit_token:null,font_loading_error:!1,on:function(b){var c=this,d=this.$ctx,e=a(".page").data("id"),f=d.parents("section").data("id");1>f&&(f=0);var g=d.data("block");this.tpl=c.sandbox.getConfigParam("tpl"),this.data=c.sandbox.getConfigParam("data"),c.sandbox.subscribe("events",c),c.templates.item=this.tpl.compile("b-typofonts-item"),c.$items=a(".fonts",d),d.on("click",".btn-delete",function(){var b=a(this).closest(".font"),d=b.data("id");c.fire("swal",{template:"c-swal-block-typofonts-delete",closeOnConfirm:!0,callback:function(){var c="/api/typography/fonts/"+d;a.ajax({url:c,type:"DELETE",success:function(c){var h={settings:{}};h.settings["fonts[="+d+"]"]=null,a.ajax({url:"/api/document/block/"+e+"/"+f+"/"+g,data:JSON.stringify(h),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success}}),b.remove()}})}})}),d.on("click",".cloud-provider .nav a",function(){var b=a(this).data("tab");d.find(".cloud-provider .nav li.active").removeClass("active"),a(this).find("li").addClass("active"),d.find(".provider-content.active").removeClass("active"),d.find(".tab-"+b).addClass("active"),("google"==b||"system"==b)&&c.enableSearch()}),d.on("keypress",".tab-typekit input",function(b){if(13==b.keyCode){var e=a(this).val();a(this).attr("disabled","disabled"),d.find(".cloud-provider .provider-content.tab-typekit .provider-error").hide(),d.find(".cloud-provider .provider-content.tab-typekit input").removeClass("error");var f=d.find(".loading-indicator");f.show();var g={provider:"typekit",token:e};a.ajax({url:"/api/font/import",data:JSON.stringify(g),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){if(f.hide(),b.success){c.typekit_token=e;var g="";a.each(b.typekit.kits,function(b,c){c.families&&(g=a('<div class="typekit-kit" data-kit='+c.id+'><i class="icon-cube"></i><span>'+c.project+"</span><span> ("+c.families.length+' font families)</span><button class="btn typekit-activate">Activate</button><span class="typekit-loading-indicator">Loading...</span></div>'),a(".typekit-result",d).append(g))}),d.find(".cloud-provider .tab-typekit .typekit-available-results").css("display","block"),d.find(".cloud-provider .typekit-result").show()}else d.find(".cloud-provider .provider-content.tab-typekit .provider-error").show(),d.find(".cloud-provider .provider-content.tab-typekit input").addClass("error")}})}}),d.on("paste",".tab-typekit input",function(){var b=jQuery.Event("keypress");b.which=13,b.keyCode=13,setTimeout(function(){a(".tab-typekit input",d).trigger(b)},100)}),d.on("click",".typekit-activate",function(){c.font_loading_error=!1;var b=a(this).closest(".typekit-kit").data("kit"),e={provider:"typekit",token:c.typekit_token,kid:b,project:d.data("project")};a.ajax({url:"/api/font/activate",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){b.success&&(a.each(b.id,function(b,c){var e=a('<div class="font row" data-id="'+c+'"></div>');a(".fonts",d).append(e)}),c.update(function(a){a?alert('Please allow "app.frontify.com" in your TypeKit-Settings'):(c.save(b.id),c.font_loading_error=!1)}))}})}),d.on("keypress",".provider-content input",function(b){if(13==b.keyCode){var e=a(this).closest(".provider-content").data("provider");if("fontdeck"!=e)return!1;var f=a(this).val();a(this).attr("disabled","disabled"),d.find(".cloud-provider .provider-content.provider-"+e+" .provider-error").hide(),d.find(".cloud-provider .provider-content.provider-"+e+" input").removeClass("error");var g=d.find(".loading-indicator");if(g.show(),"fontdeck"==e)var h={provider:e,fontdeck_id:f,project:d.data("project")};a.ajax({url:"/api/font/activate",data:JSON.stringify(h),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){g.hide(),b.success?"fontdeck"==e&&(a.each(b.id,function(b,c){var e=a('<div class="font row" data-id="'+c+'"></div>');a(".fonts",d).append(e)}),c.update(),c.save(b.id),c.font_loading_error=!1):"fontdeck"==e&&(d.find(".cloud-provider .provider-content.provider-"+e+" .provider-error").show(),d.find(".cloud-provider .provider-content.provider-"+e+" input").addClass("error"),alert('Please allow "app.frontify.com" in your FontDeck-Settings'),c.font_loading_error=!0)}})}}),d.on("paste",".tab-fontdeck input",function(){var b=jQuery.Event("keypress");b.which=13,b.keyCode=13,setTimeout(function(){a(".tab-fontdeck input",d).trigger(b)},100)}),b()},update:function(b){var c=this,d=this.$ctx,e=this.$ctx.data("project"),f=(d.data("block"),[]);d.find(".fonts > .font").each(function(b,c){f.push(a(c).data("id"))}),f.length>0&&(d.removeClass("block-empty"),a.ajax({url:"/api/typography/fonts/"+e+"/?groupby=family&id="+f.join(),headers:{ReferenceToken:d.data("reference-hash")},success:function(e){c.$items.empty(),e.fonts.length>0?d.addClass("fonts-available"):d.removeClass("fonts-available"),e.editable=a(".mod-document").data("editing");var f=a(c.templates.item(e));c.$items.append(f);var g=[];a.each(e.fonts,function(b,c){"GOOGLE"==c.provider&&a.each(c.fonts,function(a,b){var d=":";"normal"!=b.font_weight&&"regular"!=b.font_weight&&(d+=b.font_weight),"italic"==b.font_style&&(d+="italic"),g.push(c.css_family_name+d)})}),"SYSTEM"==e.provider&&a(".cloud-provider",d).hide(),g.length>0&&"GOOGLE"==e.provider&&WebFont.load({google:{families:g},active:function(){a(".cloud-provider",d).hide()}}),"TYPEKIT"==e.provider&&WebFont.load({typekit:{id:e.provider_id},inactive:function(){d.find(".fonts").empty(),d.find(".code").empty(),d.find(".font-usage").removeClass("visible"),"function"==typeof b&&(error=!0,b(error))},active:function(){a(".cloud-provider",d).hide(),"function"==typeof b&&(error=!1,b(error))}}),"FONTDECK"==e.provider&&WebFont.load({fontdeck:{id:e.provider_id},active:function(){a(".cloud-provider",d).hide()}});var h=[],i=[],j="";if(a.each(e.fonts,function(a,b){"DESKTOP"!==b.fonts[0].usage&&("GOOGLE"==b.provider&&h.push(b.family_name.replace(/ /g,"+")),"TYPEKIT"==b.provider&&i.push(e.provider_id),("GOOGLE"==b.provider||"SYSTEM"==b.provider||"SELFHOSTED"==b.provider)&&(j+="font-family: '"+b.css_family_name+"', sans-serif;"),e.fonts.length>a+1&&(j+="\n"))}),j.length>0){var k="<link href='http://fonts.googleapis.com/css?family="+h.join("|")+"' rel='stylesheet' type='text/css'>";a(".code-css",d).addClass("visible"),c.codemirror_css.refresh(),c.codemirror_css.setValue(j),a(".font-usage",d).addClass("visible"),h.length>0?(a(".code-html",d).addClass("visible"),c.codemirror_html.refresh(),c.codemirror_html.setValue(k)):i.length>0?a.each(i,function(b,e){k='<script src="//use.typekit.net/'+e+'.js"></script>\n<script>try{Typekit.load();}catch(e){}</script>',a(".code-html",d).addClass("visible"),c.codemirror_html.refresh(),c.codemirror_html.setValue(k),a(".code-css",d).removeClass("visible")}):a(".code-html",d).removeClass("visible")}}}))},after:function(){var b=this,c=this.$ctx,d=(this.$ctx.data("project"),c.data("block")),e=[];a("body").data("hub");c.find(".fonts > .font").each(function(b,c){e.push(a(c).data("id"))}),e.length>0&&a(".cloud-provider",c).hide(),b.update(),b.enableSearch();var f=a(".page").data("id"),g=c.parents("section").data("id");1>g&&(g=0);var d=c.data("block");b.codemirror_html=CodeMirror.fromTextArea(c.find("textarea.usage-html").get(0),{mode:"htmlmixed",theme:"solarized",lineNumbers:!0,lineWrapping:!1,readOnly:!0,viewportMargin:1/0,extraKeys:{Tab:function(a){var b=Array(a.getOption("indentUnit")+1).join(" ");a.replaceSelection(b,"end","+input")}}}),b.codemirror_css=CodeMirror.fromTextArea(c.find("textarea.usage-css").get(0),{mode:"css",theme:"solarized",lineNumbers:!0,lineWrapping:!1,readOnly:!0,viewportMargin:1/0,extraKeys:{Tab:function(a){var b=Array(a.getOption("indentUnit")+1).join(" ");a.replaceSelection(b,"end","+input")}}}),a(".fileupload",c).fileupload({dataType:"json",dropZone:a(".dropzone",c),add:function(a,c){var d=Math.round(c.files[0].size/1024,0);"application/zip"==c.files[0].type||"application/x-zip-compressed"==c.files[0].type?c.submit():b.displayError("Invalid Webfont Package","Error, only ZIP-Files are allowed!"),b.data.checkStorageLimit(d).then(function(){c.submit()})},done:function(e,h){if(0==h.result[0].font_ids.length)return b.displayError("Invalid Webfont Package","Error, you've provided a uncomplete Webfont-Package. Please see our example package for reference."),!1;if(h.result&&h.result[0]){b.data.updateStorageUsage(!0),a.each(h.result[0].font_ids,function(b,d){var e=a('<div class="font row" data-id="'+d+'"></div>');a(".fonts",c).append(e)});var i={settings:{library:h.result[0].library_id,asset:h.result[0].id,"fonts[]":h.result[0].font_ids}};a.ajax({url:"/api/document/block/"+f+"/"+g+"/"+d,data:JSON.stringify(i),contentType:"application/json; charset=utf-8",type:"POST",success:function(b){b.success&&(a(".btn-download-library",c).attr("href","/api/typography/download/"+i.settings.library),c.addClass("fonts-available"),a(".cloud-provider",c).hide(),location.reload())}}),c.data("library",i.settings.library),c.data("asset",i.settings.asset),b.update()}}}),$sortable_fonts=c.find('[data-sortable="true"]'),a.each($sortable_fonts,function(a,c){b.enableSorting(c)})},enableSearch:function(){var b,c=this,d=this.$ctx,e=a(".mod-document"),f=d.find(".provider-content.active").data("provider"),g=e.data("search-prefix"),h=new AlgoliaSearch(e.data("search-id"),a(".mod-document").data("search-key-public")),i=h.initIndex(g+"fonts"),j=Hogan.compile("{{{ _highlightResult.name.value }}}"),k=a(".active .typeahead",d).typeahead({hint:!1},[{source:i.ttAdapter({hitsPerPage:8,tags:"provider_"+f}),displayKey:"name",templates:{suggestion:function(a){return"provider_google"==a._tags?b="icon-google":"provider_system"==a._tags&&(b="icon-desktop"),j.render(a)+'<div class="icon-provider"><i class="'+b+'"></i></div>'}}}]);k.on("typeahead:selected",function(b,e){var f={font_id:e.objectID,provider:e._tags[0],fontname:e.name};a.ajax({url:"/api/project/fonts/"+d.data("project"),type:"POST",data:JSON.stringify(f),contentType:"application/json; charset=utf-8",success:function(b){a.each(b.font_data,function(b,c){var e=a('<div class="font row" data-id="'+c+'"></div>');a(".fonts",d).append(e)}),c.save(b.font_data),c.update()}})})},save:function(b){var c=this.$ctx,d=c.data("block"),e=c.parents(".page").data("id"),f=c.parents("section").data("id");1>f&&(f=0);var g={settings:{"fonts[]":b}};a.ajax({url:"/api/document/block/"+e+"/"+f+"/"+d,data:JSON.stringify(g),contentType:"application/json; charset=utf-8",type:"POST",success:function(a){a.success}})},displayError:function(a,b){swal({title:a,text:b,type:"error",showCancelButton:!1,confirmButtonText:"OK",closeOnConfirm:!0},function(){})},enableSorting:function(b){var c=this.$ctx,d=this;d.sortable=Sortable.create(b,{group:"fonts",ghostClass:"sortable-ghost",handle:".drag-handle",draggable:".row",onStart:function(a){},onUpdate:function(b){if(!a("body").hasClass("editor-enabled")||c.hasClass("referenced"))return!1;var d=a(b.item).data("id"),e={sort:b.newIndex,block:c.data("block")};a.ajax({url:"/api/typography/fonts/"+d,type:"PATCH",data:JSON.stringify(e),success:function(a){}})}})}})}(Tc.$),function(a){Tc.Module.BlockTypostyles=Tc.Module.extend({$items:null,styles:[],colors:[],$chooser:null,open:!1,activeColors:[],on:function(b){var c=this,d=this.$ctx,e=(d.data("project"),a(".page").data("id"),d.parents("section").data("id"));1>e&&(e=0);d.data("block");c.sandbox.subscribe("events",c),this.tpl=this.sandbox.getConfigParam("tpl"),this.data=this.sandbox.getConfigParam("data"),this.specs=[{label:d.data("text-font"),removable:!1,keys:["font family","family","font-family"],field:"family",prop:"font-family","default":"Helvetica"},{label:d.data("text-size"),removable:!1,keys:["size","font-size"],field:"size",prop:"font-size","default":"12px"},{label:d.data("text-line-height"),keys:["line height","height","line-height"],field:"line_height",prop:"line-height","default":"1"},{label:d.data("text-weight"),keys:["weight","font-weight"],field:"weight",prop:"font-weight","default":"bold"},{label:d.data("text-style"),keys:["style","font-style"],field:"style",prop:"font-style","default":"italic"},{label:d.data("text-transform"),keys:["transform","text-transform","upper","lower","uppercase","lowercase"],field:"transform",prop:"text-transform","default":"uppercase"},{label:d.data("text-spacing"),keys:["spacing","letter-spacing"],field:"spacing",prop:"letter-spacing","default":"0.1em"},{label:d.data("text-decoration"),keys:["decoration","text-decoration","underline","dashed"],field:"decoration",prop:"text-decoration","default":"underline"},{label:d.data("text-border"),keys:["border"],field:"border",prop:"border-bottom","default":"1px solid #ccc"},{label:d.data("text-padding"),keys:["padding"],field:"padding",prop:"padding","default":"20px"}],c.$items=a(".styles",d),a(document).on("mousedown",function(a){return c.open?(d.find(".tooltip").hide(),c.open=!1,a.stopPropagation(),!1):void 0}),d.on("keydown",'[data-editable="true"]',function(b){return 13==b.keyCode?(a(this).trigger("blur"),window.getSelection().removeAllRanges(),!1):void 0}),d.on("blur",'.meta[data-editable="true"]',function(b){var c=a(this),d=c.closest(".style-spec"),e=d.data("id"),f=c.data("field");if(f){var g=c.text(),h={id:e,level:"project"};h[f]=g,a("body").data("translation-language")&&(h.language=a("body").data("translation-language")),a.ajax({url:"/api/typography/update/"+e,dataType:"json",data:JSON.stringify(h),type:"POST",success:function(a){a.success||console.error("typography meta update failed")}})}}),d.on("autocomplete:request",".spec",function(b,d,e){var f=a(this),g=f.closest(".style-spec"),h=[];g.find(".spec").each(function(b,c){h.push(a(c).data("field"))});var i=c.specs.map(function(b){var c=!1;return"X"===d?c=!0:(d=d.toLowerCase(),b.keys.forEach(function(a){a.indexOf(d)>-1&&(c=!0)})),c&&-1===a.inArray(b.field,h)?b.label:void 0});e(i)}),d.on("autocomplete:select",".spec",function(b,d){var e=c.specs.find(function(a){return a.label===d.label}),f=a(this);f.data("field",e.field),f.find(".key").removeAttr("contenteditable").removeAttr("data-editable"),f.find(".value").text(e["default"]).trigger("blur").trigger("focus")}),d.on("click",".btn-spec-add",function(){var b=a(".mod-document").data("editing"),d=a(this),e=a(c.tpl.render("b-typostyles-spec",{editable:b,editor:!0})),f=e.find(".key");d.before(e),f.trigger("focus"),setTimeout(function(){f.text("X"),f.trigger("input"),f.text("")},100)}),d.on("click",".btn-spec-delete",function(){var b=a(this),d=b.closest(".spec"),e=b.closest(".style-spec");d.remove(),c.saveSpecs(e)}),d.on("blur",'.spec [data-editable="true"]',function(b){var d=a(this),e=d.closest(".style-spec");c.saveSpecs(e)}),d.on("click",".btn-delete",function(){var b=a(this).closest(".style-spec"),d=b.data("id");c.fire("swal",{template:"c-swal-block-typostyles-delete",closeOnConfirm:!0,callback:function(){var c="/api/typography/styles/"+d;a.ajax({url:c,type:"DELETE",success:function(a){b.closest(".style").remove()}})}})}),d.on("click",".btn-add",function(){var b={},e="/api/typography/styles/"+d.data("project")+"/"+d.data("group");a.ajax({url:e,data:JSON.stringify(b),type:"POST",success:function(b){var e=a(".mod-document").data("editing"),f=b.style;f.specs=c.getSpecs(b.style),f.editable=e;var g=a(c.tpl.render("b-typostyles-item",f));c.$items.append(g),c.styles[b.style.id]=b.style,a('[data-editable="true"]',g).attr("contenteditable",!0);var h=d.find('[data-sortable="true"]');a.each(h,function(a,b){c.enableSorting(b)})}})}),a(".btn-toggle-editing").on("click",function(){a(".mod-document").hasClass("editor-enabled")&&!d.hasClass("referenced")?a('[data-editable="true"]',d).attr("contenteditable",!0):a('[data-editable="true"]',d).removeAttr("contenteditable")}),a(".mod-document").hasClass("editor-enabled")&&d.find('[data-editable="true"]').attr("contenteditable",!0),d.on("blur",'.font-group-title[data-editable="true"]',function(b){var c={group_title:a(this).text()};""==c.group_title&&(c.group_title="null"),a("body").data("translation-language")&&(c.language=a("body").data("translation-language")),id=0,a.ajax({url:"/api/typography/update/"+id+"/"+d.data("group"),dataType:"json",data:JSON.stringify(c),type:"POST",success:function(a){}})}),d.on("blur",'.font-group-description[data-editable="true"]',function(b){var c={group_description:a(this).text()};""==c.group_description&&(c.group_description="null"),a("body").data("translation-language")&&(c.language=a("body").data("translation-language")),id=0,a.ajax({url:"/api/typography/update/"+id+"/"+d.data("group"),dataType:"json",data:JSON.stringify(c),type:"POST",
success:function(a){}})}),b()},enableSorting:function(b){var c=(this.$ctx,this);c.sortable=Sortable.create(b,{group:"styles",ghostClass:"sortable-ghost",handle:".drag-handle",onStart:function(a){},onUpdate:function(b){if(!a("body").hasClass("editor-enabled"))return!1;var c=a(b.item).find(".style-spec").data("id"),d={id:c,level:"project",sort:b.newIndex+1};a.ajax({url:"/api/typography/update/"+c,dataType:"json",data:JSON.stringify(d),type:"POST",success:function(a){}})}})},after:function(){var b=this,c=this.$ctx,d=c.data("project"),e="/api/typography/library/"+d+"/"+c.data("group");a("body").data("translation-language")&&(e+="?language="+a("body").data("translation-language")),a.ajax({url:e,headers:{ReferenceToken:c.data("reference-hash")},success:function(d){c.find(".font-group-title").text(d.font_group.title),c.find(".font-group-description").text(d.font_group.description),c.find(".font-group-title").attr("data-empty",!d.font_group.title||""==d.font_group.title),c.find(".font-group-description").attr("data-empty",!d.font_group.description||""==d.font_group.description),b.$items.empty(),b.colors=d.colors,a.each(d.styles,function(c,e){var f=a(".mod-document").data("editing");e.specs=b.getSpecs(e),e.colors_data=d.colors,e.editable=f;var g=a(b.tpl.render("b-typostyles-item",e));b.$items.append(g),b.styles[e.id]=e,b.activeColors[e.id]=e.colors,a(".foreground > .color",g).first().trigger("click")})}}),c.on("click",".background > .color",function(){var c=a(this).data("id"),d=a(this).data("hex"),e=a(this).parents(".style-spec"),f=b.styles[e.data("id")].colors;e.find(".style-spec-preview").css("background",d),e.find(".meta-background > .value > span").text(d),e.find(".meta-background > .value > i").css("background",d),a(".background > .color,.foreground > .color",e).removeClass("clicked"),a(".background > .color",e).removeClass("selected"),a(this).addClass("selected clicked"),a(this).removeClass("disabled"),a(".foreground > .color",e).addClass("disabled");var g=null;f&&a.each(f.background[c],function(b,c){a('.foreground > .color[data-id="'+c+'"]',e).removeClass("disabled"),g||(g=c)});var h=a(".foreground > .color.selected",e);if(0==h.length||h.hasClass("disabled")){h.removeClass("selected");var i=a(".foreground > .color:not(.disabled)",e).first();i.addClass("selected"),e.find(".preview").css("color",i.data("hex")),e.find(".meta-color > .value > span").text(i.data("hex")),e.find(".meta-color > .value > i").css("background",i.data("hex"))}}),c.on("click",".foreground > .color",function(){var c=a(this).data("id"),d=a(this).data("hex"),e=a(this).parents(".style-spec"),f=b.styles[e.data("id")].colors;e.find(".preview").css("color",d),e.find(".meta-color > .value > span").text(d),e.find(".meta-color > .value > i").css("background",d),a(".background > .color,.foreground > .color",e).removeClass("clicked"),a(".foreground > .color",e).removeClass("selected"),a(this).addClass("selected clicked"),a(this).removeClass("disabled"),a(".background > .color",e).addClass("disabled");var g=null;f&&(f.foreground[c].length>0&&!f.foreground[c][0]&&a(".background > .color",e).removeClass("disabled"),a.each(f.foreground[c],function(b,c){a('.background > .color[data-id="'+c+'"]',e).removeClass("disabled"),g||(g=c)}));var h=a(".background > .color.selected",e);if(0==h.length||h.hasClass("disabled")){h.removeClass("selected");var i=a(".background > .color:not(.disabled)",e).first();i.addClass("selected"),e.find(".style-spec-preview").css("background",i.data("hex")),e.find(".meta-background > .value > span").text(i.data("hex")),e.find(".meta-background > .value > i").css("background",i.data("hex"))}}),c.on("click",".btn-foreground-color-add .color",function(){var c=a(this),d=c.data("id"),e=c.parents(".style-spec"),f=e.data("id"),g=!1,h=null;if(a(this).closest(".row.foreground").children('.color[data-id="'+a(this).data("id")+'"]').length>0&&(g=!0),!g){b.styles[f].colors||(b.styles[f].colors={background:[],foreground:[]});var i=a(".background > .color.selected",e);if(i.length>0)h=i.data("id"),b.styles[f].colors.background[h].push(d),b.styles[f].colors.foreground[d]=[h];else{var j=a(".background > .color",e);h=[],b.styles[f].colors.foreground[d]=[],a.each(j,function(c,e){h.push(a(e).data("id")),b.styles[f].colors.background[a(e).data("id")].push(d),b.styles[f].colors.foreground[d].push(a(e).data("id"))})}var k=a(this).clone();a(".foreground > .color.selected",e).removeClass("selected"),k.addClass("selected"),a(this).parents(".btn-color-add").before(k),e.find(".preview").css("color",k.data("hex")),e.find(".meta-color > .value").text(k.data("hex"))}var l="/api/typography/color/"+f,m={background_color_id:h,foreground_color_id:d};a.ajax({url:l,type:g?"DELETE":"POST",data:JSON.stringify(m),success:function(a){if(g){c.removeClass("selected"),c.closest(".row.foreground").children('.color[data-id="'+c.data("id")+'"]').remove();var d={background:c.closest(".style-spec-colors").find(".row.background").children(".color").length,foreground:c.closest(".style-spec-colors").find(".row.foreground").children(".color").length};delete b.activeColors[f].foreground[c.data("id")],1==d.background&&0==d.foreground&&c.closest(".style-spec-colors").find(".row.background").children(".color").remove()}else c.addClass("selected"),"undefined"==typeof b.activeColors[f]&&(b.activeColors[f]={background:{},foreground:{}}),b.activeColors[f].foreground[c.data("id")]=[]}})}),c.on("click",".btn-background-color-add .color",function(){var c=a(this).data("id"),d=a(this),e=d.parents(".style-spec"),f=e.data("id"),g=!1,h=null;if(d.closest(".row.background").children('.color[data-id="'+d.data("id")+'"]').length>0&&(g=!0),!g){b.styles[f].colors||(b.styles[f].colors={background:[],foreground:[]});var i=a(".foreground > .color.selected",e);if(i.length>0)h=i.data("id"),b.styles[f].colors.foreground[h].push(c),b.styles[f].colors.background[c]=[h];else{var j=a(".foreground > .color",e);h=[],b.styles[f].colors.background[c]=[],a.each(j,function(d,e){h.push(a(e).data("id")),b.styles[f].colors.foreground[a(e).data("id")].push(c),b.styles[f].colors.background[c].push(a(e).data("id"))})}var k=a(this).clone();a(".background > .color.selected",e).removeClass("selected"),k.addClass("selected"),a(this).parents(".btn-color-add").before(k),e.find(".style-spec-preview").css("background",k.data("hex")),e.find(".meta-background > .value").text(k.data("hex"))}var l="/api/typography/color/"+f,m={background_color_id:c,foreground_color_id:h};a.ajax({url:l,type:g?"DELETE":"POST",data:JSON.stringify(m),success:function(a){if(g){d.removeClass("selected"),d.closest(".row.background").children('.color[data-id="'+d.data("id")+'"]').remove();var c={background:d.closest(".style-spec-colors").find(".row.background").children(".color").length,foreground:d.closest(".style-spec-colors").find(".row.foreground").children(".color").length};delete b.activeColors[f].background[d.data("id")],1==c.foreground&&0==c.background&&d.closest(".style-spec-colors").find(".row.foreground").children(".color").remove()}else d.addClass("selected"),"undefined"==typeof b.activeColors[f]&&(b.activeColors[f]={background:{},foreground:{}}),b.activeColors[f].background[d.data("id")]=[]}})}),c.on("click",".btn-color-add",function(){var e=a(this),f=e.parents(".style-spec"),g=e.closest(".style-spec").data("id"),h=e.closest(".row").hasClass("foreground")?"foreground":"background";b.loadTooltipData(d,function(d){b.activeColors[g]&&a.each(d.palettes,function(c,d){d.colors&&a.each(d.colors,function(c,d){a.each(b.activeColors[g][h],function(a,b){a==d.id&&(d.active=!0)})})}),0==d.palettes.length&&(d.empty=!0),b.$chooser=a(b.tpl.render("b-typostyles-tooltip",d)),a(".color-chooser",c).hide(),e.append(b.$chooser.clone());var i=a(".color-chooser",e);if(e.hasClass("btn-background-color-add")){i.find(".what").text(i.data("txt-background")),i.find(".for").text(i.data("txt-text-color"));var j=a(".foreground > .color.selected",f);j.length>0?i.find("i").css("background",j.data("hex")):i.find(".for").text(i.data("txt-text-color-all"))}else{i.find(".what").text(i.data("txt-text")),i.find(".for").text(i.data("txt-text-bg-color"));var j=a(".background > .color.selected",f);j.length>0?i.find("i").css("background",j.data("hex")):i.find(".for").text(i.data("txt-text-bg-color-all"))}b.open=!0})}),c.on("click mousedown",".tooltip",function(a){return a.stopPropagation(),!1})},onEnableEditing:function(b){var c=this,d=this.$ctx;if(c.sortable)c.sortable.option("disabled",!1);else if(a("body").data("editor")){var e=d.find('[data-sortable="true"]');a.each(e,function(a,b){c.enableSorting(b)})}},onDisableEditing:function(a){var b=this;this.$ctx;b.sortable&&b.sortable.option("disabled",!0)},loadTooltipData:function(b,c){var d=(this.$ctx,"/api/color/library/"+b);a.ajax({url:d,success:function(a){c(a)}})},getSpecs:function(b){var c=a(".mod-document").data("editing");return this.specs.map(function(d){var e=null;switch(d.field){case"family":e=a.extend(!0,d,{value:b.family});break;case"size":e=a.extend(!0,d,{value:parseFloat(b.size)+""+(b.size_unit||"")});break;case"line_height":b.line_height&&"0"!=b.line_height&&(e=a.extend(!0,d,{value:parseFloat(b.line_height)+""+(b.line_height_unit||"")}));break;case"weight":b.weight&&"normal"!==a.trim(b.weight)&&(e=a.extend(!0,d,{value:b.weight}));break;case"style":b.style&&"normal"!==b.style&&(e=a.extend(!0,d,{value:b.style}));break;case"transform":b.transform&&"none"!==b.transform&&(e=a.extend(!0,d,{value:b.transform.toLowerCase()}));break;case"spacing":b.spacing&&"none"!==b.spacing&&"0"!=b.spacing&&(e=a.extend(!0,d,{value:parseFloat(b.spacing)+""+(b.spacing_unit||"")}));break;case"padding":b.padding&&"0"!=b.padding&&(e=a.extend(!0,d,{value:b.padding}));break;case"decoration":b.decoration&&"none"!==b.decoration&&(e=a.extend(!0,d,{value:b.decoration}));break;case"border":b.border&&(e=a.extend(!0,d,{value:b.border}))}return e&&(e.editable=c),e})},saveSpecs:function(b){var c=b.data("id"),d={id:c,level:"project"};b.find(".spec").each(function(b,c){var e=a(c),f=e.data("field");f?(e.removeClass("state-error"),d[f]=e.find(".value").text()):e.addClass("state-error")}.bind(this)),this.specs.forEach(function(a){d[a.field]||(d[a.field]=null)}),this.data.post("/api/typography/update/"+c,d).then(function(a){if(a.success){var c=b.find(".preview"),d=this.getSpecs(a.font),e={};d.forEach(function(a){a&&(e[a.prop]=a.value)}),e.color=c.css("color"),e.background=c.css("background-color"),c.attr("style","").css(e)}else console.error("typography spec update failed")}.bind(this))}})}(Tc.$),function(a){Tc.Module.BlockVideo=Tc.Module.extend({on:function(b){var c=this.$ctx;this.tpl=this.sandbox.getConfigParam("tpl"),this.data=this.sandbox.getConfigParam("data"),this.$loader=a(this.tpl.render("progress",{id:this.id})),this.sandbox.addModules(this.$loader),this.sandbox.subscribe("events",this),this.replace=!1,this.isTranslator=a("body").data("translation-language")&&"1"==a("body").data("translator"),c.on("click",".js-b-video__settings",function(b){var d=a(b.currentTarget);if(d.hasClass("state-open"))d.closest(".js-b-video__actions").removeClass("state-open");else{d.closest(".js-b-video__actions").addClass("state-open");var e=c.data("block"),f=d.next(".js-cm-btn-dropdown__menu");f.html(this.tpl.render("c-loader")),this.data.get("/api/document/block/"+e).then(function(a){a.data.translator_only=this.isTranslator,f.html(this.tpl.render("b-video-settings",a.data)),this.settings=new Tc.Module.CSettings(f.find(".js-b-video__settings-overlay"),this.sandbox);var b=this.settings.getSetting("autoplay");b.saved=function(a){this.data.updateBlock(c,{settings:{autoplay:a.autoplay}})}.bind(this);var d=this.settings.getSetting("loop");d.saved=function(a){var b=c.find(".js-b-video__video");a.loop?b.attr("loop","loop"):b.removeAttr("loop"),this.data.updateBlock(c,{settings:{loop:a.loop}})}.bind(this);var e=this.settings.getSetting("width");e.saved=function(a){var b=c.find(".js-b-video__video");b.attr("width",a.width),this.data.updateBlock(c,{settings:{width:a.width}})}.bind(this)}.bind(this))}}.bind(this)),c.on("click",".js-b-video__replace",function(b){this.replace=!0,a(".js-m-dropzone__upload",c).trigger("click")}.bind(this)),c.on("click",".js-b-video__upload",function(b){a(".js-m-dropzone__upload",c).trigger("click")}.bind(this)),b()},after:function(){var b=this.$ctx,c=["avi","mp4","flv","wmv","mov","mkv"];a(".js-m-dropzone__upload",b).fileupload({dataType:"json",dropZone:a(".js-m-dropzone",b),add:function(d,e){var f=e.files[0].name.split(".").pop();a.inArray(f,c)>-1||e.files[0].type.indexOf("video")>-1?e.submit():(this.displayError(b.data("txt-processing-error-title"),b.data("txt-processing-error-description")),b.find(".js-m-dropzone span").text(b.data("txt-placeholder")));var g=Math.round(e.files[0].size/1024,0);this.data.checkStorageLimit(g).then(function(){e.submit()})}.bind(this),start:function(){var c=a(".js-m-dropzone",b);c.find(".icon-film").replaceWith(this.$loader)}.bind(this),progress:function(a,b){var c=parseInt(b.loaded/b.total*100,10);this.fire("progress",{id:this.id,progress:c})}.bind(this),done:function(a,c){if(c.result&&c.result[0]){this.data.updateStorageUsage(!0);var d=c.result[0].id;this.data.updateBlock(b,{settings:{asset:c.result[0].id}}),b.find(".a-progress").hide(),b.find(".js-m-dropzone span").text(b.data("txt-processing"));var e=setInterval(function(){this.pollVideoConverter(d).then(function(a){a.video_mp4&&(clearInterval(e),a.block=b.data("block"),a.screen=d,b.find(".b-video__container").empty().html(this.tpl.render("b-video-item",a)))}.bind(this))}.bind(this),3e3)}}.bind(this)})},pollVideoConverter:function(a,b){var c="/api/screen/video/"+a;return this.replace&&(c+="?replace=true",this.replace=!1),this.data.get(c)},displayError:function(a,b){swal({title:a,text:b,type:"error",showCancelButton:!1,confirmButtonText:"OK",closeOnConfirm:!0},function(){})},getViewerInfo:function(b,c){var d=(this.$ctx,a.extend({},c));return d}})}(Tc.$);